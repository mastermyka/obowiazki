<!doctype html>
add: document.getElementById('addBtn'),
reset: document.getElementById('resetBtn'),
changeFamily: document.getElementById('changeFamilyBtn'),
familyLabel: document.getElementById('familyLabel'),
};

function saveLocal(){ const payload={tasks,updatedAt:Date.now()}; localStorage.setItem(stateKey, JSON.stringify(payload)); }
function loadLocal(){ try{ const raw=localStorage.getItem(stateKey); if(!raw) return; const parsed=JSON.parse(raw); if(parsed&&parsed.tasks) tasks=parsed.tasks; }catch(e){} }
function render(){
el.list.innerHTML='';
const empty = !tasks.length;
el.emptyBox.style.display = empty ? 'block' : 'none';
if (empty) return;
tasks.forEach((t, idx) => {
const li=document.createElement('li');
const left=document.createElement('div'); left.className='left';
const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!t.done; cb.addEventListener('change',()=>{t.done=cb.checked; saveLocal(); pushToFirebase(); render();});
const span=document.createElement('span'); span.textContent=t.text; if(t.done) span.style.textDecoration='line-through';
left.appendChild(cb); left.appendChild(span);
const right=document.createElement('div');
const del=document.createElement('button'); del.className='btn btn-ghost'; del.textContent='Usuń'; del.addEventListener('click',()=>{tasks.splice(idx,1); saveLocal(); pushToFirebase(); render();});
right.appendChild(del);
li.appendChild(left); li.appendChild(right);
el.list.appendChild(li);
});
}

// Dodawanie
el.add.addEventListener('click',()=>{ const txt=el.input.value.trim(); if(!txt) return; tasks.unshift({text:txt,done:false}); el.input.value=''; saveLocal(); pushToFirebase(); render(); });
el.input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') el.add.click(); });

// Zmiana rodziny
if (el.changeFamily) el.changeFamily.addEventListener('click',()=>{
const curr=localStorage.getItem('familyId')||'';
const next=prompt('ID rodziny (wspólna nazwa grupy):', curr);
if(!next) return;
localStorage.setItem('familyId', next);
el.familyLabel.textContent = next;
tryFirebaseInit(true); // przełącz subskrypcję
pushToFirebase();
});

// Reset przyciskiem
if (el.reset) el.reset.addEventListener('click',()=>{
if(!confirm('Wyczyścić dane i zapytać o rodzinę ponownie?')) return;
localStorage.removeItem('familyId');
localStorage.removeItem(stateKey);
location.href = location.pathname + '#reset';
location.reload();
});

// Firebase / Firestore
let db=null, unsub=null, familyId=null;
async function tryFirebaseInit(relisten=false){
const forceAsk = location.search.includes('forceFamily=1');
const cfg=(window&&window.firebaseConfig)||{}; if(!cfg.apiKey){ console.log('[Firebase] Brak configu — tryb lokalny.'); el.familyLabel.textContent='lokalnie'; return; }
if(!firebase.apps.length) firebase.initializeApp(cfg);
db=firebase.firestore();
familyId = forceAsk ? null : localStorage.getItem('familyId');
if(!familyId){
familyId = prompt('ID rodziny (np. rodzina-kowalscy) — wspólna dla wszystkich urządzeń:', 'rodzina-demo');
if(!familyId){ el.familyLabel.textContent='—'; return; }
localStorage.setItem('familyId', familyId);
}
el.familyLabel.textContent=familyId;

if (unsub) { unsub(); unsub=null; }
unsub = db.collection('organizer').doc(familyId).onSnapshot((doc)=>{
const data=doc.data(); if(!data||!data.payload) return;
try{
const cloud=JSON.parse(data.payload);
const local=JSON.parse(localStorage.getItem(stateKey)||'{}');
if(!local.updatedAt || (cloud.updatedAt && cloud.updatedAt>local.updatedAt)){
tasks = Array.isArray(cloud.tasks) ? cloud.tasks : [];
saveLocal(); render();
}
}catch(e){ console.warn('Snapshot parse error', e); }
}, (err)=>console.error('onSnapshot error', err));

if(!relisten) pushToFirebase();
}

let pushTimer=null;
function pushToFirebase(){
const fam=localStorage.getItem('familyId');
if(!db||!fam) return;
clearTimeout(pushTimer);
pushTimer=setTimeout(async()=>{
try{
const payload=JSON.stringify({tasks,updatedAt:Date.now()});
await db.collection('organizer').doc(fam).set({
payload,
updatedAt: firebase.firestore.FieldValue.serverTimestamp()
}, {merge:true});
}catch(e){ console.error('pushToFirebase error', e); }
}, 250);
}

// Start
loadLocal(); render();
tryFirebaseInit();

// Service Worker (awaryjnie wyłącz: ?nosw=1)
const skipSW = location.search.includes('nosw=1');
if ('serviceWorker' in navigator && !skipSW) {
window.addEventListener('load', ()=>{
navigator.serviceWorker.register('./sw.js').catch(console.error);
});
}
</script>
</body>
</html>
