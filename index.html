<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domowe obowiÄ…zki (PRO 3+) â€“ z wydatkami</title>

<!-- PWA -->
<meta name="theme-color" content="#0a84ff"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<!-- Tailwind + Inter (tylko wyglÄ…d) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<script>window.process = window.process || { env: {} };</script>

<!-- Firebase compat (prawidÅ‚owa kolejnoÅ›Ä‡) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
/* --- [CAÅY TWÃ“J ORYGINALNY CSS 1:1 â€“ BEZ ZMIAN] --- */
/* (wklej dokÅ‚adnie to co masz â€“ tu skracam, bo nie zmieniamy nic w stylach) */
</style>
</head>
<body>
<div id="splash"><div class="logo">ğŸ§¹</div></div>
<script>
  setTimeout(function(){ var s=document.getElementById('splash'); if(s) s.remove(); }, 2000);
</script>

<div class="wrap">
  <header>
    <div class="title"><span class="dot"></span> Domowy organizer â€” PRO 3+</div>
    <div>
      <div class="subtitle" id="today"></div>
      <div class="subtitle">Rodzina: <strong id="familyLabel">â€”</strong></div>
    </div>
    <div class="row">
      <div class="top-tabs">
        <button id="tabChores" class="tab active">ğŸ§º ObowiÄ…zki</button>
        <button id="tabShopping" class="tab">ğŸ›’ Zakupy</button>
        <button id="tabExpenses" class="tab">ğŸ’¸ Wydatki</button>
      </div>
      <button id="themeToggle" class="btn" title="Jasny / ciemny">â˜€ï¸ / ğŸŒ™</button>
    </div>
  </header>

  <!-- ====== WIDOK: OBOWIÄ„ZKI ====== -->
  <div id="view-chores">
    <!-- [TWÃ“J ORYGINALNY WIDOK â€“ BEZ ZMIAN] -->
  </div>

  <!-- ====== WIDOK: ZAKUPY ====== -->
  <div id="view-shopping" style="display:none">
    <!-- [TWÃ“J ORYGINALNY WIDOK â€“ BEZ ZMIAN] -->
  </div>

  <!-- ====== WIDOK: WYDATKI ====== -->
  <div id="view-expenses" style="display:none">
    <section class="card">
      <h3 style="margin:0 0 10px 0">Dodaj wydatek</h3>
      <div class="row" style="flex-direction:column;gap:10px;width:100%">
        <div class="row" style="width:100%">
          <input id="expTitle" type="text" placeholder="np. Rachunek za prÄ…d"/>
          <input id="expAmount" type="number" step="0.01" min="0" placeholder="kwota" style="width:160px"/>
        </div>
        <div class="row" style="width:100%">
          <select id="expSection" style="flex:1"></select>
          <input id="expDate" type="date" style="width:180px"/>
          <button id="expAddBtn" class="btn">â• Dodaj</button>
        </div>
      </div>
    </section>

    <div style="height:10px"></div>

    <section class="card">
      <div class="exp-head">
        <h3 style="margin:0">Podsumowania</h3>
        <div class="muted" id="expMonthLabel">â€”</div>
      </div>

      <!-- â¬‡â¬‡â¬‡ JEDYNY DODANY FRAGMENT W HTML: belka wyboru miesiÄ…ca/roku â¬‡â¬‡â¬‡ -->
      <div class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0 4px 0">
        <button id="expPrevMonth" class="btn" title="Poprzedni miesiÄ…c">âŸ¨</button>
        <select id="expFilterMonth" style="min-width:160px">
          <option value="0">styczeÅ„</option><option value="1">luty</option><option value="2">marzec</option>
          <option value="3">kwiecieÅ„</option><option value="4">maj</option><option value="5">czerwiec</option>
          <option value="6">lipiec</option><option value="7">sierpieÅ„</option><option value="8">wrzesieÅ„</option>
          <option value="9">paÅºdziernik</option><option value="10">listopad</option><option value="11">grudzieÅ„</option>
        </select>
        <select id="expFilterYear" style="min-width:120px"></select>
        <button id="expNextMonth" class="btn" title="NastÄ™pny miesiÄ…c">âŸ©</button>
        <button id="expTodayBtn" class="btn" title="Skocz do bieÅ¼Ä…cego miesiÄ…ca">DziÅ›</button>
      </div>
      <!-- â¬†â¬†â¬† KONIEC JEDYNEGO DODANEGO FRAGMENTU W HTML â¬†â¬†â¬† -->

      <div class="row" style="gap:12px; align-items:flex-start; flex-wrap:wrap">
        <div class="exp-section" style="flex:1 1 260px">
          <div class="exp-head"><div>Ten miesiÄ…c â€” razem</div><div class="exp-total" id="expMonthTotal">0,00 zÅ‚</div></div>
          <table class="table" style="margin-top:8px">
            <thead><tr><th>Kategoria</th><th>Kwota</th></tr></thead>
            <tbody id="expMonthByCat"></tbody>
          </table>
        </div>
        <div class="exp-section" style="flex:2 1 420px">
          <div class="exp-head"><div>Wszystkie wydatki (ostatnie 60 dni)</div><div></div></div>
          <div id="expList"></div>
        </div>
      </div>
    </section>

    <div style="height:10px"></div>

    <section class="card">
      <h3 style="margin:0 0 10px 0">Kategorie wydatkÃ³w</h3>
      <div class="row">
        <select id="expCatsSelect" style="flex:1"></select>
        <input id="expNewCat" type="text" placeholder="Nowa kategoria" style="flex:1"/>
        <button id="expAddCatBtn" class="btn">â•</button>
        <button id="expDelCatBtn" class="btn" title="UsuÅ„ wybranÄ…">ğŸ—‘ï¸</button>
      </div>
    </section>
  </div><!-- /view-expenses -->
</div><!-- /wrap -->

<div id="overlay" class="overlay"><div id="dialog" class="dialog"></div></div>

<!-- OTWARCIE GÅÃ“WNEGO SKRYPTU â€“ NIE ZAMYKAMY TUTAJ -->
<script>
/* --- [TWÃ“J ORYGINALNY KOD JS OD POCZÄ„TKU AÅ» DO FUNKCJI WYDATKÃ“W â€“ BEZ ZMIAN] --- */
/* ====== WYDANE â€” DODANE STAÅE I POMOCNICZE (zapamiÄ™tywanie wyboru) ====== */
const EXP_MONTH_KEY = 'exp-view-month'; // 0..11
const EXP_YEAR_KEY  = 'exp-view-year';  // yyyy

function getExpSelectedMonthYear(){
  const now = new Date();
  const m = parseInt(localStorage.getItem(EXP_MONTH_KEY) ?? now.getMonth(), 10);
  const y = parseInt(localStorage.getItem(EXP_YEAR_KEY)  ?? now.getFullYear(), 10);
  return { month: isNaN(m)?now.getMonth():Math.min(11,Math.max(0,m)), year: isNaN(y)?now.getFullYear():y };
}
function setExpSelectedMonthYear(month, year){
  localStorage.setItem(EXP_MONTH_KEY, String(Math.min(11,Math.max(0,month))));
  localStorage.setItem(EXP_YEAR_KEY,  String(year));
}
function expTargetDate(){
  const {month,year}=getExpSelectedMonthYear();
  return new Date(year, month, 1, 12, 0, 0, 0);
}
function expShiftMonth(delta){
  const {month,year}=getExpSelectedMonthYear();
  const d=new Date(year,month,1); d.setMonth(d.getMonth()+delta);
  setExpSelectedMonthYear(d.getMonth(), d.getFullYear());
}
function expYearsRange(){
  const years=new Set();
  (db.expenses||[]).forEach(e=>{ const d=new Date(e.date); if(!isNaN(d)) years.add(d.getFullYear()); });
  if(!years.size){ const y=new Date().getFullYear(); for(let i=y-5;i<=y+5;i++) years.add(i); }
  return Array.from(years).sort((a,b)=>a-b);
}
function expMonthLabel(d){ return d.toLocaleDateString('pl-PL',{month:'long',year:'numeric'}); }

/* ===== [TWÃ“J ORYGINALNY KOD] =====
   poniÅ¼ej sÄ… TYLKO modyfikacje w istniejÄ…cych funkcjach dotyczÄ…cych WYDATKÃ“W.
   CaÅ‚a reszta pliku pozostaÅ‚a bez zmian. */

/* --- PODMIANA: renderExpenseSelectors (dopina dropdown roku i ustawia wybrane M/Y) --- */
function renderExpenseSelectors(){
  $('#expSection').innerHTML = (db.expenseSections||defaultExpenseSections).map(s=>`<option value="${s}">${s}</option>`).join('');
  $('#expCatsSelect').innerHTML = (db.expenseSections||defaultExpenseSections).map(s=>`<option value="${s}">${s}</option>`).join('');
  const d = $('#expDate'); if(d && !d.value){ d.value = nowYMD(); }

  const monthSel = document.getElementById('expFilterMonth');
  const yearSel  = document.getElementById('expFilterYear');
  if (yearSel && !yearSel.options.length) {
    const ys = expYearsRange();
    yearSel.innerHTML = ys.map(y=>`<option value="${y}">${y}</option>`).join('');
  }
  const {month, year} = getExpSelectedMonthYear();
  if (monthSel) monthSel.value = String(month);
  if (yearSel)  yearSel.value  = String(year);
}

/* --- PODMIANA: renderExpenses (liczy dla wybranego miesiÄ…ca/roku) --- */
function sum(arr, sel=()=>true, map=v=>v){ return arr.filter(sel).reduce((a,x)=>a+map(x),0); }
function money(n){ return (n||0).toLocaleString('pl-PL',{style:'currency',currency:'PLN'}); }
function isSameMonth(d1,d2){ const a=new Date(d1), b=new Date(d2); return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }

function renderExpenses(){
  renderExpenseSelectors();
  const hostList = $('#expList');
  const tbody = $('#expMonthByCat');
  const monthLabel = $('#expMonthLabel');
  hostList.innerHTML=''; tbody.innerHTML='';

  const target = expTargetDate();                                // â¬… uÅ¼ywamy wyboru M/Y
  const thisMonth = (db.expenses||[]).filter(e=>isSameMonth(e.date, target));
  const monthTotal = sum(thisMonth, ()=>true, e=>e.amount);
  $('#expMonthTotal').textContent = money(monthTotal);
  monthLabel.textContent = expMonthLabel(target);

  // Lista wszystkich (ostatnie 60 dni) â€“ bez zmian
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-60);
  const recent = (db.expenses||[]).filter(e=> new Date(e.date) >= cutoff)
                                  .sort((a,b)=> (a.section||'').localeCompare(b.section||'','pl') || (b.date||'').localeCompare(a.date||''));
  const grouped = recent.reduce((acc,x)=>((acc[x.section||'Inne']=acc[x.section||'Inne']||[]).push(x),acc),{});
  Object.keys(grouped).sort((a,b)=>a.localeCompare(b,'pl')).forEach(sec=>{
    const box=document.createElement('div'); box.className='exp-section';
    const total = sum(grouped[sec], ()=>true, e=>e.amount);
    const head=document.createElement('div'); head.className='exp-head';
    head.innerHTML=`<div><b>${sec}</b></div><div class="exp-total">${money(total)}</div>`;
    box.appendChild(head);

    grouped[sec].forEach(e=>{
      const row=document.createElement('div'); row.className='shop-item';
      const meta=`<small class="muted">${e.date} â€¢ ${e.section}</small>`;
      row.innerHTML=`<div style="flex:1"><b>${e.title}</b><br>${meta}</div><div style="min-width:100px;text-align:right"><b>${money(e.amount)}</b></div>`;
      const del=document.createElement('button'); del.className='btn'; del.textContent='ğŸ—‘ï¸'; del.onclick=()=>delExpense(e.id);
      row.appendChild(del);
      box.appendChild(row);
    });

    hostList.appendChild(box);
  });
}

/* --- DOPIÄ˜CIE: bindowanie kontrolek miesiÄ…c/rok w tabsInit (na koÅ„cu Twojej IIFE tabsInit) --- */
(function(){
  const mSel = document.getElementById('expFilterMonth');
  const ySel = document.getElementById('expFilterYear');
  const prevBtn = document.getElementById('expPrevMonth');
  const nextBtn = document.getElementById('expNextMonth');
  const todayBtn = document.getElementById('expTodayBtn');

  function applyExpFilterFromUI(){
    const m = parseInt(mSel.value, 10);
    const y = parseInt(ySel.value, 10);
    if(!isNaN(m) && !isNaN(y)){
      setExpSelectedMonthYear(m, y);
      renderExpenses();
    }
  }
  if (mSel)   mSel.onchange = applyExpFilterFromUI;
  if (ySel)   ySel.onchange = applyExpFilterFromUI;
  if (prevBtn) prevBtn.onclick = ()=>{ expShiftMonth(-1); renderExpenseSelectors(); renderExpenses(); };
  if (nextBtn) nextBtn.onclick = ()=>{ expShiftMonth(1);  renderExpenseSelectors(); renderExpenses(); };
  if (todayBtn) todayBtn.onclick = ()=>{
    const now = new Date();
    setExpSelectedMonthYear(now.getMonth(), now.getFullYear());
    renderExpenseSelectors(); renderExpenses();
  };
})();

/* --- INIT pozostaje bez zmian; nic nie dotykamy w Firebase ani familyId --- */
/* --- KONIEC GÅÃ“WNEGO SKRYPTU --- */
</script>
</body>
</html>
