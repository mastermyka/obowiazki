<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domowe obowiƒÖzki (PRO 3+) ‚Äì z wydatkami</title>

<!-- PWA -->
<meta name="theme-color" content="#0a84ff"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<!-- Tailwind + Inter (tylko wyglƒÖd) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>



<script>window.process = window.process || { env: {} };</script>

<!-- Firebase compat (prawid≈Çowa kolejno≈õƒá) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
:root{
  --bg:#0b1220; --card:rgba(17,24,39,.72); --border:rgba(255,255,255,.08);
  --muted:#8aa0b8; --text:#eaf2ff; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji";color:var(--text);background:radial-gradient(1200px 800px at 20% -10%,#1b1d20 0%,#0f1113 60%)}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:800;font-size:1.25rem;display:flex;gap:10px;align-items:center;letter-spacing:.2px}
.dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 14px var(--ok)}
.subtitle{opacity:.85;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);backdrop-filter:saturate(140%) blur(10px);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button,.btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s ease, box-shadow .18s ease, border-color .18s}
button:hover,.btn:hover{box-shadow:0 14px 30px -12px rgba(10,132,255,.45);border-color:rgba(99,102,241,.35)}
button:active{transform:translateY(1px)}
input[type=text],input[type=number],input[type=time],input[type=date],input[type=password],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);transition:border-color .2s, box-shadow .2s}
input[type=text]:focus, input[type=number]:focus, input[type=time]:focus, input[type=date]:focus, input[type=password]:focus, select:focus{border-color:#8da2fb;box-shadow:0 0 0 4px rgba(99,102,241,.18)}
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.task{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
.task:hover{border-color:rgba(99,102,241,.35);box-shadow:0 10px 28px -14px rgba(10,132,255,.35)}
.task.done{opacity:.55}
.task label{flex:1}
.task small{opacity:.9;color:var(--muted)}
.task .actions{display:flex;gap:8px}
.muted{color:var(--muted)}
.progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,var(--accent),#34d399);width:0%}
.score{font-weight:700}
.subtasks{margin:6px 0 0 26px;display:flex;flex-direction:column;gap:6px}
.subAdd{margin-left:26px}
.week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{min-height:120px;border:1px dashed var(--border);border-radius:12px;padding:8px}
.day h4{margin:0 0 6px 0;font-size:.95rem;color:var(--muted)}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);font-size:.85rem;margin:2px 0;cursor:grab}
.statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:980px){.statsGrid{grid-template-columns:1fr}}
canvas{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px}
.shopItem{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:rgba(255,255,255,.03)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
.dialog{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;width:min(520px,92vw)}
.zoneTag{border:1px solid var(--border);background:rgba(255,255,255,.06);border-radius:999px;padding:4px 10px}
h3{font-weight:700}
.card h3{display:flex;align-items:center;gap:8px}
table#leaderboard th, table#leaderboard td{border-bottom:1px solid var(--border)}
html, body { width:100%; max-width:100%; overflow-x:hidden; }
.wrap, .card, .row, .grid, .week, .statsGrid { min-width:0; }
.btn { white-space:nowrap; }
table#leaderboard { display:block; width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
.pill { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
@media (max-width: 640px) {
  .week { grid-template-columns: 1fr 1fr; }
  .day  { min-height: 96px; }
  #taskTime { width: 110px !important; }
}
  /* Override: na mobile tydzie≈Ñ przewijany poziomo */
@media (max-width: 640px){
  #weekGrid{
    overflow-x:auto;                  /* w≈Çasny h-scroll wewnƒÖtrz sekcji */
    -webkit-overflow-scrolling:touch;
    display:grid;
    grid-auto-flow:column;            /* kolumny p≈ÇynƒÖ w bok */
    grid-auto-columns:minmax(240px,1fr);
    gap:8px;
    padding-bottom:6px;               /* ≈ºeby nie zas≈Çania≈Ç pasek przewijania */
  }
  #weekGrid .day{ min-width:240px; }  /* pewna szeroko≈õƒá ka≈ºdej kolumny */
}

:root.light{
  --bg:#e6f0ff; --card:#f3f7ff; --border:#c5d4f7; --muted:#4b5b77; --text:#0b1220;
  --accent:#2563eb; --ok:#059669; --warn:#d97706; --danger:#dc2626;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}
:root.light body{color:var(--text);background:radial-gradient(1400px 900px at 20% -10%,#eef2ff 0%,#f8fafc 60%)}
.task .editable { cursor:text; border-radius:8px; padding:2px 4px; }
.task .editable:focus { outline:2px solid rgba(99,102,241,.35); background:rgba(255,255,255,.06); }
@media (max-width: 640px){
  #zonesSelect{ flex: 1 1 100% !important; min-width: 100%; order: -1; margin-bottom: 8px; }
  #newZone{ flex: 1 1 100%; min-width: 100%; }
}
@media (max-width: 640px){
  #taskZone{ display:block; flex: 1 1 100% !important; min-width:100%; margin-bottom:8px; }
}
.week .pill{ display:block; box-sizing:border-box; max-width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.day .drop{
  overflow:auto;                 /* pozw√≥l przewijaƒá listƒô pigu≈Çek */
  max-height:260px;              /* ≈ºeby nie rozpycha≈Ço karty w niesko≈Ñczono≈õƒá */
  -webkit-overflow-scrolling:touch;
  padding-right:4px;
}


/* Splash overlay */
#splash { position: fixed; inset: 0; z-index: 9999; display:flex; align-items:center; justify-content:center; background: var(--bg, #0f1113); }
#splash .logo { width: 120px; height: 120px; border-radius: 24px; display:flex; align-items:center; justify-content:center; font-size: 56px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.08); box-shadow: 0 8px 30px rgba(0,0,0,.35); }

/* Tabs g√≥rne */
.top-tabs { display:flex; gap:8px; flex-wrap:wrap; }
.top-tabs .tab { padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); cursor:pointer; }
.top-tabs .tab.active { background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.06)); border-color:rgba(99,102,241,.35); }

/* Zakupy */
.shop-grid { display:grid; grid-template-columns:1fr; gap:12px; }
.shop-item { display:flex; gap:8px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.03) }
.shop-badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); font-size:.8rem; }
.shop-done { opacity:.55; text-decoration: line-through; }

/* Przyciski kategorii w zakupach */
.cat-chips { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
.cat-chips .chip { padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.06); cursor:pointer; }
.cat-chips .chip.active { border-color:rgba(99,102,241,.35); }

/* Wydatki */
.exp-grid { display:grid; grid-template-columns:1fr; gap:12px; }
.exp-section { border:1px solid var(--border); border-radius:12px; padding:10px; background:rgba(255,255,255,.03) }
.exp-head { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.exp-total { font-weight:700; }
.table { width:100%; border-collapse:collapse; }
.table th, .table td { border-bottom:1px solid var(--border); padding:6px; text-align:left; }
/* === Sekcyjne akcenty ‚Äî fallback do globalnego --accent === */
:root{
  --accent-chores: var(--accent);   /* üß∫ ObowiƒÖzki */
  --accent-shopping: #22c55e;       /* üõí Zakupy */
  --accent-expenses: #f59e0b;       /* üí∏ Wydatki */
}
:root.light{
  --accent-chores: var(--accent);
  --accent-shopping: #16a34a;
  --accent-expenses: #d97706;
}

/* === Aktywna zak≈Çadka ‚Äî kolor wg sekcji === */
.top-tabs .tab[data-kind="chores"].active{
  border-color: color-mix(in oklab, var(--accent-chores) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-chores) 55%, transparent);
  background: linear-gradient(180deg, color-mix(in oklab, #fff 10%, transparent), rgba(255,255,255,.06));
}
.top-tabs .tab[data-kind="shopping"].active{
  border-color: color-mix(in oklab, var(--accent-shopping) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-shopping) 55%, transparent);
  background: linear-gradient(180deg, color-mix(in oklab, #fff 10%, transparent), rgba(255,255,255,.06));
}
.top-tabs .tab[data-kind="expenses"].active{
  border-color: color-mix(in oklab, var(--accent-expenses) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-expenses) 55%, transparent);
  background: linear-gradient(180deg, color-mix(in oklab, #fff 10%, transparent), rgba(255,255,255,.06));
}

/* === Scope: ‚Äûmikro-branding‚Äù wewnƒÖtrz widoku === */
#view-chores .btn:hover{
  border-color: color-mix(in oklab, var(--accent-chores) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-chores) 45%, transparent);
}
#view-chores input:focus, #view-chores select:focus{
  border-color: var(--accent-chores);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-chores) 28%, transparent);
}

#view-shopping .btn:hover{
  border-color: color-mix(in oklab, var(--accent-shopping) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-shopping) 45%, transparent);
}
#view-shopping input:focus, #view-shopping select:focus{
  border-color: var(--accent-shopping);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-shopping) 28%, transparent);
}

#view-expenses .btn:hover{
  border-color: color-mix(in oklab, var(--accent-expenses) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-expenses) 45%, transparent);
}
#view-expenses input:focus, #view-expenses select:focus{
  border-color: var(--accent-expenses);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-expenses) 28%, transparent);
}

/* === (Opcjonalnie) globalny akcent wg widoku ‚Äî nie nadpisuje sekcyjnych, ale wp≈Çywa na inne elementy, kt√≥re u≈ºywajƒÖ --accent */
:root[data-view="shopping"] { --accent: var(--accent-shopping); }
:root[data-view="expenses"] { --accent: var(--accent-expenses); }
/* ObowiƒÖzki = domy≈õlny --accent */

/* ===========================
   Sekcyjne akcenty + motywy
   (bez ruszania istniejƒÖcego CSS)
   =========================== */

/* 1) Domy≈õlne akcenty sekcji (fallback do --accent) */
:root{
  --accent-chores: var(--accent);   /* ObowiƒÖzki */
  --accent-shopping: #22c55e;       /* Zakupy */
  --accent-expenses: #f59e0b;       /* Wydatki */
}
:root.light{
  --accent-chores: var(--accent);
  --accent-shopping: #16a34a;
  --accent-expenses: #d97706;
}

/* 2) Podmie≈Ñ globalny --accent zale≈ºnie od aktywnego widoku (ustawiamy data-view w JS) */
:root[data-view="shopping"]{ --accent: var(--accent-shopping); }
:root[data-view="expenses"]{ --accent: var(--accent-expenses); }
/* :root[data-view="chores"] -> zostaje bazowy --accent */

/* 3) Styl aktywnej zak≈Çadki (u≈ºywa Twojej istniejƒÖcej struktury .top-tabs .tab) */
.top-tabs{ gap:8px; flex-wrap:wrap; }
.top-tabs .tab{
  transition: box-shadow .18s ease, border-color .18s, background .18s, transform .06s;
}
.top-tabs .tab.active{
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  border-color: color-mix(in oklab, var(--accent) 38%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent) 60%, transparent);
}

/* 4) Akcent w obrƒôbie widok√≥w (hover/focus bez ruszania logiki) */
#view-chores .btn:hover,
#view-chores .task:hover{
  border-color: color-mix(in oklab, var(--accent-chores) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-chores) 45%, transparent);
}
#view-chores input:focus, #view-chores select:focus{
  border-color: var(--accent-chores);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-chores) 28%, transparent);
}

#view-shopping .btn:hover,
#view-shopping .shop-item:hover{
  border-color: color-mix(in oklab, var(--accent-shopping) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-shopping) 45%, transparent);
}
#view-shopping input:focus, #view-shopping select:focus{
  border-color: var(--accent-shopping);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-shopping) 28%, transparent);
}

#view-expenses .btn:hover,
#view-expenses .exp-section:hover{
  border-color: color-mix(in oklab, var(--accent-expenses) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-expenses) 45%, transparent);
}
#view-expenses input:focus, #view-expenses select:focus{
  border-color: var(--accent-expenses);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-expenses) 28%, transparent);
}

/* 5) Ulepszenia dostƒôpno≈õci i ‚Äûfeel‚Äù bez zmian HTML/JS */
.top-tabs{ align-items:center; }
.top-tabs[role="tablist"] .tab[role="tab"]{ outline-offset: 2px; }
.tab:focus-visible{
  outline: 2px solid var(--accent);
}

/* Wiƒôksze pola dotykowe dla mobile */
@media (max-width:640px){
  .top-tabs .tab{ padding:10px 14px; }
  .btn{ padding:12px 14px; }
}

/* 6) Przycisk stanu (secondary hover) ‚Äì delikatniejszy look */
.btn:hover{
  border-color: color-mix(in oklab, var(--accent) 30%, transparent);
}

/* 7) Scrollbar (widoczne w d≈Çugich listach) */
*::-webkit-scrollbar{ height:10px; width:10px; }
*::-webkit-scrollbar-thumb{
  background: color-mix(in oklab, var(--accent) 35%, rgba(255,255,255,.14));
  border-radius:999px;
  border:2px solid transparent;
  background-clip: padding-box;
}
*::-webkit-scrollbar-track{ background: transparent; }

/* 8) Tryb zredukowanego ruchu */
@media (prefers-reduced-motion: reduce){
  *{ transition:none!important; animation:none!important; }
}

/* 9) Motywy ‚Äì szybkie presety (mo≈ºesz prze≈ÇƒÖczaƒá klasƒÖ na <html>) */

/* Ocean */
.theme-ocean{
  --bg:#0b1220; --card:rgba(17,24,39,.72); --border:rgba(255,255,255,.08);
  --muted:#8aa0b8; --text:#eaf2ff; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
.theme-ocean.light{
  --bg:#e6f0ff; --card:#f3f7ff; --border:#c5d4f7; --muted:#4b5b77; --text:#0b1220;
  --accent:#2563eb; --ok:#059669; --warn:#d97706; --danger:#dc2626;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}

/* Forest */
.theme-forest{
  --bg:#0b1614; --card:rgba(13,40,33,.72); --border:rgba(255,255,255,.08);
  --muted:#85a19a; --text:#ebfffb; --accent:#14b8a6; --ok:#22c55e; --warn:#eab308; --danger:#f43f5e;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
.theme-forest.light{
  --bg:#e8fbf6; --card:#f3fffb; --border:#b9e6dc; --muted:#3d5b55; --text:#0b1614;
  --accent:#0d9488; --ok:#16a34a; --warn:#ca8a04; --danger:#e11d48;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}

/* Graphite (pro/AMOLED) */
.theme-graphite{
  --bg:#0a0a0b; --card:rgba(28,28,30,.70); --border:rgba(255,255,255,.1);
  --muted:#9aa0a6; --text:#f5f7fa; --accent:#60a5fa; --ok:#34d158; --warn:#facc15; --danger:#f75555;
  --shadow:0 8px 30px rgba(0,0,0,.5);
}
.theme-graphite.light{
  --bg:#f2f4f7; --card:#eeeeef; --border:#c9ccd3; --muted:#5f6672; --text:#0b0c0e;
  --accent:#3b82f6; --ok:#22c55e; --warn:#eab308; --danger:#ef4444;
  --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* Pastel (rodzinny, ≈Çagodny) */
.theme-pastel{
  --bg:#121417; --card:rgba(38,42,49,.72); --border:rgba(255,255,255,.08);
  --muted:#b9c0cf; --text:#f7f9ff; --accent:#9bd1ff; --ok:#a7f3d0; --warn:#fde68a; --danger:#fecaca;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
.theme-pastel.light{
  --bg:#f6f8ff; --card:#f3f6ff; --border:#d7def6; --muted:#53607a; --text:#10131a;
  --accent:#60a5fa; --ok:#34d399; --warn:#f59e0b; --danger:#f87171;
  --shadow:0 12px 28px rgba(2,6,23,.12);
}
/* === Slate Night (ciemny, ale ja≈õniejszy i z wysokim kontrastem) === */

.theme-slate {
  --bg: #1b2230;                /* g≈Ç√≥wne t≈Ço ‚Äì ciemny, ale nie czarny */
  --card: rgba(34, 42, 58, .72);/* karty z lekkƒÖ mgie≈ÇkƒÖ */
  --border: rgba(255,255,255,.10);
  --muted: #a7b3c7;             /* szare teksty z domieszkƒÖ niebieskiego */
  --text: #f4f7fc;              /* jasny, ale nie bia≈Çy */
  --accent: #5fa8f3;            /* niebieski elegancki */
  --ok: #48d7a4;                /* miƒôkka ziele≈Ñ */
  --warn: #e8c16c;              /* miodowy, widoczny na tym tle */
  --danger: #f47a7a;            /* ≈Çagodny czerwony */
  --shadow: 0 8px 26px rgba(0,0,0,.35);
}

/* jasna odmiana Slate (opcjonalnie) */
.theme-slate.light {
  --bg: #eef2fa;
  --card: #f7f9ff;
  --border: #d2dae8;
  --muted: #5b6475;
  --text: #10131a;
  --accent: #3b82f6;
  --ok: #16a34a;
  --warn: #d29b28;
  --danger: #e25555;
  --shadow: 0 12px 28px rgba(2,6,23,.12);
}
/* 5) AMBER */
.theme-amber{
  --bg:#19140c; --card:rgba(48,38,20,.78); --border:rgba(255,255,255,.10);
  --muted:#d6c5a6; --text:#fff8ee; --accent:#f59e0b; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
  --shadow:0 8px 28px rgba(0,0,0,.42);
}
.theme-amber.light{
  --bg:#fff6e8; --card:#fff0d6; --border:#ead4ac; --muted:#6a5840; --text:#1a1309;
  --accent:#d97706; --ok:#10b981; --warn:#d97706; --danger:#dc2626;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}

/* 6) ROSE */
.theme-rose{
  --bg:#1b1316; --card:rgba(52,24,34,.78); --border:rgba(255,255,255,.10);
  --muted:#f0bfcc; --text:#fff2f6; --accent:#fb7185; --ok:#34d399; --warn:#fcd34d; --danger:#f43f5e;
  --shadow:0 8px 28px rgba(0,0,0,.42);
}
.theme-rose.light{
  --bg:#fff0f4; --card:#fff6f8; --border:#ffd3de; --muted:#7a4a58; --text:#1b1316;
  --accent:#f43f5e; --ok:#22c55e; --warn:#eab308; --danger:#e11d48;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}

/* 7) MINT */
.theme-mint{
  --bg:#111816; --card:rgba(20,40,35,.78); --border:rgba(255,255,255,.10);
  --muted:#b9e4d5; --text:#ebfffb; --accent:#2dd4bf; --ok:#22c55e; --warn:#fde047; --danger:#ff8ba0;
  --shadow:0 8px 28px rgba(0,0,0,.42);
}
.theme-mint.light{
  --bg:#ecfffb; --card:#f3fffd; --border:#c7f4ea; --muted:#375a52; --text:#0f1715;
  --accent:#14b8a6; --ok:#16a34a; --warn:#eab308; --danger:#e11d48;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}

/* 8) DENIM */
.theme-denim{
  --bg:#141922; --card:rgba(25,32,46,.78); --border:rgba(255,255,255,.10);
  --muted:#a9b6cf; --text:#f3f7ff; --accent:#60a5fa; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
  --shadow:0 8px 28px rgba(0,0,0,.42);
}
.theme-denim.light{
  --bg:#edf3ff; --card:#f6f9ff; --border:#cfdbff; --muted:#4c5c79; --text:#0f1420;
  --accent:#3b82f6; --ok:#22c55e; --warn:#eab308; --danger:#ef4444;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}

/* 9) LAVENDER */
.theme-lavender{
  --bg:#171726; --card:rgba(34,34,58,.78); --border:rgba(255,255,255,.10);
  --muted:#cbc8f2; --text:#f7f7ff; --accent:#a78bfa; --ok:#22c55e; --warn:#fde047; --danger:#fb7185;
  --shadow:0 8px 28px rgba(0,0,0,.42);
}
.theme-lavender.light{
  --bg:#f6f6ff; --card:#fbfbff; --border:#e0dcff; --muted:#595979; --text:#171726;
  --accent:#8b5cf6; --ok:#16a34a; --warn:#eab308; --danger:#e11d48;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}

/* 10) GRAPHITE SOFT (ja≈õniejszy ciemny, o kt√≥ry prosi≈Çe≈õ) */
.theme-graphiteSoft{
  --bg:#171a1f; --card:rgba(32,36,44,.78); --border:rgba(255,255,255,.12);
  --muted:#aeb6c4; --text:#f4f6fa; --accent:#7aa7ff; --ok:#34d158; --warn:#f2c94c; --danger:#ff7676;
  --shadow:0 8px 30px rgba(0,0,0,.48);
}
.theme-graphiteSoft.light{
  --bg:#f1f3f7; --card:#eceff3; --border:#cfd5df; --muted:#5e6673; --text:#0e1116;
  --accent:#4f86ff; --ok:#22c55e; --warn:#eab308; --danger:#ef4444;
  --shadow:0 12px 24px rgba(2,6,23,.12);
}
/* 10) Drobne doszlifowanie komponent√≥w ‚Äì bez konfliktu ze stylem bazowym */
.task .editable:focus{
  outline:2px solid color-mix(in oklab, var(--accent) 35%, transparent);
  background: rgba(255,255,255,.06);
}
.pill{ will-change: transform; }

/* 11) Kontrast znacznik√≥w i tabel na jasnym */
:root.light table#leaderboard th,
:root.light table#leaderboard td{ border-color: color-mix(in oklab, #242F51 22%, transparent); }
/* === Akcenty sekcji (fallback do --accent) === */
:root{
  --accent-chores: var(--accent);
  --accent-shopping: #22c55e;
  --accent-expenses: #f59e0b;
}
:root.light{
  --accent-chores: var(--accent);
  --accent-shopping: #16a34a;
  --accent-expenses: #d97706;
}

/* Aktywna zak≈Çadka kolorowana akcentem sekcji */
.top-tabs .tab[data-kind="chores"].active{
  border-color: color-mix(in oklab, var(--accent-chores) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-chores) 55%, transparent);
}
.top-tabs .tab[data-kind="shopping"].active{
  border-color: color-mix(in oklab, var(--accent-shopping) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-shopping) 55%, transparent);
}
.top-tabs .tab[data-kind="expenses"].active{
  border-color: color-mix(in oklab, var(--accent-expenses) 35%, transparent);
  box-shadow: 0 14px 30px -12px color-mix(in oklab, var(--accent-expenses) 55%, transparent);
}

/* Focusy/przyciski tylko w obrƒôbie widok√≥w */
#view-chores   input:focus, #view-chores   select:focus { border-color: var(--accent-chores);   box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-chores) 28%, transparent); }
#view-shopping input:focus, #view-shopping select:focus { border-color: var(--accent-shopping); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-shopping) 28%, transparent); }
#view-expenses input:focus, #view-expenses select:focus { border-color: var(--accent-expenses); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent-expenses) 28%, transparent); }

/* === MOTYWY (klasy na <html>) === */

/* 1) Slate ‚Äî ‚Äûja≈õniejszy ciemny‚Äù z wysokim kontrastem */
.theme-slate{
  --bg:#161b22;            /* ciemny granit, ale nie czarny */
  --card:rgba(32,37,46,.78);
  --border:rgba(255,255,255,.10);
  --muted:#a9b4c3;
  --text:#f5f7fb;
  --accent:#6ea8fe;        /* ch≈Çodny niebieski */
  --ok:#34d399;
  --warn:#f2c94c;
  --danger:#ef767a;
  --shadow:0 10px 28px rgba(0,0,0,.38);
}
.theme-slate.light{
  --bg:#eaf0ff;
  --card:#f5f7ff;
  --border:#cdd8f8;
  --muted:#50607b;
  --text:#0e1320;
  --accent:#4f83ff;
  --ok:#16a34a; --warn:#eab308; --danger:#e11d48;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}

/* 2) Ocean (z poprzedniej wiadomo≈õci, skr√≥t) */
.theme-ocean{
  --bg:#0b1220; --card:rgba(17,24,39,.72); --border:rgba(255,255,255,.08);
  --muted:#8aa0b8; --text:#eaf2ff; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
.theme-ocean.light{
  --bg:#e6f0ff; --card:#f3f7ff; --border:#c5d4f7; --muted:#4b5b77; --text:#0b1220;
  --accent:#2563eb; --ok:#059669; --warn:#d97706; --danger:#dc2626;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}

/* 3) Forest (skr√≥t) */
.theme-forest{
  --bg:#0b1614; --card:rgba(13,40,33,.72); --border:rgba(255,255,255,.08);
  --muted:#85a19a; --text:#ebfffb; --accent:#14b8a6; --ok:#22c55e; --warn:#eab308; --danger:#f43f5e;
  --shadow:0 8px 30px rgba(0,0,0,.35);
}
.theme-forest.light{
  --bg:#e8fbf6; --card:#f3fffb; --border:#b9e6dc; --muted:#3d5b55; --text:#0b1614;
  --accent:#0d9488; --ok:#16a34a; --warn:#ca8a04; --danger:#e11d48;
  --shadow:0 12px 28px rgba(2,6,23,.14);
}

/* (opcjonalnie) dopasuj kropkƒô statusu pod aktywny widok */
:root[data-view="shopping"] .dot{ background:var(--accent-shopping); box-shadow:0 0 14px var(--accent-shopping); }
:root[data-view="expenses"] .dot{ background:var(--accent-expenses); box-shadow:0 0 14px var(--accent-expenses); }
/* chores = domy≈õlnie var(--ok) z Twojego CSS */
/* ===== Ocean ===== */
.theme-ocean{
  --bg:#0f1624; --card:rgba(20,28,44,.72); --border:rgba(255,255,255,.10);
  --muted:#8fa6c7; --text:#eaf2ff; --accent:#3b82f6; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,.40);
}
.theme-ocean.light{
  --bg:#eaf2ff; --card:#f5f8ff; --border:#c9d8fb; --muted:#4b5b77; --text:#0f1624;
  --accent:#2563eb; --ok:#059669; --warn:#d97706; --danger:#dc2626; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Forest ===== */
.theme-forest{
  --bg:#0f1715; --card:rgba(17,36,31,.72); --border:rgba(255,255,255,.10);
  --muted:#87a49a; --text:#ecfffb; --accent:#14b8a6; --ok:#22c55e; --warn:#eab308; --danger:#f43f5e;
  --shadow:0 10px 30px rgba(0,0,0,.40);
}
.theme-forest.light{
  --bg:#e8fbf6; --card:#f3fffb; --border:#bfe8df; --muted:#375750; --text:#0f1715;
  --accent:#0d9488; --ok:#16a34a; --warn:#ca8a04; --danger:#e11d48; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Amber ===== */
.theme-amber{
  --bg:#17120a; --card:rgba(44,32,16,.74); --border:rgba(255,255,255,.10);
  --muted:#d2c29f; --text:#fff9f0; --accent:#f59e0b; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
  --shadow:0 10px 30px rgba(0,0,0,.42);
}
.theme-amber.light{
  --bg:#fff7e6; --card:#fff1d6; --border:#ead6a9; --muted:#6b5b43; --text:#17120a;
  --accent:#d97706; --ok:#10b981; --warn:#d97706; --danger:#dc2626; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Aurora (violet) ===== */
.theme-aurora{
  --bg:#140f1b; --card:rgba(38,22,56,.72); --border:rgba(255,255,255,.10);
  --muted:#bea8cf; --text:#fbf7ff; --accent:#8b5cf6; --ok:#22c55e; --warn:#fde047; --danger:#fb7185;
  --shadow:0 10px 30px rgba(0,0,0,.42);
}
.theme-aurora.light{
  --bg:#f7f2ff; --card:#faf6ff; --border:#ddcffb; --muted:#5a4b6e; --text:#140f1b;
  --accent:#7c3aed; --ok:#16a34a; --warn:#eab308; --danger:#e11d48; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Graphite (ja≈õniejszy dark) ===== */
.theme-graphite{
  --bg:#131416; --card:rgba(36,37,39,.74); --border:rgba(255,255,255,.12);
  --muted:#a6acb2; --text:#f5f7fa; --accent:#60a5fa; --ok:#34d158; --warn:#facc15; --danger:#f75555;
  --shadow:0 10px 30px rgba(0,0,0,.48);
}
.theme-graphite.light{
  --bg:#f2f4f7; --card:#eef1f5; --border:#cdd3db; --muted:#616a76; --text:#0c0d0f;
  --accent:#3b82f6; --ok:#22c55e; --warn:#eab308; --danger:#ef4444; --shadow:0 12px 28px rgba(2,6,23,.10);
}

/* ===== Denim (niebiesko-szary) ===== */
.theme-denim{
  --bg:#12161e; --card:rgba(24,34,51,.72); --border:rgba(255,255,255,.10);
  --muted:#9eb0c8; --text:#eff6ff; --accent:#4f86ff; --ok:#2dd4bf; --warn:#f59e0b; --danger:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,.42);
}
.theme-denim.light{
  --bg:#eef5ff; --card:#f5f9ff; --border:#cfe0ff; --muted:#4c5c76; --text:#12161e;
  --accent:#3b7bff; --ok:#14b8a6; --warn:#d97706; --danger:#dc2626; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Moss (zielony szarawy) ===== */
.theme-moss{
  --bg:#131715; --card:rgba(28,39,34,.72); --border:rgba(255,255,255,.10);
  --muted:#a7b7ad; --text:#effff9; --accent:#22c55e; --ok:#10b981; --warn:#eab308; --danger:#f43f5e;
  --shadow:0 10px 30px rgba(0,0,0,.40);
}
.theme-moss.light{
  --bg:#edf7f1; --card:#f4fbf7; --border:#cfe6da; --muted:#3a5247; --text:#131715;
  --accent:#16a34a; --ok:#059669; --warn:#ca8a04; --danger:#e11d48; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Rose (r√≥≈º/fiolet) ===== */
.theme-rose{
  --bg:#161218; --card:rgba(48,28,46,.72); --border:rgba(255,255,255,.10);
  --muted:#d6b3c7; --text:#fff5f8; --accent:#f472b6; --ok:#34d399; --warn:#fde047; --danger:#fb7185;
  --shadow:0 10px 30px rgba(0,0,0,.42);
}
.theme-rose.light{
  --bg:#fff0f6; --card:#fff6fa; --border:#f2cfe0; --muted:#6c4b5e; --text:#161218;
  --accent:#ec4899; --ok:#10b981; --warn:#eab308; --danger:#e11d48; --shadow:0 12px 28px rgba(2,6,23,.12);
}

/* ===== Slate (szaroniebieski neutral) ===== */
.theme-slate{
  --bg:#14161a; --card:rgba(32,36,42,.74); --border:rgba(255,255,255,.12);
  --muted:#aeb6c2; --text:#f6f8fb; --accent:#7dd3fc; --ok:#22d3ee; --warn:#fbbf24; --danger:#f87171;
  --shadow:0 10px 30px rgba(0,0,0,.46);
}
.theme-slate.light{
  --bg:#f4f7fb; --card:#eef3f9; --border:#d3dae5; --muted:#5b6676; --text:#111319;
  --accent:#38bdf8; --ok:#06b6d4; --warn:#d97706; --danger:#ef4444; --shadow:0 12px 28px rgba(2,6,23,.10);
}

/* ===== Cocoa (ciep≈Çy brƒÖz) ===== */
.theme-cocoa{
  --bg:#171312; --card:rgba(54,40,35,.74); --border:rgba(255,255,255,.10);
  --muted:#d7c1b9; --text:#fff7f3; --accent:#d97706; --ok:#22c55e; --warn:#eab308; --danger:#f43f5e;
  --shadow:0 10px 30px rgba(0,0,0,.46);
}
.theme-cocoa.light{
  --bg:#fff5ef; --card:#fff0e6; --border:#f0d7ca; --muted:#6b534b; --text:#171312;
  --accent:#b45309; --ok:#16a34a; --warn:#ca8a04; --danger:#e11d48; --shadow:0 12px 28px rgba(2,6,23,.10);
}
/* FIX: task action buttons mieszczƒÖ siƒô w karcie (mobile) */
@media (max-width: 640px){
  #tasksList .task{
    flex-wrap: wrap;
    align-items: stretch;
  }
  /* tytu≈Ç idzie w pe≈ÇnƒÖ szeroko≈õƒá, ≈ºeby akcje mog≈Çy spa≈õƒá ni≈ºej */
  #tasksList .task > label{
    flex: 1 1 100%;
    min-width: 0;
  }
  /* rzƒÖd akcji ≈Çamie siƒô i zajmuje ca≈ÇƒÖ szeroko≈õƒá */
  #tasksList .task .actions{
    flex: 1 1 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: flex-start; /* albo space-between ‚Äì jak wolisz */
    margin-top: 6px;
  }
  /* przyciski akcji: 3 w rzƒôdzie, mniejsze paddingi */
  #tasksList .task .actions .btn{
    padding: 8px 10px;
    flex: 1 0 calc(25% - 8px);
    max-width: calc(25% - 8px);
    white-space: nowrap; /* ikona i kr√≥tki tekst w jednej linii */
  }
}

</style>
  <link rel="stylesheet" href="theme-sections.css">
</head>
<body>
<div id="splash"><div class="logo">üßπ</div></div>
<script>
  // awaryjne zdjƒôcie splash po 2s, nawet je≈õli wcze≈õniejszy JS pad≈Ç
  setTimeout(function(){
    var s=document.getElementById('splash');
    if(s) s.remove();
  }, 2000);
</script>

<div class="wrap">
  <header>
    <div class="title"><span class="dot"></span> Domowy organizer ‚Äî PRO 3+</div>
    <div>
      <div class="subtitle" id="today"></div>
      <div class="subtitle">Rodzina: <strong id="familyLabel">‚Äî</strong></div>
    </div>
    <div class="row">
      <div class="top-tabs">
        <button id="tabChores" class="tab active" data-kind="chores">üß∫ ObowiƒÖzki</button>
        <button id="tabShopping" class="tab" data-kind="shopping">üõí Zakupy</button>
        <button id="tabExpenses" class="tab" data-kind="expenses">üí∏ Wydatki</button>
      </div>
      <button id="themeToggle" class="btn" title="Jasny / ciemny">‚òÄÔ∏è / üåô</button>
      <button id="themeCycleBtn" class="btn" title="Zmie≈Ñ motyw">üé® Motyw</button>

    </div>
  </header>

  <!-- ====== WIDOK: OBOWIƒÑZKI ====== -->
  <div id="view-chores">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="muted">Zak≈Çadki domownik√≥w</div>
          <div id="peopleTabs" class="row" style="gap:8px;flex-wrap:wrap"></div>
          <div class="row" style="margin-top:8px">
            <button id="addPersonBtn" class="btn">‚ûï Dodaj osobƒô</button>
            <button id="renamePersonBtn" class="btn">‚úèÔ∏è Zmie≈Ñ</button>
            <button id="setGoalBtn" class="btn">üéØ Cel</button>
            <button id="setIcsBtn" class="btn">‚è∞ Godzina .ics</button>
            <button id="pinBtn" class="btn">üîí PIN / Tryb dziecka</button>
            <button id="removePersonBtn" class="btn" style="border-color:rgba(255,69,58,.35);color:#ffd1cc">üóëÔ∏è Usu≈Ñ</button>
          </div>
        </div>
        <div class="row">
          <button id="endDayBtn" class="btn">üåô Zako≈Ñcz dzie≈Ñ</button>
          <button id="endWeekBtn" class="btn">üèÅ Zako≈Ñcz tydzie≈Ñ</button>
          <button id="changeFamilyBtn" class="btn" title="Ustaw / zmie≈Ñ rodzinƒô">üë™ Zmie≈Ñ rodzinƒô</button>



        </div>
      </div>
    </div>

    <div style="height:10px"></div>

    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Zadania <span id="personTitle" class="muted"></span></h3>
          <div class="row" id="taskToolbar">
            <label class="muted">Sortuj</label>
            <select id="sortBy"><option value="status">Status</option><option value="priority">Priorytet</option><option value="title">Tytu≈Ç A‚ÜíZ</option><option value="zone">Strefa</option></select>
            <button id="resetDailyBtn" class="btn">üîÅ Reset</button>
            <button id="clearDoneBtn" class="btn">üßπ Usu≈Ñ wykonane</button>
            <!-- TTS zostanie tu przeniesiony skryptem -->
          </div>
        </div>
        <div id="tasksList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px"></div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Dodaj zadanie</h3>
        <div class="row" style="flex-direction:column;gap:10px;width:100%">
          <input id="taskTitle" type="text" placeholder="np. odkurzyƒá salon"/>
          <div class="row" style="width:100%">
            <select id="planType" style="flex:1">
              <option value="daily" selected>Codziennie</option>
              <option value="once">W konkretnym dniu</option>
              <option value="weekly">Co tydzie≈Ñ</option>
              <option value="monthly">Co miesiƒÖc</option>
              <option value="yearly">Co rok</option>
            </select>
            <input id="taskTime" type="time" value="07:00" style="width:140px"/>
          </div>
          <div class="row" id="oncePicker" style="display:none;width:100%"><label class="muted">Data:</label><input id="taskDate" type="date" style="flex:1"/></div>
          <div class="row" id="monthlyPicker" style="display:none;width:100%"><label class="muted">Dzie≈Ñ miesiƒÖca:</label><input id="dayOfMonth" type="number" min="1" max="31" value="1" style="width:120px"/></div>
          <div class="row" id="yearlyPicker" style="display:none;width:100%"><label class="muted">Data w roku:</label><input id="yearlyDate" type="date" style="flex:1"/></div>
          <div class="row" id="weeklyPicker" style="display:none;width:100%"><label class="muted">Dni:</label>
            <label><input type="checkbox" value="1">Pn</label><label><input type="checkbox" value="2">Wt</label><label><input type="checkbox" value="3">≈ör</label><label><input type="checkbox" value="4">Cz</label><label><input type="checkbox" value="5">Pt</label><label><input type="checkbox" value="6">So</label><label><input type="checkbox" value="0">Nd</label>
          </div>
          <div class="row" style="width:100%">
            <select id="taskZone" style="flex:1"></select>
            <select id="taskPriority" style="flex:1">
              <option value="high">üî• Wysoki</option>
              <option value="med" selected>‚Ä¢ ≈öredni</option>
              <option value="low">‚Ä¶ Niski</option>
            </select>
            <input id="taskPoints" type="number" min="1" step="1" value="1" style="width:120px"/>
          </div>
          <div class="row" style="width:100%">
            <label class="muted">Kara gdy nie zrobione (‚≠ê):</label>
            <input id="taskPenalty" type="number" min="0" step="1" value="1" style="width:120px" />
          </div>
          <div class="row" style="width:100%"><label class="muted">Przypomnij wcze≈õniej:</label>
            <input id="remNum" type="number" min="0" step="1" value="10" style="width:100px"/>
            <select id="remUnit" style="width:150px"><option value="minutes" selected>minuty</option><option value="hours">godziny</option><option value="days">dni</option><option value="weeks">tygodnie</option><option value="months">miesiƒÖce</option><option value="years">lata</option></select>
          </div>
          <button id="addTaskBtn" class="btn">‚úÖ Dodaj</button>
        </div>

        <hr style="border-color:var(--border);margin:14px 0"/>

        <h3 style="margin-top:0">Punktacja i cele</h3>
        <div class="row" style="justify-content:space-between;width:100%">
          <div style="flex:1">
            <div class="row" style="justify-content:space-between">
              <div>Dzisiejsze: <span class="score" id="todayScore">0</span> / <span id="goalScore">0</span> ‚≠ê</div>
              <div class="muted">Tydzie≈Ñ: <span class="score" id="weekScore">0</span></div>
            </div>
            <div class="progress" style="margin-top:6px"><div id="goalBar"></div></div>
          </div>
          <div class="row"><label class="muted">Kara globalna (nieu≈ºywana)</label>
            <select id="penaltyPolicy" disabled><option value="1" selected>-100%</option></select>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <h4 style="margin:0 0 6px 0">Szybkie korekty (nagrody/kary)</h4>
          <div class="row" style="width:100%">
            <input id="deltaPoints" type="number" value="1" min="1" step="1" style="width:120px"/>
            <select id="deltaScope" style="width:160px">
              <option value="week">Tydzie≈Ñ</option>
              <option value="today">Dzi≈õ</option>
            </select>
            <button id="deltaMinus" class="btn">‚ûñ Odejmij</button>
            <button id="deltaPlus" class="btn">‚ûï Dodaj</button>
          </div>
        </div>

        <hr style="border-color:var(--border);margin:14px 0"/>

        <h3 style="margin-top:0">Sklepik nagr√≥d üéÅ</h3>
        <div id="shopList" style="display:flex;flex-direction:column;gap:8px"></div>
        <div class="row"><input id="rewardName" type="text" placeholder="np. seans filmu" style="flex:1"/><input id="rewardCost" type="number" min="1" step="1" value="10" style="width:120px"/><button id="addRewardBtn" class="btn">‚ûï</button></div>

        <hr style="border-color:var(--border);margin:14px 0"/>

        <h3 style="margin-top:0">Udostƒôpnij / Eksport</h3>
        <div class="row">
          <button id="mailBtn" class="btn">üìß Podsumowanie</button>
          <button id="copyBtn" class="btn">üìã Kopiuj</button>
          <button id="icsBtn" class="btn">üìÜ .ics (osoba)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="exportCSVPersonBtn" class="btn">‚¨áÔ∏è CSV (osoba)</button>
          <button id="exportCSVAllBtn" class="btn">‚¨áÔ∏è CSV (wszyscy)</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="exportBtn" class="btn">‚òÅÔ∏è Zapisz JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none"/>
          <button id="importBtn" class="btn">‚òÅÔ∏è Wczytaj JSON</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="remindersBtn" class="btn">üìù Do Przypomnie≈Ñ (Shortcuts)</button>
          <button id="ttsBtn" class="btn">üîä Czytaj teraz</button>
        </div>

        <hr style="border-color:var(--border);margin:14px 0"/>

        <h3 style="margin-top:0">Strefy domu</h3>
        <div class="row">
          <select id="zonesSelect" style="flex:1"></select>
          <input id="newZone" type="text" placeholder="Nowa strefa" style="flex:1"/>
          <button id="addZoneBtn" class="btn">‚ûï</button>
          <button id="delZoneBtn" class="btn" title="Usu≈Ñ wybranƒÖ">üóëÔ∏è</button>
          <button id="randomZoneBtn" class="btn">üé≤ Losuj</button>
        </div>
        <div id="zonesBadges" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
      </aside>
    </div>

    <div style="height:10px"></div>

    <section class="card">
      <h3 style="margin:0 0 10px 0">Widok tygodnia (przeciƒÖgnij zadanie na dzie≈Ñ tygodnia)</h3>
      <div id="weekGrid" class="week"></div>
    </section>

    <div style="height:10px"></div>

    <section class="card">
      <h3 style="margin:0 0 10px 0">Statystyki</h3>
      <div class="statsGrid">
        <div>
          <h4 style="margin:0 0 6px 0" class="muted">Heatmapa 6 tygodni (‚≠ê na dzie≈Ñ)</h4>
          <canvas id="heat" width="600" height="240"></canvas>
        </div>
        <div>
          <h4 style="margin:0 0 6px 0" class="muted">Top strefy (ostatnie 30 dni)</h4>
          <ul id="topZones" style="margin:0;padding-left:18px"></ul>
        </div>
      </div>
    </section>

    <div style="height:10px"></div>

    <aside class="card">
      <h3 style="margin:0 0 6px 0">Tablica wynik√≥w</h3>
      <table id="leaderboard" style="width:100%;border-collapse:collapse"></table>
    </aside>
  </div><!-- /view-chores -->

  <!-- ====== WIDOK: ZAKUPY ====== -->
  <div id="view-shopping" style="display:none">
    <section class="card">
      <h3 style="margin:0 0 10px 0">Lista zakup√≥w (wsp√≥lna)</h3>
      <div class="row" style="flex-direction:column;gap:10px;width:100%">
        <div class="row" style="width:100%">
          <input id="shopTitle" type="text" placeholder="np. Mleko 2%"/>
          <input id="shopQty" type="text" placeholder="ilo≈õƒá (opcjonalnie)" style="width:160px"/>
        </div>
        <div class="row" style="width:100%">
          <select id="shopSection" style="flex:1"></select>
          <select id="shopAssignee" style="flex:1"></select>
          <select id="shopPriority" style="width:160px">
            <option value="high">üî• Pilne</option>
            <option value="med" selected>‚Ä¢ Normalne</option>
            <option value="low">‚Ä¶ Lu≈∫ne</option>
          </select>
        </div>
        <div class="row">
          <button id="shopAddBtn" class="btn">‚ûï Dodaj pozycjƒô</button>
          <button id="shopClearDoneBtn" class="btn">üßπ Usu≈Ñ kupione</button>
          <button id="shopExportBtn" class="btn">üìã Kopiuj listƒô</button>
        </div>
      </div>
    </section>
  <section class="card">
    <h3 style="margin:0 0 10px 0">Kategorie zakup√≥w</h3>
    <div class="row" style="gap:8px">
      <select id="shopCatsSelect" style="flex:1"></select>
      <input id="shopNewCat" type="text" placeholder="Nowa kategoria" style="flex:1"/>
      <button id="shopAddCatBtn" class="btn">‚ûï</button>
      <button id="shopDelCatBtn" class="btn" title="Usu≈Ñ wybranƒÖ">üóëÔ∏è</button>
    </div>
  </section>

    <div style="height:10px"></div>

    <section class="card">
      <h3 style="margin:0 0 10px 6px">Do kupienia</h3>
      <div id="shopCats" class="cat-chips"></div>
      <div id="shopListContainer" class="shop-grid"></div>
    </section>
  </div><!-- /view-shopping -->

  <!-- ====== WIDOK: WYDATKI ====== -->
  <div id="view-expenses" style="display:none">
    <section class="card">
      <h3 style="margin:0 0 10px 0">Dodaj wydatek</h3>
      <div class="row" style="flex-direction:column;gap:10px;width:100%">
        <div class="row" style="width:100%">
          <input id="expTitle" type="text" placeholder="np. Rachunek za prƒÖd"/>
          <input id="expAmount" type="number" step="0.01" min="0" placeholder="kwota" style="width:160px"/>
        </div>
        <div class="row" style="width:100%">
          <select id="expSection" style="flex:1"></select>
          <input id="expDate" type="date" style="width:180px"/>
          <button id="expAddBtn" class="btn">‚ûï Dodaj</button>
        </div>
      </div>
    </section>

    <div style="height:10px"></div>

   <section class="card">
  <div class="exp-head">
    <h3 style="margin:0">Podsumowania</h3>
    <div class="muted" id="expMonthLabel">‚Äî</div>
  </div>

  <!-- (NOWE) wyb√≥r miesiƒÖca/roku + nawigacja -->
  <div class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0 4px 0">
    <button id="expPrevMonth" class="btn" title="Poprzedni miesiƒÖc">‚ü®</button>
    <select id="expFilterMonth" style="min-width:160px">
      <option value="0">stycze≈Ñ</option>
      <option value="1">luty</option>
      <option value="2">marzec</option>
      <option value="3">kwiecie≈Ñ</option>
      <option value="4">maj</option>
      <option value="5">czerwiec</option>
      <option value="6">lipiec</option>
      <option value="7">sierpie≈Ñ</option>
      <option value="8">wrzesie≈Ñ</option>
      <option value="9">pa≈∫dziernik</option>
      <option value="10">listopad</option>
      <option value="11">grudzie≈Ñ</option>
    </select>
    <select id="expFilterYear" style="min-width:120px"></select>
    <button id="expNextMonth" class="btn" title="Nastƒôpny miesiƒÖc">‚ü©</button>
    <button id="expTodayBtn" class="btn" title="Skocz do bie≈ºƒÖcego miesiƒÖca">Dzi≈õ</button>
  </div>
  <!-- /NOWE -->

  <div class="row" style="gap:12px; align-items:flex-start; flex-wrap:wrap">
    <div class="exp-section" style="flex:1 1 260px">
      <div class="exp-head">
        <div>Ten miesiƒÖc ‚Äî razem</div>
        <div class="exp-total" id="expMonthTotal">0,00 z≈Ç</div>
      </div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th>Kategoria</th><th>Kwota</th></tr></thead>
        <tbody id="expMonthByCat"></tbody>
      </table>
    </div>
    <div class="exp-section" style="flex:2 1 420px">
      <div class="exp-head"><div>Wszystkie wydatki (ostatnie 60 dni)</div><div></div></div>
      <div id="expList"></div>
    </div>
  </div>
</section>

    <div style="height:10px"></div>

    <section class="card">
      <h3 style="margin:0 0 10px 0">Kategorie wydatk√≥w</h3>
      <div class="row">
        <select id="expCatsSelect" style="flex:1"></select>
        <input id="expNewCat" type="text" placeholder="Nowa kategoria" style="flex:1"/>
        <button id="expAddCatBtn" class="btn">‚ûï</button>
        <button id="expDelCatBtn" class="btn" title="Usu≈Ñ wybranƒÖ">üóëÔ∏è</button>
      </div>
    </section>
  </div><!-- /view-expenses -->

</div><!-- /wrap -->

<div id="overlay" class="overlay"><div id="dialog" class="dialog"></div></div>

<script>
/* --- DEBUG: poka≈º b≈ÇƒÖd zamiast staƒá na splashu --- */
window.addEventListener('error', function(e){
  console.error('[JS ERROR]', e.error || e.message || e);
  alert('B≈ÇƒÖd JS: ' + (e?.message || e));
});
window.addEventListener('unhandledrejection', function(e){
  console.error('[PROMISE REJECTION]', e.reason);
  alert('B≈ÇƒÖd (obietnica): ' + (e?.reason?.message || e?.reason || 'unknown'));
});

  /* ---------- AWARYJNY RESET: ?reset=1 lub #reset ---------- */
(function(){
  if (location.search.includes('reset=1') || location.hash === '#reset') {
    try {
      localStorage.removeItem('familyId');
      localStorage.removeItem('home-chores-pro3-full');
      if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    } finally {
      alert('Zresetowano dane i cache. ≈Åadujƒô ponownie‚Ä¶');
      location.replace(location.pathname);
    }
  }
})();

/* ===== UTIL ===== */
const $=s=>document.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const todayEl=$('#today'); function fmtDate(d){return d.toLocaleDateString('pl-PL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function nowYMD(){const d=new Date();return d.toISOString().slice(0,10)}
function hmToParts(hm='07:00'){const [H,M]=hm.split(':').map(n=>parseInt(n,10));return{H:isNaN(H)?7:H,M:isNaN(M)?0:M}}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function copy(text){return navigator.clipboard.writeText(text)}
function showDialog(html){$('#dialog').innerHTML=html;$('#overlay').style.display='flex'}
function closeDialog(){ $('#overlay').style.display='none' }

/* ====== GATEKEEPER PIN (Tryb dziecka) ======
   ‚Äì Dziecko MO≈ªE: odhaczanie zada≈Ñ (wraz z podzadaniami), realizacjƒô nagr√≥d.
   ‚Äì Wszystko inne wymaga PINu osoby, gdy childMode=true. */
function needsPinFor(p, action){
  if (!p?.childMode) return false;
  const allowed = ['toggleTask','toggleSubtask','redeemReward']; // tylko to wolno bez PIN-u
  return !allowed.includes(action);
}

/* ===== GATEKEEPER PIN (Tryb dziecka ‚Äì sesyjny) =====
   ‚Äì Dziecko (actor.childMode===true) mo≈ºe TYLKO: toggleTask, toggleSubtask, redeemReward.
   ‚Äì Wszystko inne blokowane, tak≈ºe poza jego profilem i w innych zak≈Çadkach.
   ‚Äì Je≈õli akcja dotyczy profilu z PIN-em: wymagamy PIN-u tego profilu. */
function needsPinFor(targetPerson, action){
  const allowed = ['toggleTask','toggleSubtask','redeemReward'];

  // 1) Je≈õli aktorem jest dziecko ‚Äì blokuj wszystko poza allowed
  const actor = currentActor();
  if (actor?.childMode) {
    return !allowed.includes(action); // true => wymaga PINu/odmowa
  }

  // 2) Je≈õli target ma childMode ‚Äì wymagaj PINu poza allowed
  if (targetPerson?.childMode) {
    return !allowed.includes(action);
  }
  return false;
}

function guardAction(targetPerson, action){
  const actor = currentActor();
  if (!needsPinFor(targetPerson, action)) return true;

  // W sesji dziecka: twarda blokada (bez podawania PIN-u)
  if (actor?.childMode && !['toggleTask','toggleSubtask','redeemReward'].includes(action)) {
    alert('Tryb dziecka: akcja zablokowana.');
    return false;
  }

  // Wymagamy PIN-u profilu targetPerson
  if (!targetPerson?.pin) { alert('Akcja zablokowana: brak ustawionego PIN-u profilu.'); return false; }
  const entered = prompt('Podaj PIN profilu:');
  return entered === targetPerson.pin;
}

/* ===== FIREBASE (opcjonalny) ===== */
let fbApp=null, fs=null, fbDoc=null, __unsub=null;
const FIREBASE_COLLECTION = 'organizer';
function setFamilyLabel(id){ const l=document.getElementById('familyLabel'); if(l) l.textContent=id || '‚Äî'; }

async function subscribeToFamily(id){
  if(!fs || !id) return;
  id = String(id).trim();
  localStorage.setItem('familyId', id);
  setFamilyLabel(id);

  if (__unsub) { try{ __unsub(); }catch(_){ } __unsub=null; }
  fbDoc = fs.collection(FIREBASE_COLLECTION).doc(id);

  __unsub = fbDoc.onSnapshot((snap)=>{
    const data = snap.data();
    if(!data || !data.payload) return;
    try{
      const payload = (typeof data.payload === 'string') ? JSON.parse(data.payload) : data.payload;
      if(!payload) return;

      const local = (()=>{ try { return JSON.parse(localStorage.getItem(stateKey)||'{}'); } catch { return {}; }})();
      const cloudMillis = data.updatedAt?.toMillis?.() ?? payload.updatedAt ?? 0;
      const localMillis = local.updatedAt ?? 0;

      if (!localMillis || cloudMillis > localMillis) {
        db = payload;
        localStorage.setItem(stateKey, JSON.stringify(db));
        renderAll();
      }
    }catch(e){ console.warn('Snapshot parse error', e); }
  }, (err)=>console.error('onSnapshot error', err));
}

async function tryFirebaseInit(){
  try{
    if(!window.firebaseConfig || !window.firebaseConfig.apiKey){
  setFamilyLabel(localStorage.getItem('familyId'));
  return;
}


    if(!firebase.apps?.length){ fbApp = firebase.initializeApp(window.firebaseConfig); }
    firebase.appCheck().activate("6LffMAQsAAAAAHaO0TzmnQHwSA3SPNOxJOOIFCk1", true);

    fs = firebase.firestore();

    let family = localStorage.getItem('familyId');
    if(!family){
      const prev = localStorage.getItem('familyId') || '';
      family = prompt('ID rodziny (np. rodzina-kowalscy) ‚Äî wsp√≥lna dla wszystkich urzƒÖdze≈Ñ:', prev || 'rodzina-demo');
      if(!family) return;
      family = String(family).trim();
      localStorage.setItem('familyId', family);
    }
    setFamilyLabel(family);

    await subscribeToFamily(family);
    pushToFirebase();
  }catch(e){ console.warn('Firebase init error', e); }
}

/* ---- BEZPIECZNY ZAPIS ---- */
async function pushToFirebase(){
  if(!fbDoc) return;
  try{
    const payloadStr = JSON.stringify(db);
    const snap = await fbDoc.get();
    if (snap.exists) {
      const data = snap.data() || {};
      const cloud = (typeof data.payload==='string') ? JSON.parse(data.payload) : (data.payload||{});
      const cloudMillis = data.updatedAt?.toMillis?.() ?? cloud.updatedAt ?? 0;
      const localMillis = db.updatedAt ?? 0;
      if (localMillis && localMillis <= cloudMillis) {
        return;
      }
    }
    await fbDoc.set(
      { payload: payloadStr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge:true }
    );
  }catch(e){
    console.error('[Firestore] zapis ERROR', e);
    alert('B≈ÇƒÖd zapisu do Firestore: ' + (e?.message || e));
  }
}

/* ===== STATE ===== */
const stateKey='home-chores-pro3-full';
const defaultZones=['Kuchnia','Salon','≈Åazienka','Sypialnia','Korytarz'];
const defaultRewards=[
  {id:crypto.randomUUID(),name:'Seans filmu',cost:20},
  {id:crypto.randomUUID(),name:'Godzina gry',cost:25}
];
const defaultShoppingSections=['Jedzenie','Szko≈Ça','Praca','Przyjemno≈õci','Chemia','Kosmetyki','Samoch√≥d','Inne'];
/* Wydatki ‚Äì domy≈õlne kategorie */
const defaultExpenseSections=['Rachunki','Jedzenie','Transport','Dzieci','Mieszkanie','Zdrowie','Rozrywka','Inne'];

const defaultData={
  zones:defaultZones,
  rewards:defaultRewards,
  shopping: [],
  shoppingSections: defaultShoppingSections,
  /* WYDATKI */
  expenses: [],
  expenseSections: defaultExpenseSections,
  people:[
    {id:crypto.randomUUID(),name:'Ja',goal:5,streak:0,icsTime:'07:00',scoreToday:0,scoreWeek:0,bank:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[

      {id:crypto.randomUUID(),title:'Wyrzuciƒá ≈õmieci',schedType:'daily',time:'07:00',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]},
      {id:crypto.randomUUID(),title:'Nakarmiƒá kota',schedType:'daily',time:'07:10',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]}
    ]},
    {id:crypto.randomUUID(),name:'Ania',goal:5,streak:0,icsTime:'07:10',scoreToday:0,scoreWeek:0,bank:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[

      {id:crypto.randomUUID(),title:'Zmywarka ‚Äî roz≈Çaduj',schedType:'daily',time:'07:30',points:2,penalty:1,priority:'high',zone:'Kuchnia',done:false,sub:[]},
      {id:crypto.randomUUID(),title:'Podlaƒá kwiaty',schedType:'weekly',dows:[3],time:'18:00',points:2,penalty:1,priority:'low',zone:'Salon',done:false,sub:[]}
    ]}
  ],
  currentPersonId:null,penaltyFactor:1,history:[],updatedAt: Date.now()
};
function load(){try{return JSON.parse(localStorage.getItem(stateKey))||defaultData}catch(e){return defaultData}}
function save(){ db.updatedAt=Date.now(); localStorage.setItem(stateKey,JSON.stringify(db)); pushToFirebase(); }
let db = load();
/* === SESSION ACTOR (kto u≈ºywa urzƒÖdzenia) === */
const ACTOR_KEY = 'ui-actor-id';
let actorId = localStorage.getItem(ACTOR_KEY) || null;
function setActor(id){ actorId = id || null; localStorage.setItem(ACTOR_KEY, id || ''); }
function currentActor(){ return db.people.find(x=>x.id===actorId) || null; }

/* ====== WYB√ìR MIESIƒÑCA/ROKU DLA WYDATK√ìW (zapamiƒôtywany w localStorage) ====== */
const EXP_MONTH_KEY = 'exp-view-month'; // 0..11
const EXP_YEAR_KEY  = 'exp-view-year';  // np. 2025

function getExpSelectedMonthYear() {
  const now = new Date();
  const m = parseInt(localStorage.getItem(EXP_MONTH_KEY) ?? now.getMonth(), 10);
  const y = parseInt(localStorage.getItem(EXP_YEAR_KEY)  ?? now.getFullYear(), 10);
  return {
    month: isNaN(m) ? now.getMonth()    : Math.min(11, Math.max(0, m)),
    year:  isNaN(y) ? now.getFullYear() : y
  };
}
function setExpSelectedMonthYear(month, year) {
  localStorage.setItem(EXP_MONTH_KEY, String(Math.min(11, Math.max(0, month))));
  localStorage.setItem(EXP_YEAR_KEY,  String(year));
}
function expTargetDate() {
  const {month, year} = getExpSelectedMonthYear();
  return new Date(year, month, 1, 12, 0, 0, 0);
}
function expShiftMonth(delta) {
  const {month, year} = getExpSelectedMonthYear();
  const base = new Date(year, month, 1);
  base.setMonth(base.getMonth() + delta);
  setExpSelectedMonthYear(base.getMonth(), base.getFullYear());
}
function expYearsRange() {
  const years = new Set();
  (db.expenses||[]).forEach(e=>{
    const d = new Date(e.date);
    if(!isNaN(d)) years.add(d.getFullYear());
  });
  if(!years.size){
    const nowY = new Date().getFullYear();
    for(let y=nowY-5; y<=nowY+5; y++) years.add(y);
  }
  return Array.from(years).sort((a,b)=>a-b);
}
function expMonthLabel(d){
  return d.toLocaleDateString('pl-PL',{month:'long',year:'numeric'});
}

if(!db.currentPersonId && db.people.length) db.currentPersonId=db.people[0].id;
setFamilyLabel(localStorage.getItem('familyId'));


/* ===== HEADER & TABS ===== */
function renderDate(){todayEl.textContent=fmtDate(new Date())}
function currentPerson(){return db.people.find(p=>p.id===db.currentPersonId)||db.people[0]}
const tabsEl=$('#peopleTabs');
function renderTabs(){
  tabsEl.innerHTML='';
  const actor = currentPerson(); // aktywnie wybrana osoba / "aktor"

  db.people.forEach(p=>{
    const b=document.createElement('button');
    b.className='btn'+(p.id===db.currentPersonId?'':'');
    b.textContent=`${p.name} ¬∑ ‚≠ê ${p.scoreWeek} ¬∑ üî• ${p.streak||0}${p.childMode?' ¬∑ üë∂':''}`;

    b.onclick=()=>{
      // je≈õli AKTUALNY profil ma childMode, nie pozwalamy prze≈ÇƒÖczyƒá na kogo≈õ innego
      const cur = currentPerson();
      if (cur?.childMode && cur.id !== p.id){
        alert('Tryb dziecka: nie mo≈ºesz prze≈ÇƒÖczyƒá na innego domownika.');
        return;
      }
      db.currentPersonId=p.id; save(); renderAll();
    };

    b.setAttribute('aria-pressed', p.id===db.currentPersonId ? 'true' : 'false');
    tabsEl.appendChild(b);
  });
}


/* ===== ZONES ===== */
function renderZones(){ $('#taskZone').innerHTML=db.zones.map(z=>`<option value="${z}">${z}</option>`).join(''); $('#zonesSelect').innerHTML=db.zones.map(z=>`<option>${z}</option>`).join(''); const badges=$('#zonesBadges'); badges.innerHTML=''; db.zones.forEach(z=>{const t=document.createElement('span');t.className='zoneTag';t.textContent=z;badges.appendChild(t)})}
function addZone(){const p=currentPerson(); if(!guardAction(p,'addZone')) return; const z=$('#newZone').value.trim(); if(!z) return; if(!db.zones.includes(z)) db.zones.push(z); $('#newZone').value=''; save(); renderZones()}
function delZone(){const p=currentPerson(); if(!guardAction(p,'delZone')) return; const val=$('#zonesSelect').value; if(!val) return; if(!confirm(`UsunƒÖƒá strefƒô ‚Äû${val}‚Äù?`)) return; db.zones=db.zones.filter(z=>z!==val); save(); renderZones()}
function randomZone(){ if(!db.zones.length) return alert('Brak stref'); const z=db.zones[Math.floor(Math.random()*db.zones.length)]; alert('üé≤ Dzisiejsza strefa: '+z) }

/* ===== SHOP (sklepik nagr√≥d) ===== */
function renderShop(){
  const host=$('#shopList');host.innerHTML='';
  const p=currentPerson();if(!p)return;
  db.rewards.forEach(r=>{
    const row=document.createElement('div');row.className='shopItem';
    row.innerHTML=`<div>${r.name} ‚Äî <b>${r.cost}‚≠ê</b></div>`;
    const box=document.createElement('div');box.style.display='flex';box.style.gap='6px';
    const btn=document.createElement('button');btn.className='btn';btn.textContent='Zrealizuj';
    btn.onclick=()=>{ // Dziecko MO≈ªE realizowaƒá
      /* PATCH: sprawdzamy bank, nie tydzie≈Ñ */
      if((p.bank||0)<r.cost){alert('Za ma≈Ço ‚≠ê w banku');return}
      showDialog(`<h3 style="margin-top:0">Potwierd≈∫ nagrodƒô</h3><p>${p.name} wymienia <b>${r.cost}‚≠ê</b> na ‚Äû${r.name}‚Äù. Kontynuowaƒá?</p><div class="row" style="justify-content:flex-end"><button class="btn" onclick="closeDialog()">Anuluj</button><button class="btn" onclick="redeem('${r.id}')">‚úÖ OK</button></div>`)
    };
    const del=document.createElement('button');del.className='btn';del.textContent='üóëÔ∏è';del.title='Usu≈Ñ nagrodƒô';
    del.onclick=()=>{ if(!confirm(`UsunƒÖƒá nagrodƒô ‚Äû${r.name}‚Äù?`)) return; db.rewards=(db.rewards||[]).filter(x=>x.id!==r.id); save(); renderShop(); };

    box.appendChild(btn);box.appendChild(del);row.appendChild(box);host.appendChild(row)
  })
}
function redeem(id){
  const p=currentPerson();
  const r=db.rewards.find(x=>x.id===id);
  if(!p||!r) return;
  /* PATCH: schodzimy z banku, nie z tygodnia */
  p.bank = Math.max(0, (p.bank||0) - r.cost);
  db.history.push({date:nowYMD(), personId:p.id, earned:0, missed:0, reward:r.name});
  save(); closeDialog(); renderScores(); renderTabs();
}
/* ===== SCORES ===== */

const personTitleEl=$('#personTitle'),todayScoreEl=$('#todayScore'),weekScoreEl=$('#weekScore'),goalScoreEl=$('#goalScore'),goalBarEl=$('#goalBar'),leaderboardEl=$('#leaderboard');
function goalForToday(p){ return p.tasks.filter(dueToday).length; }
function renderScores(){
  const p=currentPerson(); if(!p) return;
  todayScoreEl.textContent=p.scoreToday||0;
  weekScoreEl.textContent=p.scoreWeek||0;
  const g = Math.max(0, goalForToday(p));
  goalScoreEl.textContent=g;
  const perc = g? clamp(Math.round(100*(p.scoreToday||0)/g),0,100) : 0;
  goalBarEl.style.width = perc+'%';
  $('#penaltyPolicy').value='1';
}
function latePenaltyForTask(p,t){
  if(!t.time) return 0;
  const now=new Date();
  const {H,M}=hmToParts(t.time||'07:00');
  const sched=new Date(now.getFullYear(),now.getMonth(),now.getDate(),H,M,0);
  if(now<=sched) return 0;
  const hoursLate=Math.floor((now-sched)/(60*60*1000));
  return Math.max(0,(p.latePenaltyPerHour||1)*hoursLate);
}

/* ===== TASKS ===== */
const tasksListEl=$('#tasksList'),sortSel=$('#sortBy');
function dueToday(t){
  const kind=t.schedType||t.repeat||'daily';
  const now=new Date(); const dow=now.getDay();
  if(kind==='daily')return true;
  if(kind==='once'){ if(!t.date) return false; const d=new Date(t.date+'T00:00:00'); return d.toDateString()===new Date(nowYMD()).toDateString(); }
  if(kind==='weekly')return (t.dows||[]).includes(dow);
  if(kind==='monthly')return now.getDate()===(t.dayOfMonth||1);
  if(kind==='yearly'){ if(!t.yearlyDate)return false; const yd=new Date(t.yearlyDate+'T00:00:00'); return yd.getDate()===now.getDate()&&yd.getMonth()===now.getMonth(); }
  return true;
}
function priorityWeight(p){return p==='high'?2:(p==='med'?1:0)}
function sortTasks(arr){const mode=sortSel.value;const a=arr.slice();if(mode==='status')a.sort((x,y)=>(x.done===y.done?0:(x.done?1:-1)));if(mode==='priority')a.sort((x,y)=>priorityWeight(y.priority)-priorityWeight(x.priority));if(mode==='title')a.sort((x,y)=>x.title.localeCompare(y.title,'pl'));if(mode==='zone')a.sort((x,y)=>(x.zone||'').localeCompare(y.zone||'','pl'));return a}
function ensureSub(t){if(!Array.isArray(t.sub))t.sub=[]}
function taskBadge(t){
  const pr=t.priority==='high'?'üî•':t.priority==='med'?'‚Ä¢':'‚Ä¶';
  const rep=(t.schedType||'daily');
  let spec='';
  if(rep==='weekly'&&(t.dows||[]).length) spec=` dni: ${(t.dows||[]).map(n=>['Nd','Pn','Wt','≈ör','Cz','Pt','So'][n]).join(' ')}`;
  if(rep==='monthly'&&t.dayOfMonth) spec=`, ${t.dayOfMonth}. dnia`;
  if(rep==='yearly'&&t.yearlyDate){ const d=new Date(t.yearlyDate+'T00:00:00'); spec=`, ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`; }
  const time=t.time?`, ${t.time}`:'';
  const zone=t.zone?` ‚Ä¢ ${t.zone}`:'';
  const skipped=t.skippedReason?` ‚Ä¢ üôà ${t.skippedReason}`:'';
  const pen = ` ‚Ä¢ ‚õî ${t.penalty??1}`;
  return `${pr} ${rep}${spec}${time}${zone} ‚Ä¢ ‚≠ê ${t.points}${pen}${skipped}`;
}
function toggleTask(p,t,checked){
  ensureSub(t);
  if(checked&&t.sub.length&&t.sub.some(s=>!s.done)){ alert('Najpierw odhacz pod-zadania.'); return; }
  if(!dueToday(t)){ t.done=checked; save(); return; }
  if(checked && !t.done){
    const late = latePenaltyForTask(p,t);
    const earn = Math.max(0,(t.points||1) - late);
    p.scoreToday += earn;
    t._lastEarn = earn;
    t.done = true;
  } else if(!checked && t.done){
    const back = (typeof t._lastEarn==='number') ? t._lastEarn : (t.points||1);
    p.scoreToday = Math.max(0, p.scoreToday - back);
    t.done = false;
    t._lastEarn = 0;
  }
}
function editTask(t){
  const p=currentPerson(); if(!guardAction(p,'editTask')) return;
  const nt=prompt('Nazwa:',t.title); if(nt) t.title=nt.trim();
  const np=prompt('Punkty (‚≠ê):',String(t.points||1)); if(np!==null){ const v=parseInt(np,10); if(!isNaN(v)&&v>=0) t.points=v; }
  const npen=prompt('Kara gdy nie zrobione (‚≠ê):', String(t.penalty??1)); if(npen!==null){ const v=parseInt(npen,10); if(!isNaN(v)&&v>=0) t.penalty=v; }
  const pr=prompt('Priorytet (high/med/low):',t.priority||'med'); if(pr) t.priority=['high','med','low'].includes(pr)?pr:'med';
  const zn=prompt('Strefa:',t.zone||''); t.zone=zn?zn.trim():'';
  const tm=prompt('Godzina (HH:MM):',t.time||''); if(tm!==null && /^\d{2}:\d{2}$/.test(tm)) t.time=tm;
}
function markSkip(t){
  const p=currentPerson(); if(!guardAction(p,'skipTask')) return;
  showDialog(`<h3 style="margin-top:0">PominƒÖƒá zadanie?</h3>
    <p>Podaj kr√≥tki pow√≥d (np. choroba, wyjazd). Kara bƒôdzie mniejsza.</p>
    <input id="skipReason" type="text" placeholder="pow√≥d"/>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeDialog()">Anuluj</button>
      <button class="btn" onclick="applySkip()">üôà Pomi≈Ñ</button>
    </div>`);
  window.applySkip=function(){
    const r=($('#skipReason').value||'').trim()||'usprawiedliwione';
    t.skippedReason=r; closeDialog(); save(); renderTasks();
  }
}
function addSubUI(container,t,p){
  const box=document.createElement('div'); box.className='subtasks';
  (t.sub||[]).forEach(s=>{
    const line=document.createElement('div'); line.className='row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!s.done;
    cb.onchange=()=>{ if(!guardAction(p,'toggleSubtask')){ cb.checked=!cb.checked; return; } s.done=cb.checked; save(); renderTasks(); };
    const lab=document.createElement('label'); lab.textContent=s.title;
    line.appendChild(cb); line.appendChild(lab); box.appendChild(line);
  });
  const add=document.createElement('div'); add.className='row subAdd';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Dodaj pod-zadanie';
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='‚ûï';
  btn.onclick=()=>{ if(!guardAction(p,'addSubtask')) return; const v=inp.value.trim(); if(!v) return; (t.sub=t.sub||[]).push({id:crypto.randomUUID(),title:v,done:false}); inp.value=''; save(); renderTasks(); };
  add.appendChild(inp); add.appendChild(btn);
  container.appendChild(box); container.appendChild(add);
}
function renderTasks(){
  const p=currentPerson(); if(!p) return;
  personTitleEl.textContent = `‚Äî ${p.name}`;
  tasksListEl.innerHTML = '';
  if(!p.tasks.length){ tasksListEl.innerHTML='<div class="muted">Brak zada≈Ñ. Dodaj co≈õ po prawej.</div>'; return; }
  const arr=sortTasks(p.tasks);
  arr.forEach(t=>{
    const row=document.createElement('div'); row.className='task'+(t.done?' done':''); row.draggable=true;
    row.addEventListener('dragstart', e=>{ if(!guardAction(p,'dragTask')){ e.preventDefault(); return; } e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id, personId:p.id})); });
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!t.done; cb.style.transform='scale(1.2)';
    cb.onchange=()=>{ // odhaczanie dozwolone dziecku
                      toggleTask(p,t,cb.checked); save(); renderAllCore(); };
    const label=document.createElement('label');
    label.innerHTML = `<strong class="editable" contenteditable="true" spellcheck="false">${t.title}</strong><br><small>${taskBadge(t)} ${dueToday(t)?'':"<span style='color:var(--warn)'> (nie dzi≈õ)</span>"}</small>`;
    const titleEl = label.querySelector('.editable');
    titleEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); titleEl.blur(); }});
    titleEl.addEventListener('blur', ()=>{ if(!guardAction(p,'renameTask')){ titleEl.textContent=t.title; return; } const v = titleEl.textContent.trim(); if(v && v !== t.title){ t.title = v; save(); renderTasks(); } else { titleEl.textContent = t.title; } });

    const actions=document.createElement('div'); actions.className='actions';
    const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='‚úèÔ∏è'; editBtn.onclick=()=>{ editTask(t); save(); renderTasks(); };
    const skipBtn=document.createElement('button'); skipBtn.className='btn'; skipBtn.textContent='üôà'; skipBtn.title='Pomi≈Ñ z powodem'; skipBtn.onclick=()=>{ markSkip(t); };
    const icsBtn=document.createElement('button'); icsBtn.className='btn'; icsBtn.textContent='üìÜ'; icsBtn.title='.ics tego zadania'; icsBtn.onclick=()=>{ if(!guardAction(p,'taskIcs')) return; icsForTask(p,t) };
    const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='üóëÔ∏è'; delBtn.onclick=()=>{ if(!guardAction(p,'deleteTask')) return;
      if(confirm('UsunƒÖƒá zadanie?')){ p.tasks=p.tasks.filter(x=>x.id!==t.id); save(); renderAllCore(); } };
    actions.appendChild(editBtn); actions.appendChild(skipBtn); actions.appendChild(icsBtn); actions.appendChild(delBtn);
    row.appendChild(cb); row.appendChild(label); row.appendChild(actions);
    addSubUI(row, t, p);
    tasksListEl.appendChild(row);
  });
}

/* ===== PLANNER VIS ===== */
function refreshPlannerVis(){
  const v=$('#planType').value;
  const show=(id,on)=>{ const el=$(id.startsWith('#')?id:'#'+id); if(el) el.style.display=on?'flex':'none'; };
  show('weeklyPicker', v==='weekly'); show('oncePicker', v==='once'); show('monthlyPicker', v==='monthly'); show('yearlyPicker', v==='yearly');
}
$('#planType').addEventListener('change', refreshPlannerVis); refreshPlannerVis();
function addTask(){
  const p=currentPerson(); if(!p) return;
  if(!guardAction(p,'addTask')) return;
  const title=$('#taskTitle').value.trim(); if(!title){ alert('Podaj nazwƒô zadania.'); return; }
  const plan=$('#planType').value, time=$('#taskTime').value||'07:00', priority=$('#taskPriority').value||'med';
  const points=Math.max(0, parseInt($('#taskPoints').value||'1',10));
  const penalty=Math.max(0, parseInt($('#taskPenalty').value||'1',10));
  const zone=$('#taskZone').value||'';
  const remN=Math.max(0, parseInt($('#remNum').value||'10',10)); const remUnit=$('#remUnit').value||'minutes';
  const t={ id:crypto.randomUUID(), title, schedType:plan, time, points, penalty, priority, zone, done:false, sub:[], remN, remUnit };
  if(plan==='once'){ t.date=$('#taskDate').value||''; if(!t.date) return alert('Wybierz datƒô.'); }
  if(plan==='weekly'){ t.dows = $$('#weeklyPicker input:checked').map(el=>parseInt(el.value,10)); if(!t.dows.length) return alert('Zaznacz dni tygodnia.'); }
  if(plan==='monthly'){ t.dayOfMonth = clamp(parseInt($('#dayOfMonth').value||'1',10)||1,1,31); }
  if(plan==='yearly'){ t.yearlyDate=$('#yearlyDate').value||''; if(!t.yearlyDate) return alert('Wybierz datƒô w roku.'); }
  p.tasks.push(t);
  $('#taskTitle').value=''; $('#taskPoints').value='1'; $('#taskPenalty').value='1'; $$('#weeklyPicker input:checked').forEach(el=>el.checked=false);
  save(); renderAllCore();
}

/* ===== DAY/WEEK END ===== */
function endDay(){
  const pAsk=currentPerson(); if(!guardAction(pAsk,'endDay')) return;
  const date = nowYMD();
  db.people.forEach(p=>{
    let penaltySum=0, allDone=true, zones={};
    p.tasks.forEach(t=>{
      if(dueToday(t)){
        if(!t.done){
          const base = Math.round(t.penalty ?? 1);
          const skipCut = t.skippedReason ? 0.5 : 1;
          penaltySum += Math.round(base*skipCut);
          allDone = false;
        } else {
          zones[t.zone||'Inne'] = (zones[t.zone||'Inne']||0) + (t.points||0);
        }
        // Zadania tygodniowe: odznacz po dniu, ≈ºeby nie zostawa≈Çy "na sta≈Çe"
        t.done=false;
        t.skippedReason = '';
      }
    });
    p.scoreToday = Math.max(0, p.scoreToday - penaltySum);
    p.scoreWeek += p.scoreToday;
    /* PATCH: dopiszemy te≈º do puli og√≥lnej (nie kasuje siƒô w endWeek) */
    p.bank = Math.max(0, (p.bank||0) + p.scoreToday);
    p.streak = allDone ? (p.streak||0)+1 : 0;
    db.history.push({date, personId:p.id, earned:p.scoreToday, missed:penaltySum, zonePoints:zones});
    p.scoreToday = 0;
  });
  save(); renderAll();
}
function endWeek(){ const p=currentPerson(); if(!guardAction(p,'endWeek')) return; db.people.forEach(p=> p.scoreWeek=0 ); save(); renderAll(); }

/* ===== SZYBKIE KOREKTY ===== */
function manualDelta(sign){
  const p=currentPerson(); if(!p) return;
  if(!guardAction(p,'manualDelta')) return;
  const val = Math.max(1, parseInt($('#deltaPoints').value||'1',10));
  const scope = $('#deltaScope').value;
  const reason = prompt(sign>0?'Pow√≥d nagrody (+)':'Pow√≥d kary (‚àí):','');
  if(scope==='today'){ p.scoreToday = Math.max(0, (p.scoreToday||0) + sign*val); }
  else { p.scoreWeek = Math.max(0, (p.scoreWeek||0) + sign*val); }
  db.history.push({date:nowYMD(), personId:p.id, manual:true, delta:sign*val, scope, reason:reason||''});
  save(); renderScores(); renderTabs();
}

/* ===== SUMMARY / EXPORT / TTS / ICS ===== */
function tasksForSummary(p){
  const lines=[]; lines.push(`Lista ‚Äî ${new Date().toLocaleDateString('pl-PL')} (${p.name})`);
  if(!p.tasks.length){ lines.push('‚Äî brak'); return lines; }
  p.tasks.forEach(t=>{
    const box=t.done?'[x]':'[ ]';
    const rep=t.schedType||'daily';
    const zone=t.zone?` ‚Ä¢ ${t.zone}`:'';
    const onlyIf=dueToday(t)?'':' (nie dzi≈õ)';
    const sub=(t.sub||[]).length?` ‚Äî sub: ${(t.sub||[]).map(s=> (s.done?'[x] ':'[ ] ')+s.title).join(' | ')}`:'';
    const days=(t.schedType==='weekly'&&(t.dows||[]).length)?' '+(t.dows||[]).map(n=>['Nd','Pn','Wt','≈ör','Cz','Pt','So'][n]).join(' '):'';
    lines.push(`  ${box} ${t.title} (${rep}${days}${zone}, ‚≠ê ${t.points} ‚Ä¢ ‚õî ${t.penalty??1})${onlyIf}${sub}`);
  });
  return lines;
}
function summaryText(){const lines=[]; db.people.forEach(p=> lines.push(...['', ...tasksForSummary(p)])); return lines.join('\n').replace(/^\n/,'');}
function sendMail(){ const p=currentPerson(); if(!guardAction(p,'sendMail')) return; const body=encodeURIComponent(summaryText());const subj=encodeURIComponent('ObowiƒÖzki ‚Äî podsumowanie'); location.href=`mailto:?subject=${subj}&body=${body}`;}
async function copyToClipboard(){ const p=currentPerson(); if(!guardAction(p,'copySummary')) return; try{ await copy(summaryText()); alert('Skopiowano.'); }catch(e){ prompt('Kopiuj rƒôcznie:', summaryText()); } }
function icsDate(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`; }
function triggerDuration(n,u){ n=Math.max(0,parseInt(n||0,10)); if(u==='minutes')return`-PT${n}M`; if(u==='hours')return`-PT${n}H`; if(u==='days')return`-P${n}D`; if(u==='weeks')return`-P${n}W`; if(u==='months')return`-P${n*30}D`; if(u==='years')return`-P${n*365}D`; return '-PT10M'; }
function nextOccurrence(t){
  const now=new Date(); const {H,M}=hmToParts(t.time||'07:00'); const base=new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, 0);
  const k=t.schedType||'daily';
  if(k==='once'){ if(!t.date) return base; const d=new Date(t.date+'T00:00:00'); d.setHours(H,M,0,0); return d; }
  if(k==='daily'){ return base>now?base:new Date(base.getTime()+86400000); }
  if(k==='weekly'){
    const dows=(t.dows||[]).length?(t.dows||[]):[now.getDay()];
    for(let i=0;i<7;i++){ const test=new Date(now.getFullYear(),now.getMonth(),now.getDate()+i,H,M,0); if(dows.includes(test.getDay()) && test>now) return test; }
    const d=new Date(base); d.setDate(d.getDate()+7); return d;
  }
  if(k==='monthly'){ const dom=Math.min(Math.max(1,t.dayOfMonth||1),28); let d=new Date(now.getFullYear(),now.getMonth(),dom,H,M,0); if(d<=now) d=new Date(now.getFullYear(),now.getMonth()+1,dom,H,M,0); return d; }
  if(k==='yearly'){ if(!t.yearlyDate) return base>now?base:new Date(now.getFullYear()+1, now.getMonth(), now.getDate(), H,M,0);
    const yd=new Date(t.yearlyDate+'T00:00:00'); let d=new Date(now.getFullYear(),yd.getMonth(),yd.getDate(),H,M,0); if(d<=now) d=new Date(now.getFullYear()+1,yd.getMonth(),yd.getDate(),H,M,0); return d; }
  return base;
}
async function icsForTask(person,task){
  const when=nextOccurrence(task);
  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
  const body=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//HomeChores//Task//PL','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`,`DTSTAMP:${icsDate(new Date())}Z`,`DTSTART:${icsDate(when)}`,`DTEND:${icsDate(new Date(when.getTime()+30*60*1000))}`,
    `SUMMARY:${esc('ObowiƒÖzki ‚Äî '+person.name)}`,`DESCRIPTION:${esc('Zadanie: '+task.title+'\\n‚≠ê '+task.points)}`,
    'BEGIN:VALARM',`TRIGGER:${triggerDuration(task.remN||10,task.remUnit||'minutes')}`,'ACTION:DISPLAY','DESCRIPTION:Przypomnienie ‚Äî zadanie','END:VALARM',
    'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const file=new File([body],`zadanie-${person.name}-${when.toISOString().slice(0,10)}.ics`,{type:'text/calendar'});
  if(navigator.canShare&&navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file], title:`Zadanie ‚Äî ${person.name}`}); }catch(e){} }
  else { const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url); }
}
function makeICSForPerson(p,when){
  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
  const lines=tasksForSummary(p).join('\n');
  const body=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//HomeChores//PRO3//PL','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`, `DTSTAMP:${icsDate(new Date())}Z`, `DTSTART:${icsDate(when)}`, `DTEND:${icsDate(new Date(when.getTime()+30*60*1000))}`,
    `SUMMARY:${esc('ObowiƒÖzki ‚Äî '+p.name)}`, `DESCRIPTION:${esc(lines)}`,
    'BEGIN:VALARM','TRIGGER:-PT10M','ACTION:DISPLAY','DESCRIPTION:Przypomnienie ‚Äî obowiƒÖzki','END:VALARM',
    'END:VEVENT','END:VCALENDAR'].join('\r\n');
  return new File([body], `obowiazki-${p.name}-${when.toISOString().slice(0,10)}.ics`, {type:'text/calendar'});
}
async function shareICSForCurrentPerson(){
  const p=currentPerson(); if(!p) return; if(!guardAction(p,'personIcs')) return;
  const [H,M]=(p.icsTime||'07:00').split(':').map(x=>parseInt(x,10));
  const now=new Date(); const when=new Date(now.getFullYear(), now.getMonth(), now.getDate(), H||7, M||0, 0);
  const file = makeICSForPerson(p, when);
  if(navigator.canShare&&navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file], title:`ObowiƒÖzki ‚Äî ${p.name}`}); }catch(e){} }
  else { const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(a.href); }
}
function exportJSON(){ const p=currentPerson(); if(!guardAction(p,'exportJSON')) return; const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='obowiazki-backup.json'; a.click(); URL.revokeObjectURL(a.href); }
function importJSONFromFile(file){ const p=currentPerson(); if(!guardAction(p,'importJSON')) return; const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(r.result); db=j; save(); renderAll(); alert('Zaimportowano.'); }catch(e){ alert('Nieprawid≈Çowy JSON.'); } }; r.readAsText(file); }

/* === TTS === */
function speakNow(){
  const p=currentPerson(); if(!p) return;
  const titles = p.tasks.filter(dueToday).map(t=>t.title);
  const text = titles.length ? `Plan dnia dla ${p.name}: ` + titles.join('. ') + '.' : `${p.name} ‚Äî dzi≈õ brak zada≈Ñ.`;
  const u=new SpeechSynthesisUtterance(text); u.lang='pl-PL'; u.rate=1; u.pitch=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ===== WEEK VIEW ===== */
const weekNames=['Nd','Pn','Wt','≈ör','Cz','Pt','So'];
function renderWeek(){
  const host=$('#weekGrid'); host.innerHTML='';
  for(let d=1; d<=7; d++){
    const dow=d%7;
    const cell=document.createElement('div'); cell.className='day';
    cell.innerHTML=`<h4 title="PrzeciƒÖgnij zadanie">${weekNames[dow]}</h4><div class="drop"></div>`;
    const drop=cell.querySelector('.drop');
    cell.addEventListener('dragover',e=>e.preventDefault());
    cell.addEventListener('drop',e=>{
      e.preventDefault();
      const p=currentPerson(); if(!guardAction(p,'dragTask')) return;
      try{
        const data=JSON.parse(e.dataTransfer.getData('text/plain'));
        const pp=db.people.find(x=>x.id===data.personId);
        const t=pp?.tasks.find(x=>x.id===data.taskId);
        if(pp&&t){
          t.schedType='weekly';
          t.dows = Array.from(new Set([...(t.dows||[]), dow]));
          save(); renderAllCore();
        }
      }catch(_){}
    });
    host.appendChild(cell);
  }
  db.people.forEach(p=>{
    p.tasks.forEach(t=>{
      const days = (t.schedType==='weekly'&&(t.dows||[]).length)? t.dows : (t.schedType==='daily'?[1,2,3,4,5,6,0]:[]);
      days.forEach(d=>{
        const target=host.children[[1,2,3,4,5,6,0].indexOf(d)]?.querySelector('.drop');
        if(!target) return;
        const pill=document.createElement('div'); pill.className='pill'; pill.textContent=`${p.name}: ${t.title}`; pill.title=t.title;
        pill.draggable=true;
        pill.addEventListener('dragstart', e=>{ if(!guardAction(currentPerson(),'dragTask')){ e.preventDefault(); return; } e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id, personId:p.id})); });
        target.appendChild(pill);
      });
    });
  });
}

/* ===== LEADERBOARD & STATS ===== */
function renderLeaderboard(){
  /* PATCH: dodany ‚ÄûBank (‚≠ê)‚Äù w tabeli i wierszach */
  const rows=[`<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px">Domownik</th><th style="text-align:left;padding:6px">üî• Streak</th><th style="text-align:left;padding:6px">Tydzie≈Ñ (‚≠ê)</th><th style="text-align:left;padding:6px">Dzi≈õ</th><th style="text-align:left;padding:6px">Bank (‚≠ê)</th><th style="text-align:left;padding:6px">‚è∞ .ics</th></tr>`];
  [...db.people].sort((a,b)=> b.scoreWeek-a.scoreWeek || (b.streak||0)-(a.streak||0)).forEach(p=>{
    rows.push(`<tr><td style="padding:6px">${p.name}${p.childMode?' üë∂':''}</td><td style="padding:6px">${p.streak||0}</td><td style="padding:6px">${p.scoreWeek}</td><td style="padding:6px">${p.scoreToday}</td><td style="padding:6px">${p.bank||0}</td><td style="padding:6px">${p.icsTime||'07:00'}</td></tr>`);
  });
  $('#leaderboard').innerHTML = rows.join('');
}

function renderHeat(){
  const cvs=$('#heat'), ctx=cvs.getContext('2d'), W=cvs.width, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const cols=7, rows=6, pad=12, cw=(W-pad*2)/cols, ch=(H-pad*2)/rows;
  const map={}; const last=new Date();
  for(let i=0;i<42;i++){ const d=new Date(last.getFullYear(), last.getMonth(), last.getDate()-i); map[d.toISOString().slice(0,10)]=0; }
  db.history.forEach(h=>{
    if(h.date in map){
      const add = (typeof h.earned === 'number') ? h.earned : ((h.delta>0) ? h.delta : 0);
      map[h.date] += add;
    }
  });
  const keys=Object.keys(map).sort(); const vals=Object.values(map); const max=Math.max(1,...vals);
  let idx=0; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const k=keys[idx++]; const v=map[k]||0; const x=pad+c*cw, y=pad+r*ch, a=v/max; ctx.fillStyle=`rgba(10,132,255,${0.15+0.75*a})`; ctx.fillRect(x+3,y+3,cw-6,ch-6); } }
}
function renderTopZones(){
  const list=$('#topZones'); list.innerHTML='';
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-30);
  const agg={};
  db.history.forEach(h=>{
    if(new Date(h.date)>=cutoff){
      const zp=h.zonePoints||{};
      Object.entries(zp).forEach(([z,v])=> agg[z]=(agg[z]||0)+v );
    }
  });
  const top=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(!top.length){ list.innerHTML='<li class="muted">Brak danych jeszcze.</li>'; return; }
  top.forEach(([z,v])=>{ const li=document.createElement('li'); li.textContent=`${z}: ${v}‚≠ê`; list.appendChild(li); });
}

/* ===== PEOPLE SETTINGS ===== */
function setGoal(){const p=currentPerson(); if(!p)return; if(!guardAction(p,'setGoal')) return; const g=prompt('Cel dzienny (informacyjny):', String(p.goal||goalForToday(p))); if(g!==null){ const v=Math.max(0,parseInt(g,10)||0); p.goal=v; save(); renderScores(); }}
function setIcs(){const p=currentPerson();if(!p)return; if(!guardAction(p,'setIcs')) return; const cur=p.icsTime||'07:00';const t=prompt('Godzina .ics (HH:MM, 24h):',cur);if(!t)return;if(!/^\d{2}:\d{2}$/.test(t))return alert('Format HH:MM');p.icsTime=t;save();renderLeaderboard()}
function pinDialog(){
  const p = currentPerson();
  if(!p) return;

  showDialog(
`<h3 style="margin-top:0">PIN i Tryb dziecka ‚Äî ${p.name}</h3>
 <div class="row" style="flex-direction:column;align-items:stretch">
   ${p.pin ? '<label class="muted">Obecny PIN (wymagany do zmiany)</label><input id="pinOld" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />' : ''}
   <label class="muted" style="margin-top:${p.pin? '8px':'0'}">Nowy PIN (4‚Äì8 cyfr)</label>
   <input id="pinSet" type="password" placeholder="${p.pin?'(zmie≈Ñ)':'(ustaw)'}"/>
   <label class="muted" style="margin-top:8px">Tryb dziecka (blokada zmian)</label>
   <div class="row">
     <button class="btn" onclick="setChildMode(true)">üë∂ W≈ÇƒÖcz</button>
     <button class="btn" onclick="setChildMode(false)">üîì Wy≈ÇƒÖcz</button>
   </div>
 </div>
 <div class="row" style="justify-content:flex-end;margin-top:10px">
   <button class="btn" onclick="closeDialog()">Zamknij</button>
   <button class="btn" onclick="savePin()">‚úÖ Zapisz PIN</button>
 </div>`
  );

  window.savePin = function(){
    const newPin = ($('#pinSet').value||'').trim();
    if (p.pin){ // zmiana istniejƒÖcego
      const old = ($('#pinOld')?.value||'').trim();
      if (old !== p.pin){ alert('Z≈Çy obecny PIN.'); return; }
    }
    if (!/^\d{4,8}$/.test(newPin)){ alert('PIN 4‚Äì8 cyfr.'); return; }
    p.pin = newPin;
    save(); alert('Zapisano PIN.'); closeDialog();
  };

  window.setChildMode = function(on){
    if (p.pin){
      const entered = prompt('Podaj PIN:');
      if (entered !== p.pin){ alert('Z≈Çy PIN.'); return; }
    }
    p.childMode = !!on;
    save(); renderTabs();
    alert(on ? 'Tryb dziecka W≈ÅƒÑCZONY.' : 'Tryb dziecka WY≈ÅƒÑCZONY.');
  };
}



/* ===== WIDOK ZAKUP√ìW ===== */
function shoppingPeopleOptions(){ const arr = ['‚Äî'].concat(db.people.map(p=>p.name)); return arr.map(n=>`<option value="${n}">${n}</option>`).join(''); }
function renderShoppingSelectors(){
  $('#shopSection').innerHTML = (db.shoppingSections||defaultShoppingSections).map(s=>`<option value="${s}">${s}</option>`).join('');
  $('#shopAssignee').innerHTML = shoppingPeopleOptions();
}
/* === Kategorie w ZAKUPACH (dodaj/usu≈Ñ) === */
function renderShoppingCatsSelect(){
  const sel = document.getElementById('shopCatsSelect');
  if (!sel) return;
  const list = (db.shoppingSections || defaultShoppingSections);
  sel.innerHTML = list.map(c => `<option value="${c}">${c}</option>`).join('');
}

function addShopSection(){
  const p = currentPerson(); if(!guardAction(p,'addShopSection')) return;
  const v = (document.getElementById('shopNewCat').value || '').trim();
  if(!v) return;
  db.shoppingSections = db.shoppingSections || defaultShoppingSections.slice();
  if(!db.shoppingSections.includes(v)) db.shoppingSections.push(v);
  document.getElementById('shopNewCat').value = '';
  save();
  renderShoppingSelectors();
  renderShoppingCatsSelect();
  renderShopping();      // od≈õwie≈º listƒô i chipsy
}

function delShopSection(){
  const p = currentPerson(); if(!guardAction(p,'delShopSection')) return;
  const sel = document.getElementById('shopCatsSelect');
  const val = sel ? sel.value : '';
  if(!val) return;
  if(!confirm(`UsunƒÖƒá kategoriƒô ‚Äû${val}‚Äù?`)) return;

  // Usu≈Ñ z listy kategorii
  db.shoppingSections = (db.shoppingSections || defaultShoppingSections).filter(x => x !== val);

  // Przepnij istniejƒÖce pozycje na ‚ÄûInne‚Äù
  (db.shopping || []).forEach(it => {
    if((it.section || 'Inne') === val) it.section = 'Inne';
  });

  save();
  renderShoppingSelectors();
  renderShoppingCatsSelect();
  renderShopping();
}

  function addShoppingItem(){
  const p=currentPerson(); if(!guardAction(p,'addShoppingItem')) return;
  const title = $('#shopTitle').value.trim();
  if(!title){ alert('Podaj nazwƒô pozycji.'); return; }
  const qty = $('#shopQty').value.trim();
  const section = $('#shopSection').value || 'Inne';
  const who = $('#shopAssignee').value || '‚Äî';
  const prio = $('#shopPriority').value || 'med';
  const item = { id:crypto.randomUUID(), title, qty, section, assignee:who, priority:prio, done:false, createdAt: Date.now() };
  db.shopping = db.shopping || [];
  db.shopping.push(item);
  $('#shopTitle').value=''; $('#shopQty').value='';
  save(); renderShopping();
}
function toggleShoppingItem(id, on){
  const it = (db.shopping||[]).find(x=>x.id===id);
  if(!it) return;
  it.done = !!on;
  save(); renderShopping();
}
function removeShoppingItem(id){
  const p=currentPerson(); if(!guardAction(p,'removeShoppingItem')) return;
  if(!confirm('UsunƒÖƒá pozycjƒô z listy?')) return;
  db.shopping = (db.shopping||[]).filter(x=>x.id!==id);
  save(); renderShopping();
}
function clearBought(){ const p=currentPerson(); if(!guardAction(p,'clearBought')) return; db.shopping = (db.shopping||[]).filter(x=>!x.done); save(); renderShopping(); }
async function exportShoppingText(){ try{ await copy((db.shopping||[]).map(x=>`${x.done?'[x]':'[ ]'} ${x.title}${x.qty?` √ó ${x.qty}`:''} (${x.section})`).join('\n')); alert('Skopiowano listƒô.'); }catch(_){ prompt('Kopiuj rƒôcznie:', (db.shopping||[]).map(x=>`${x.done?'[x]':'[ ]'} ${x.title}`).join('\n')); } }

/* Przyciski kategorii i grupowanie listy */
let shopActiveCat = 'Wszystko';
function renderShopCats(){
  const cats=['Wszystko', ...(db.shoppingSections||defaultShoppingSections)];
  const host=$('#shopCats'); host.innerHTML='';
  cats.forEach(c=>{
    const b=document.createElement('button'); b.className='chip'+(c===shopActiveCat?' active':''); b.textContent=c;
    b.onclick=()=>{ shopActiveCat=c; renderShopping(); };
    host.appendChild(b);
  });
}
function groupBy(arr, key){ return arr.reduce((acc,x)=>((acc[x[key]||'Inne']=acc[x[key]||'Inne']||[]).push(x),acc),{}); }
function renderShopping(){
  renderShoppingSelectors();
  renderShopCats();
  const host = $('#shopListContainer');
  host.innerHTML = '';

  let items = (db.shopping||[]).slice().sort((a,b)=>{
    const done = (a.done===b.done)?0:(a.done?1:-1); if(done!==0) return done;
    const pmap={high:0,med:1,low:2}; const pr=(pmap[a.priority]??1)-(pmap[b.priority]??1); if(pr!==0) return pr;
    const sec=(a.section||'').localeCompare(b.section||'','pl'); if(sec!==0) return sec;
    return (a.title||'').localeCompare(b.title||'','pl');
  });

  if(shopActiveCat && shopActiveCat!=='Wszystko'){
    items = items.filter(x => (x.section||'Inne') === shopActiveCat);
  }

  const grouped = groupBy(items, 'section');
  Object.keys(grouped).sort((a,b)=>a.localeCompare(b,'pl')).forEach(sec=>{
    const box=document.createElement('div');
    box.className='exp-section';
    const head=document.createElement('div'); head.className='exp-head';
    head.innerHTML=`<div><b>${sec}</b></div><div class="muted">${grouped[sec].filter(x=>!x.done).length} otwartych</div>`;
    box.appendChild(head);
    grouped[sec].forEach(x=>{
      const row=document.createElement('div'); row.className='shop-item'+(x.done?' shop-done':'');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!x.done; cb.onchange=()=>toggleShoppingItem(x.id, cb.checked);
      const title=document.createElement('div'); title.style.flex='1'; title.innerHTML = `<b>${x.title}</b>${x.qty?` <span class="muted">√ó ${x.qty}</span>`:''}<br><small class="muted">${x.section||'Inne'}${x.assignee&&x.assignee!=='‚Äî'?` ‚Ä¢ ${x.assignee}`:''}${x.priority==='high'?' ‚Ä¢ üî•':''}</small>`;
      const del=document.createElement('button'); del.className='btn'; del.textContent='üóëÔ∏è'; del.onclick=()=>removeShoppingItem(x.id);
      row.appendChild(cb); row.appendChild(title); row.appendChild(del);
      box.appendChild(row);
    });
    host.appendChild(box);
  });
}

/* ===== WYDATKI ===== */
function renderExpenseSelectors(){
  $('#expSection').innerHTML = (db.expenseSections||defaultExpenseSections).map(s=>`<option value="${s}">${s}</option>`).join('');
  $('#expCatsSelect').innerHTML = (db.expenseSections||defaultExpenseSections).map(s=>`<option value="${s}">${s}</option>`).join('');
  const d = $('#expDate'); if(d && !d.value){ d.value = nowYMD(); }

  // (NOWE) wype≈Çnienie wyboru roku oraz ustawienie M/Y z localStorage
  const monthSel = document.getElementById('expFilterMonth');
  const yearSel  = document.getElementById('expFilterYear');
  if (yearSel && !yearSel.options.length) {
    const ys = expYearsRange();
    yearSel.innerHTML = ys.map(y=>`<option value="${y}">${y}</option>`).join('');
  }
  const {month, year} = getExpSelectedMonthYear();
  if (monthSel) monthSel.value = String(month);
  if (yearSel)  yearSel.value  = String(year);
}

function addExpense(){
  const p=currentPerson(); if(!guardAction(p,'addExpense')) return;
  const title = $('#expTitle').value.trim();
  const amount = parseFloat($('#expAmount').value.replace(',','.'));
  const section = $('#expSection').value || 'Inne';
  const date = $('#expDate').value || nowYMD();
  if(!title || isNaN(amount)){ alert('Podaj nazwƒô i kwotƒô.'); return; }
  db.expenses = db.expenses || [];
  db.expenses.push({ id:crypto.randomUUID(), title, amount:Math.max(0,amount), section, date });
  $('#expTitle').value=''; $('#expAmount').value='';
  save(); renderExpenses();
}
function delExpense(id){
  const p=currentPerson(); if(!guardAction(p,'delExpense')) return;
  db.expenses = (db.expenses||[]).filter(x=>x.id!==id);
  save(); renderExpenses();
}
function addExpenseCat(){
  const p=currentPerson(); if(!guardAction(p,'addExpenseCat')) return;
  const v=$('#expNewCat').value.trim(); if(!v) return;
  if(!db.expenseSections.includes(v)) db.expenseSections.push(v);
  $('#expNewCat').value='';
  save(); renderExpenses();
}
function delExpenseCat(){
  const p=currentPerson(); if(!guardAction(p,'delExpenseCat')) return;
  const val=$('#expCatsSelect').value; if(!val) return;
  if(!confirm(`UsunƒÖƒá kategoriƒô ‚Äû${val}‚Äù?`)) return;
  db.expenseSections = (db.expenseSections||[]).filter(x=>x!==val);
  // przepnij wydatki na ‚ÄûInne‚Äù
  (db.expenses||[]).forEach(e=>{ if(e.section===val) e.section='Inne'; });
  save(); renderExpenses();
}
function sum(arr, sel=()=>true, map=v=>v){ return arr.filter(sel).reduce((a,x)=>a+map(x),0); }
function money(n){ return (n||0).toLocaleString('pl-PL',{style:'currency',currency:'PLN'}); }
function isSameMonth(d1,d2){ const a=new Date(d1), b=new Date(d2); return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth(); }
function renderExpenses(){
  renderExpenseSelectors();
  const hostList = $('#expList');
  const tbody = $('#expMonthByCat');
  const monthLabel = $('#expMonthLabel');
  hostList.innerHTML=''; tbody.innerHTML='';

  // (NOWE) ‚Äî bierzemy MIESIƒÑC/ROK z selektor√≥w (zapamiƒôtywanych)
  const target = expTargetDate();
  const thisMonth = (db.expenses||[]).filter(e=>isSameMonth(e.date, target));
  const monthTotal = sum(thisMonth, ()=>true, e=>e.amount);
  $('#expMonthTotal').textContent = money(monthTotal);
  monthLabel.textContent = expMonthLabel(target);

  // Suma per kategoria (dla wybranego miesiƒÖca)
  const cats = db.expenseSections||defaultExpenseSections;
  cats.forEach(c=>{
    const s = sum(thisMonth, e=> (e.section||'Inne')===c, e=>e.amount);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c}</td><td>${money(s)}</td>`;
    tbody.appendChild(tr);
  });

  // Lista wszystkich (ostatnie 60 dni), grupowana po kategorii ‚Äì bez zmian logicznych
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-60);
  const recent = (db.expenses||[]).filter(e=> new Date(e.date) >= cutoff)
                                  .sort((a,b)=> (a.section||'').localeCompare(b.section||'','pl') || (b.date||'').localeCompare(a.date||''));
  const grouped = groupBy(recent, 'section');
  Object.keys(grouped).sort((a,b)=>a.localeCompare(b,'pl')).forEach(sec=>{
    const box=document.createElement('div'); box.className='exp-section';
    const total = sum(grouped[sec], ()=>true, e=>e.amount);
    const head=document.createElement('div'); head.className='exp-head';
    head.innerHTML=`<div><b>${sec}</b></div><div class="exp-total">${money(total)}</div>`;
    box.appendChild(head);

    grouped[sec].forEach(e=>{
      const row=document.createElement('div'); row.className='shop-item';
      const meta=`<small class="muted">${e.date} ‚Ä¢ ${e.section}</small>`;
      row.innerHTML=`<div style="flex:1"><b>${e.title}</b><br>${meta}</div><div style="min-width:100px;text-align:right"><b>${money(e.amount)}</b></div>`;
      const del=document.createElement('button'); del.className='btn'; del.textContent='üóëÔ∏è'; del.onclick=()=>delExpense(e.id);
      row.appendChild(del);
      box.appendChild(row);
    });

    hostList.appendChild(box);
  });
}


/* ===== RENDER ROOT ===== */
function renderLeaderboardAndStats(){renderLeaderboard();renderHeat();renderTopZones()}
function renderAllCore(){
  renderTabs();renderZones();renderShop();renderTasks();renderScores();renderWeek();renderLeaderboardAndStats();
  if (document.getElementById('view-shopping').style.display!=='none') renderShopping();
  if (document.getElementById('view-expenses').style.display!=='none') renderExpenses();
}
function renderAll(){renderDate();renderAllCore()}

/* ===== BINDINGS ===== */
$('#addPersonBtn').onclick=addPerson;$('#renamePersonBtn').onclick=renamePerson;$('#removePersonBtn').onclick=removePerson;$('#setGoalBtn').onclick=setGoal;$('#setIcsBtn').onclick=setIcs;$('#pinBtn').onclick = () => {
  const p = currentPerson();
  if (!guardAction(p, 'pinSettings')) return; // wymusi PIN w trybie dziecka
  pinDialog();
};

$('#addTaskBtn').onclick=addTask;$('#resetDailyBtn').onclick=()=>{const p=currentPerson(); if(!guardAction(p,'resetDaily')) return; db.people.forEach(pp=>pp.tasks.forEach(t=>{if((t.schedType||'daily')==='daily')t.done=false}));save();renderTasks()};
$('#clearDoneBtn').onclick=()=>{const p=currentPerson(); if(!guardAction(p,'clearDone')) return; const cp=currentPerson();cp.tasks=cp.tasks.filter(t=>!((t.schedType==='once'||t.repeat==='once')&&t.done));save();renderTasks()};
$('#mailBtn').onclick=sendMail;$('#copyBtn').onclick=copyToClipboard;$('#icsBtn').onclick=shareICSForCurrentPerson;$('#ttsBtn').onclick=speakNow;$('#remindersBtn').onclick=()=>{const p=currentPerson(); if(!guardAction(p,'remindersExport')) return; const payload={date:nowYMD(),people:db.people.map(p=>({name:p.name,items:p.tasks.filter(dueToday).map(t=>({title:t.title,time:t.time||'07:00',zone:t.zone||'',points:t.points||1}))}))};const text='CHORES_PAYLOAD\n'+JSON.stringify(payload);copy(text).then(()=>{location.href='shortcuts://run-shortcut?name=Chores%20Import'}).catch(()=>alert('Skopiuj rƒôcznie:\n\n'+text))};
$('#exportBtn').onclick=exportJSON;$('#importBtn').onclick=()=>$('#importFile').click();$('#importFile').onchange=e=>{const f=e.target.files[0];if(f)importJSONFromFile(f)};
$('#exportCSVPersonBtn').onclick=()=>{const p=currentPerson(); if(!guardAction(p,'exportCSVPerson')) return; const header=['Osoba','Tytu≈Ç','Harmonogram','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];const rows=[header.join(',')];const cp=currentPerson();cp.tasks.forEach(t=>rows.push([cp.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),t.points||0,t.penalty??1,t.priority||'med',t.zone||'',t.done?'1':'0'].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(',')));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`obowiazki-${cp.name}.csv`;a.click();URL.revokeObjectURL(a.href)};
$('#exportCSVAllBtn').onclick=()=>{const p=currentPerson(); if(!guardAction(p,'exportCSVAll')) return; const header=['Osoba','Tytu≈Ç','Harmonogram','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];const rows=[header.join(',')];db.people.forEach(pp=>pp.tasks.forEach(t=>rows.push([pp.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),t.points||0,t.penalty??1,t.priority||'med',t.zone||'',t.done?'1':'0'].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(','))));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='obowiazki-wszyscy.csv';a.click();URL.revokeObjectURL(a.href)};
$('#endDayBtn').onclick=endDay;$('#endWeekBtn').onclick=endWeek;$('#sortBy').onchange=()=>renderTasks();
$('#addZoneBtn').onclick=addZone;$('#delZoneBtn').onclick=delZone;$('#randomZoneBtn').onclick=randomZone;
$('#deltaMinus').onclick=()=>manualDelta(-1);
$('#deltaPlus').onclick=()=>manualDelta(1);
document.getElementById('changeFamilyBtn').onclick = async () => {
  const curr = localStorage.getItem('familyId') || '';
  const next = prompt('ID rodziny (wsp√≥lna nazwa grupy):', curr);
  if (!next) return;
  await subscribeToFamily(next.trim());
  pushToFirebase();
};


/* THEME TOGGLE (jasny/ciemny + paleta UI) */
(function themeInit(){
  // Odczytaj poprzednie ustawienia
  const savedTheme   = localStorage.getItem('ui-theme')   || 'dark';
  const savedPalette = localStorage.getItem('ui-palette') || 'theme-slate'; // domy≈õlny motyw

  // Usu≈Ñ stare palety (gdyby by≈Çy)
  document.documentElement.classList.remove(
    'theme-ocean',
    'theme-forest',
    'theme-graphite',
    'theme-pastel',
    'theme-slate'
  );

  // Ustaw paletƒô
  document.documentElement.classList.add(savedPalette);

  // Ustaw jasny/ciemny
  if(savedTheme === 'light') document.documentElement.classList.add('light');
  else document.documentElement.classList.remove('light');

  // Znajd≈∫ przycisk
  const btn = document.getElementById('themeToggle');
  if(!btn) return;

  // Klik = zmiana jasny <-> ciemny
  btn.onclick = () => {
    document.documentElement.classList.toggle('light');
    const newTheme = document.documentElement.classList.contains('light') ? 'light' : 'dark';
    localStorage.setItem('ui-theme', newTheme);
  };
})();


/* SWIPE GESTURES FOR TASKS (mobile) */
(function enableSwipe(){
  let startX=0, startY=0, active=null, moved=false;
  const THRESH = 48, MAX = 96;
  function attach(row, onRight, onLeft){
    row.addEventListener('touchstart', (e)=>{
      startX = e.touches[0].clientX; startY = e.touches[0].clientY;
      active = row; moved=false; row.style.transition = 'none';
    }, {passive:true});
    row.addEventListener('touchmove', (e)=>{
      if(!active) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if(Math.abs(dy) > Math.abs(dx)) return;
      moved=true;
      const off = Math.max(-MAX, Math.min(MAX, dx));
      active.style.transform = `translateX(${off}px)`;
      active.style.opacity = String(1 - Math.min(0.35, Math.abs(off)/300));
    }, {passive:true});
    row.addEventListener('touchend', ()=>{
      if(!active) return;
      const matrixStr = getComputedStyle(active).transform;
      let off = 0;
      try{
        const m = window.DOMMatrix ? new DOMMatrix(matrixStr) : new WebKitCSSMatrix(matrixStr);
        off = m.m41 || 0;
      }catch(_){}
      active.style.transition = ''; active.style.transform = ''; active.style.opacity = '';
      const p=currentPerson();
      if(moved && off > THRESH){ onRight && onRight(); }
      else if(moved && off < -THRESH){
        onLeft && onLeft();
      }
      active=null; moved=false;
    });
  }
  const _origRenderTasks = renderTasks;
  renderTasks = function(){
    _origRenderTasks();
    const p = currentPerson(); if(!p) return;
    const rows = document.querySelectorAll('#tasksList .task');
    const tasks = p.tasks;
    rows.forEach((row, idx)=>{
      const cb = row.querySelector('input[type="checkbox"]');
      attach(row,
        ()=>{ if(cb){ cb.checked = true; cb.dispatchEvent(new Event('change')); } },
        ()=>{ if(!guardAction(p,'deleteTask')) return;
              if(confirm('UsunƒÖƒá zadanie?')){
                const id = tasks[idx]?.id;
                if(id){ p.tasks = p.tasks.filter(z=>z.id!==id); save(); renderAllCore(); }
              }
        }
      );
    });
  };
})();

/* Przenie≈õ ‚ÄûCzytaj teraz‚Äù do paska narzƒôdzi */
document.addEventListener('DOMContentLoaded', () => {
  const ttsBtn  = document.getElementById('ttsBtn');
  const taskToolbar = document.getElementById('taskToolbar');
  if (ttsBtn && taskToolbar) {
    taskToolbar.appendChild(ttsBtn);
    ttsBtn.style.marginLeft = '8px';
  }
});
// === MOTYWY: lista klas do prze≈ÇƒÖczania (kolejno≈õƒá = cykl) ===
const THEME_CLASSES = [
  'theme-ocean','theme-forest','theme-amber','theme-aurora','theme-graphite',
  'theme-denim','theme-moss','theme-rose','theme-slate','theme-cocoa'
];

function applyThemeClass(name){
  // usu≈Ñ stare klasy
  document.documentElement.classList.remove(...THEME_CLASSES);
  // dodaj nowƒÖ (je≈õli pusta, zostaje bazowy wyglƒÖd)
  if(name) document.documentElement.classList.add(name);
  localStorage.setItem('ui-theme-name', name || '');
}

(function themeNameInit(){
  // przywr√≥ƒá wybrany motyw z localStorage
  const savedName = localStorage.getItem('ui-theme-name') || '';
  applyThemeClass(savedName);

  // pod≈ÇƒÖcz przycisk üé®
  const cycleBtn = document.getElementById('themeCycleBtn');
  if(cycleBtn){
    cycleBtn.onclick = () => {
      const curr = localStorage.getItem('ui-theme-name') || '';
      const idx = Math.max(0, THEME_CLASSES.indexOf(curr));
      const next = THEME_CLASSES[(idx + 1) % THEME_CLASSES.length];
      applyThemeClass(next);
    };
  }
})();

/* ===== TABS ===== */
(function tabsInit(){
  const tabChores = document.getElementById('tabChores');
  const tabShopping = document.getElementById('tabShopping');
  const tabExpenses = document.getElementById('tabExpenses');
  const viewChores = document.getElementById('view-chores');
  const viewShopping = document.getElementById('view-shopping');
  const viewExpenses = document.getElementById('view-expenses');
// (NOWE) ‚Äî bindy do wyboru miesiƒÖca/roku i strza≈Çek w Wydatkach
const mSel = document.getElementById('expFilterMonth');
const ySel = document.getElementById('expFilterYear');
const prevBtn = document.getElementById('expPrevMonth');
const nextBtn = document.getElementById('expNextMonth');
const todayBtn = document.getElementById('expTodayBtn');

function applyExpFilterFromUI(){
  const m = parseInt(mSel.value, 10);
  const y = parseInt(ySel.value, 10);
  if(!isNaN(m) && !isNaN(y)){
    setExpSelectedMonthYear(m, y);
    renderExpenses();
  }
}

if (mSel) mSel.onchange = applyExpFilterFromUI;
if (ySel) ySel.onchange = applyExpFilterFromUI;

if (prevBtn) prevBtn.onclick = ()=>{ expShiftMonth(-1); renderExpenseSelectors(); renderExpenses(); };
if (nextBtn) nextBtn.onclick = ()=>{ expShiftMonth(1);  renderExpenseSelectors(); renderExpenses(); };
if (todayBtn) todayBtn.onclick = ()=>{
  const now = new Date();
  setExpSelectedMonthYear(now.getMonth(), now.getFullYear());
  renderExpenseSelectors(); renderExpenses();
};

  // zapisz PIN ‚Äì wymaga podania starego, je≈õli istnia≈Ç
  window.savePin = function(){
    const newPin = ($('#pinSet').value||'').trim();

    if (p.pin){ // zmiana istniejƒÖcego
      const old = ($('#pinOld')?.value||'').trim();
      if (old !== p.pin){ alert('Z≈Çy obecny PIN.'); return; }
    }

    if (!/^\d{4,8}$/.test(newPin)){ alert('PIN 4‚Äì8 cyfr.'); return; }
    if (p.pin && newPin === p.pin){ alert('Nowy PIN jest taki sam jak obecny.'); return; }

    p.pin = newPin;
    save(); alert('Zapisano PIN.'); closeDialog();
  };

  // w≈ÇƒÖcz/wy≈ÇƒÖcz tryb dziecka ‚Äì zawsze wymaga PIN-u, je≈õli jest ustawiony
  window.setChildMode = function(on){
    if (p.pin){
      const entered = prompt('Podaj PIN:') || '';
      if (entered !== p.pin){ alert('Z≈Çy PIN.'); return; }
    }
    p.childMode = !!on;
    save(); renderTabs();
    alert(on ? 'Tryb dziecka W≈ÅƒÑCZONY.' : 'Tryb dziecka WY≈ÅƒÑCZONY.');
  };
}


  // Zakupy ‚Äì bind przycisk√≥w
  document.getElementById('shopAddBtn').onclick = addShoppingItem;
  document.getElementById('shopClearDoneBtn').onclick = clearBought;
  document.getElementById('shopExportBtn').onclick = exportShoppingText;

// Zakupy ‚Äì bind przycisk√≥w
document.getElementById('shopAddBtn').onclick = addShoppingItem;
document.getElementById('shopClearDoneBtn').onclick = clearBought;
document.getElementById('shopExportBtn').onclick = exportShoppingText;

// (NOWE) ‚Äî bindy do kategorii zakup√≥w
const _shopAddCatBtn = document.getElementById('shopAddCatBtn');
const _shopDelCatBtn = document.getElementById('shopDelCatBtn');
if (_shopAddCatBtn) _shopAddCatBtn.onclick = addShopSection;
if (_shopDelCatBtn) _shopDelCatBtn.onclick = delShopSection;

  // Wydatki ‚Äì bind
  document.getElementById('expAddBtn').onclick = addExpense;
  document.getElementById('expAddCatBtn').onclick = addExpenseCat;
  document.getElementById('expDelCatBtn').onclick = delExpenseCat;
})();

/* ===== PWA SW ===== */
const skipSW = location.search.includes('nosw=1');
if('serviceWorker' in navigator && !skipSW){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ===== INIT ===== */
function hideSplash(){
  const el = document.getElementById('splash');
  if (el) el.remove();
}
document.addEventListener('DOMContentLoaded', () => {
  // Awaryjnie ustaw familyId i label zanim dotkniemy Firebase
  if (!localStorage.getItem('familyId')) {
    const prev = localStorage.getItem('familyId') || '';
    const fam = prompt('ID rodziny (np. rodzina-kowalscy) ‚Äî wsp√≥lna dla wszystkich urzƒÖdze≈Ñ:', prev || 'rodzina-demo');
    if (fam) {
      localStorage.setItem('familyId', String(fam).trim());
      setFamilyLabel(String(fam).trim());
    }
  }

  renderAll();
document.documentElement.dataset.view = 'chores';
tryFirebaseInit();
setTimeout(hideSplash, 200);
});

window.addEventListener('load', hideSplash);
</script>
</body>
</html>

