<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domowy organizer PRO</title>

<meta name="theme-color" content="#0a84ff"/>

<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<script src="https://cdn.tailwindcss.com"></script>

<script>window.process = window.process || { env: {} };</script>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
:root {
  --bg:#0f1113;
  --card:rgba(28,28,30,.72);
  --border:rgba(255,255,255,.08);
  --muted:#8e8e93;
  --text:#f5f5f7;
  --accent:#0a84ff;
  --ok:#30d158;
  --warn:#ffd60a;
  --danger:#ff453a;
  --shadow:0 8px 30px rgba(0,0,0,.35)
}

* { box-sizing:border-box }

body {
  margin:0;
  font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji";
  color:var(--text);
  background:radial-gradient(1200px 800px at 20% -10%,#1b1d20 0%,#0f1113 60%);
}

.wrap { max-width:1200px; margin:28px auto; padding:0 16px }

header {
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
}

.title { font-weight:800; font-size:1.25rem; display:flex; gap:10px; align-items:center; letter-spacing:.2px }

.dot { width:10px; height:10px; border-radius:50%; background:var(--ok); box-shadow:0 0 14px var(--ok) }

.subtitle { opacity:.85; color:var(--muted) }

.card {
  background:var(--card);
  border:1px solid var(--border);
  backdrop-filter:saturate(140%) blur(10px);
  border-radius:16px;
  padding:14px;
  box-shadow:var(--shadow);
}

.row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

button, .btn {
  border:1px solid var(--border);
  background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
  color:var(--text);
  padding:10px 14px;
  border-radius:12px;
  cursor:pointer;
  transition:transform .06s ease, box-shadow .18s ease, border-color .18s;
}

button:hover, .btn:hover {
  box-shadow:0 14px 30px -12px rgba(10,132,255,.45);
  border-color:rgba(99,102,241,.35);
}

button:active { transform:translateY(1px) }

input[type=text], input[type=number], input[type=time], input[type=date], input[type=password], select {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.04);
  color:var(--text);
  transition:border-color .2s, box-shadow .2s;
}

input:focus, select:focus {
  border-color:#8da2fb;
  box-shadow:0 0 0 4px rgba(99,102,241,.18);
}

/* NAPRAWA: przewijanie widoku tygodnia */
#weekGrid {
  max-height:420px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  padding-right:6px;
}

/* ZAK≈ÅADKI */
.top-tabs { display:flex; gap:6px }
.tab {
  padding:8px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.06);
  border:1px solid var(--border);
  cursor:pointer;
}
.tab.active {
  background:var(--accent);
  color:white;
}

/* Sekcje zakup√≥w / wydatk√≥w ‚Äì style kontener√≥w */
.shop-cat-strip { display:flex; gap:8px; overflow-x:auto; padding:6px 2px }

.shopItem {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  margin-bottom:8px;
}
</style>
</head>

<body>

<div class="wrap">

<header>
  <div class="title"><span class="dot"></span> Domowy organizer PRO</div>

  <div>
    <div class="subtitle" id="today"></div>
    <div class="subtitle">Rodzina: <strong id="familyLabel">‚Äî</strong></div>
  </div>

  <div class="row">
    <div class="top-tabs">
      <button id="tabChores" class="tab active">üß∫ ObowiƒÖzki</button>
      <button id="tabShopping" class="tab">üõí Zakupy</button>
      <button id="tabExpenses" class="tab">üí∞ Wydatki</button>
    </div>
    <button id="themeToggle" class="btn">‚òÄÔ∏è / üåô</button>
  </div>
</header>

<!-- ====== WIDOK OBOWIƒÑZK√ìW ====== -->
<div id="view-chores">
  <section class="card">
    <h3>Dodaj obowiƒÖzek</h3>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="taskName" type="text" placeholder="Nazwa obowiƒÖzku">
      <div class="row">
        <button class="btn" onclick="showAddTaskPopup()">Dodaj obowiƒÖzek ‚ûï</button>
      </div>
    </div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Twoje obowiƒÖzki</h3>
    <div id="tasksList"></div>
  </section>
</div>

<!-- POPUP OBOWIƒÑZK√ìW -->
<div id="addTaskPopup" class="popup">
  <div class="popup-content card">
    <h3>Nowy obowiƒÖzek</h3>
    <input type="text" id="popupTaskName" placeholder="Nazwa">
    <select id="popupTaskPerson"></select>
    <select id="popupTaskDay">
      <option value="daily">Codziennie</option>
      <option value="weekly">Raz w tygodniu</option>
      <option value="monthly">Raz w miesiƒÖcu</option>
    </select>

    <div class="row">
      <button class="btn" onclick="confirmAddTask()">Dodaj</button>
      <button class="btn" onclick="closeAddTaskPopup()">Anuluj</button>
    </div>
  </div>
</div>

<!-- ====== WIDOK ZAKUP√ìW ====== -->
<div id="view-shopping" style="display:none">
  <section class="card">
    <h3>Dodaj produkt</h3>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="shoppingName" type="text" placeholder="Nazwa produktu">
      <select id="shoppingCategory"></select>
      <button id="addShoppingBtn" class="btn">Dodaj ‚ûï</button>
    </div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Kategorie produkt√≥w</h3>
    <div class="row">
      <input id="newShopCat" type="text" placeholder="Nowa kategoria">
      <button id="addShopCatBtn" class="btn">‚ûï</button>
      <button id="delShopCatBtn" class="btn">üóëÔ∏è</button>
    </div>
    <div id="shopCategories" class="shop-cat-strip"></div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Do kupienia</h3>
    <div id="shoppingList"></div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Kupione</h3>
    <div id="shoppingBoughtList"></div>
  </section>
</div>

<!-- ====== WIDOK WYDATK√ìW ====== -->
<div id="view-expenses" style="display:none">

  <section class="card">
    <h3>Dodaj wydatek</h3>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="expenseAmount" type="number" min="0" step="0.01" placeholder="Kwota">
      <select id="expenseCategory"></select>
      <select id="expensePerson"></select>
      <button id="addExpenseBtn" class="btn">Dodaj ‚ûï</button>
    </div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Kategorie wydatk√≥w</h3>
    <div class="row">
      <input id="newExpenseCat" type="text" placeholder="Nowa kategoria">
      <button id="addExpenseCatBtn" class="btn">‚ûï</button>
      <button id="delExpenseCatBtn" class="btn">üóëÔ∏è</button>
    </div>
    <div id="expenseCategories" class="shop-cat-strip"></div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Podsumowanie miesiƒÖca</h3>
    <div class="row" style="flex-direction:column;gap:6px">
      <strong>≈ÅƒÖcznie:</strong> <span id="expenseTotal">0.00</span> z≈Ç
      <ul id="expenseCategoryTotals" style="margin:0;padding-left:18px"></ul>
    </div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3>Lista wydatk√≥w</h3>
    <div id="expenseList"></div>
  </section>

</div>

<!-- END PART 1 -->
<script>
/* ---------- AWARYJNY RESET: ?reset=1 lub #reset ---------- */
(function(){
  if (location.search.includes('reset=1') || location.hash === '#reset') {
    try {
      localStorage.removeItem('familyId');
      localStorage.removeItem('home-chores-pro3-full');
      if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    } finally {
      alert('Zresetowano dane i cache. ≈Åadujƒô ponownie‚Ä¶');
      location.replace(location.pathname);
    }
  }
})();

/* ===== UTIL ===== */
const $=s=>document.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const todayEl=$('#today'); function fmtDate(d){return d.toLocaleDateString('pl-PL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function nowYMD(){const d=new Date();return d.toISOString().slice(0,10)}
function hmToParts(hm='07:00'){const [H,M]=hm.split(':').map(n=>parseInt(n,10));return{H:isNaN(H)?7:H,M:isNaN(M)?0:M}}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function copy(text){return navigator.clipboard.writeText(text)}
function showDialog(html){$('#dialog').innerHTML=html;$('#overlay').style.display='flex'}
function closeDialog(){ $('#overlay').style.display='none' }

/* ===== FIREBASE (opcjonalny) ===== */
let fbApp=null, fs=null, fbDoc=null, __unsub=null;
const FIREBASE_COLLECTION = 'organizer';
function setFamilyLabel(id){ const l=document.getElementById('familyLabel'); if(l) l.textContent=id || '‚Äî'; }

async function subscribeToFamily(id){
  if(!fs || !id) return;
  id = String(id).trim();
  localStorage.setItem('familyId', id);
  setFamilyLabel(id);

  if (__unsub) { try{ __unsub(); }catch(_){ } __unsub=null; }
  fbDoc = fs.collection(FIREBASE_COLLECTION).doc(id);

  __unsub = fbDoc.onSnapshot((snap)=>{
    const data = snap.data();
    if(!data || !data.payload) return;
    try{
      const payload = (typeof data.payload === 'string') ? JSON.parse(data.payload) : data.payload;
      if(!payload) return;

      const local = (()=>{ try { return JSON.parse(localStorage.getItem(stateKey)||'{}'); } catch { return {}; }})();
      const cloudMillis = data.updatedAt?.toMillis?.() ?? payload.updatedAt ?? 0;
      const localMillis = local.updatedAt ?? 0;

      if (!localMillis || cloudMillis > localMillis) {
        db = payload;
        localStorage.setItem(stateKey, JSON.stringify(db));
        renderAll();
      }
    }catch(e){ console.warn('Snapshot parse error', e); }
  }, (err)=>console.error('onSnapshot error', err));
}

async function tryFirebaseInit(){
  try{
    if(!window.firebaseConfig || !window.firebaseConfig.apiKey) return;
    if(!firebase.apps?.length){ fbApp = firebase.initializeApp(window.firebaseConfig); }
    firebase.appCheck().activate("6LffMAQsAAAAAHaO0TzmnQHwSA3SPNOxJOOIFCk1", true);

    fs = firebase.firestore();

    let family = localStorage.getItem('familyId');
    if(!family){
      const prev = localStorage.getItem('familyId') || '';
      family = prompt('ID rodziny (np. rodzina-kowalscy) ‚Äî wsp√≥lna dla wszystkich urzƒÖdze≈Ñ:', prev || 'rodzina-demo');
      if(!family) return;
      family = String(family).trim();
      localStorage.setItem('familyId', family);
    }
    setFamilyLabel(family);

    await subscribeToFamily(family);
    pushToFirebase();
  }catch(e){ console.warn('Firebase init error', e); }
}

async function pushToFirebase(){
  if(!fbDoc) return;
  try{
    const payloadStr = JSON.stringify(db);
    const snap = await fbDoc.get();
    if (snap.exists) {
      const data = snap.data() || {};
      const cloud = (typeof data.payload==='string') ? JSON.parse(data.payload) : (data.payload||{});
      const cloudMillis = data.updatedAt?.toMillis?.() ?? cloud.updatedAt ?? 0;
      const localMillis = db.updatedAt ?? 0;

      if (localMillis && localMillis <= cloudMillis) return;
    }
    await fbDoc.set(
      { payload: payloadStr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge:true }
    );
  }catch(e){
    console.error('[Firestore] zapis ERROR', e);
    alert('B≈ÇƒÖd zapisu do Firestore: ' + (e?.message || e));
  }
}

/* ===== STATE ===== */
const stateKey='home-chores-pro3-full';

const defaultZones=['Kuchnia','Salon','≈Åazienka','Sypialnia','Korytarz'];
const defaultRewards=[
  {id:crypto.randomUUID(),name:'Seans filmu',cost:20},
  {id:crypto.randomUUID(),name:'Godzina gry',cost:25}
];
const defaultShoppingSections=['Jedzenie','Szko≈Ça','Praca','Przyjemno≈õci','Chemia','Kosmetyki','Samoch√≥d','Inne'];

const defaultData={
  zones:defaultZones,
  rewards:defaultRewards,
  shopping: [],
  shoppingSections: defaultShoppingSections,
  people:[
    {id:crypto.randomUUID(),name:'Ja',goal:5,streak:0,icsTime:'07:00',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[
      {id:crypto.randomUUID(),title:'Wyrzuciƒá ≈õmieci',schedType:'daily',time:'07:00',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]},
      {id:crypto.randomUUID(),title:'Nakarmiƒá kota',schedType:'daily',time:'07:10',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]}
    ]},
    {id:crypto.randomUUID(),name:'Ania',goal:5,streak:0,icsTime:'07:10',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[
      {id:crypto.randomUUID(),title:'Zmywarka ‚Äî roz≈Çaduj',schedType:'daily',time:'07:30',points:2,penalty:1,priority:'high',zone:'Kuchnia',done:false,sub:[]},
      {id:crypto.randomUUID(),title:'Podlaƒá kwiaty',schedType:'weekly',dows:[3],time:'18:00',points:2,penalty:1,priority:'low',zone:'Salon',done:false,sub:[]}
    ]}
  ],
  currentPersonId:null,
  penaltyFactor:1,
  history:[],
  updatedAt: Date.now()
};

function load(){try{return JSON.parse(localStorage.getItem(stateKey))||defaultData}catch(e){return defaultData}}
function save(){ db.updatedAt=Date.now(); localStorage.setItem(stateKey,JSON.stringify(db)); pushToFirebase(); }

let db=load();
if(!db.currentPersonId && db.people.length) db.currentPersonId=db.people[0].id;

/* ==== HEADER / TABS ==== */
function renderDate(){ todayEl.textContent = fmtDate(new Date()); }

function currentPerson(){ return db.people.find(p=>p.id===db.currentPersonId)||db.people[0]; }

const tabsEl=$('#peopleTabs');
function renderTabs(){
  tabsEl.innerHTML='';
  db.people.forEach(p=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=`${p.name} ¬∑ ‚≠ê ${p.scoreWeek} ¬∑ üî• ${p.streak||0}${p.childMode?' ¬∑ üë∂':''}`;
    b.onclick=()=>{db.currentPersonId=p.id;save();renderAll()};
    tabsEl.appendChild(b);
  });
}

function addPerson(){
  const name=prompt('Imiƒô domownika:');
  if(!name)return;
  db.people.push({
    id:crypto.randomUUID(),name:name.trim(),goal:5,streak:0,
    icsTime:'07:00',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,
    pin:'',childMode:false,tasks:[]
  });
  db.currentPersonId=db.people.at(-1).id;
  save(); renderAll();
}

function renamePerson(){
  const p=currentPerson(); if(!p)return;
  const n=prompt('Nowa nazwa:',p.name);
  if(!n)return;
  p.name=n.trim();
  save(); renderTabs();
}

function removePerson(){
  const p=currentPerson(); if(!p)return;
  if(!confirm(`UsunƒÖƒá osobƒô ‚Äû${p.name}‚Äù?`))return;
  db.people=db.people.filter(x=>x.id!==p.id);
  db.currentPersonId=db.people[0]?.id||null;
  save(); renderAll();
}

/* ==== ZONES ==== */
function renderZones(){
  $('#taskZone').innerHTML=db.zones.map(z=>`<option value="${z}">${z}</option>`).join('');
  $('#zonesSelect').innerHTML=db.zones.map(z=>`<option>${z}</option>`).join('');

  const badges=$('#zonesBadges');
  badges.innerHTML='';
  db.zones.forEach(z=>{
    const t=document.createElement('span');
    t.className='zoneTag';
    t.textContent=z;
    badges.appendChild(t);
  });
}

function addZone(){
  const z=$('#newZone').value.trim();
  if(!z)return;
  if(!db.zones.includes(z)) db.zones.push(z);
  $('#newZone').value='';
  save();
  renderZones();
}

function delZone(){
  const val=$('#zonesSelect').value;
  if(!val)return;
  if(!confirm(`UsunƒÖƒá strefƒô ‚Äû${val}‚Äù?`))return;
  db.zones=db.zones.filter(z=>z!==val);
  save(); renderZones();
}

function randomZone(){
  if(!db.zones.length) return alert('Brak stref');
  alert('üé≤ Dzisiejsza strefa: '+db.zones[Math.floor(Math.random()*db.zones.length)]);
}

/* ==== SKLEPIK ==== */
function renderShop(){
  const host=$('#shopList');
  host.innerHTML='';
  const p=currentPerson(); if(!p)return;

  db.rewards.forEach(r=>{
    const row=document.createElement('div');
    row.className='shopItem';
    row.innerHTML=`<div>${r.name} ‚Äî <b>${r.cost}‚≠ê</b></div>`;

    const box=document.createElement('div');
    box.style.display='flex'; box.style.gap='6px';

    const btn=document.createElement('button');
    btn.className='btn';
    btn.textContent='Zrealizuj';
    btn.onclick=()=>{
      if(p.childMode){alert('Tryb dziecka ‚Äî zablokowane');return}
      if(p.scoreWeek<r.cost){alert('Za ma≈Ço ‚≠ê');return}
      showDialog(`
        <h3 style="margin-top:0">Potwierd≈∫ nagrodƒô</h3>
        <p>${p.name} wymienia <b>${r.cost}‚≠ê</b> na ‚Äû${r.name}‚Äù. Kontynuowaƒá?</p>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" onclick="closeDialog()">Anuluj</button>
          <button class="btn" onclick="redeem('${r.id}')">‚úÖ OK</button>
        </div>
      `);
    };

    const del=document.createElement('button');
    del.className='btn';
    del.textContent='üóëÔ∏è';
    del.onclick=()=>{
      if(!confirm(`UsunƒÖƒá nagrodƒô ‚Äû${r.name}‚Äù?`))return;
      db.rewards=db.rewards.filter(x=>x.id!==r.id);
      save(); renderShop();
    };

    box.appendChild(btn);
    box.appendChild(del);
    row.appendChild(box);
    host.appendChild(row);
  });
}

function redeem(id){
  const p=currentPerson();
  const r=db.rewards.find(x=>x.id===id);
  if(!p||!r)return;
  p.scoreWeek-=r.cost;
  if(p.scoreWeek<0)p.scoreWeek=0;

  db.history.push({date:nowYMD(),personId:p.id,reward:r.name});
  save(); closeDialog(); renderScores(); renderTabs();
}

/* ==== SCORES ==== */
const personTitleEl=$('#personTitle'),
      todayScoreEl=$('#todayScore'),
      weekScoreEl=$('#weekScore'),
      goalScoreEl=$('#goalScore'),
      goalBarEl=$('#goalBar'),
      leaderboardEl=$('#leaderboard');

function goalForToday(p){
  return p.tasks.filter(dueToday).length;
}

function renderScores(){
  const p=currentPerson(); if(!p)return;

  todayScoreEl.textContent=p.scoreToday||0;
  weekScoreEl.textContent=p.scoreWeek||0;

  const g=Math.max(0,goalForToday(p));
  goalScoreEl.textContent=g;

  const perc=g?clamp(Math.round(100*(p.scoreToday||0)/g),0,100):0;
  goalBarEl.style.width=perc+'%';
}

/* ==== TASKS ==== */
const tasksListEl=$('#tasksList'), sortSel=$('#sortBy');

function dueToday(t){
  const kind=t.schedType||t.repeat||'daily';
  const now=new Date();
  const dow=now.getDay();

  if(kind==='daily')return true;

  if(kind==='once'){
    if(!t.date)return false;
    return (new Date(t.date+'T00:00:00')).toDateString()===new Date(nowYMD()).toDateString();
  }

  if(kind==='weekly') return (t.dows||[]).includes(dow);
  if(kind==='monthly') return now.getDate()===(t.dayOfMonth||1);
  if(kind==='yearly'){
    if(!t.yearlyDate)return false;
    const yd=new Date(t.yearlyDate+'T00:00:00');
    return yd.getDate()===now.getDate()&&yd.getMonth()===now.getMonth();
  }

  return true;
}

function priorityWeight(p){
  return p==='high'?2:(p==='med'?1:0);
}

function sortTasks(arr){
  const mode=sortSel.value;
  const a=arr.slice();

  if(mode==='status')a.sort((x,y)=>(x.done===y.done?0:(x.done?1:-1)));
  if(mode==='priority')a.sort((x,y)=>priorityWeight(y.priority)-priorityWeight(x.priority));
  if(mode==='title')a.sort((x,y)=>x.title.localeCompare(y.title,'pl'));
  if(mode==='zone')a.sort((x,y)=>(x.zone||'').localeCompare(y.zone||'','pl'));

  return a;
}

function toggleTask(p,t,checked){
  if(checked && t.sub?.some(s=>!s.done)){ alert('Najpierw odhacz pod-zadania.'); return; }

  if(!dueToday(t)){
    t.done=checked;
    save();
    return;
  }

  if(checked && !t.done){
    const earn = Math.max(0,(t.points||1));
    p.scoreToday+=earn;
    t.done=true;
  } else if(!checked && t.done){
    p.scoreToday=Math.max(0,p.scoreToday-(t.points||1));
    t.done=false;
  }
}

function ensureSub(t){ if(!Array.isArray(t.sub)) t.sub=[]; }

function taskBadge(t){
  const pr=t.priority==='high'?'üî•':t.priority==='med'?'‚Ä¢':'‚Ä¶';
  const rep=t.schedType||'daily';

  let spec='';
  if(rep==='weekly'&&(t.dows||[]).length)
    spec=` dni: ${(t.dows||[]).map(n=>['Nd','Pn','Wt','≈ör','Cz','Pt','So'][n]).join(' ')}`;
  if(rep==='monthly'&&t.dayOfMonth) spec=`, ${t.dayOfMonth}. dnia`;
  if(rep==='yearly'&&t.yearlyDate){
    const d=new Date(t.yearlyDate+'T00:00:00');
    spec=`, ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
  }

  const time=t.time?`, ${t.time}`:'';
  const zone=t.zone?` ‚Ä¢ ${t.zone}`:'';
  const pen=` ‚Ä¢ ‚õî ${t.penalty??1}`;
  const skipped=t.skippedReason?` ‚Ä¢ üôà ${t.skippedReason}`:'';

  return `${pr} ${rep}${spec}${time}${zone} ‚Ä¢ ‚≠ê ${t.points}${pen}${skipped}`;
}

function editTask(t){
  const nt=prompt('Nazwa:',t.title); if(nt)t.title=nt.trim();
  const np=prompt('Punkty (‚≠ê):',String(t.points||1));
  if(np!==null){
    const v=parseInt(np,10);
    if(!isNaN(v)&&v>=0)t.points=v;
  }
  const npen=prompt('Kara gdy nie zrobione:',String(t.penalty??1));
  if(npen!==null){
    const v=parseInt(npen,10);
    if(!isNaN(v)&&v>=0)t.penalty=v;
  }
  const pr=prompt('Priorytet (high/med/low):',t.priority||'med');
  if(pr)t.priority=['high','med','low'].includes(pr)?pr:'med';
  const zn=prompt('Strefa:',t.zone||'');
  t.zone=zn?zn.trim():'';
  const tm=prompt('Godzina (HH:MM):',t.time||'');
  if(tm!==null && /^\d{2}:\d{2}$/.test(tm))t.time=tm;
}

function markSkip(t){
  showDialog(`
    <h3 style="margin-top:0">PominƒÖƒá zadanie?</h3>
    <p>Podaj pow√≥d.</p>
    <input id="skipReason" type="text" placeholder="pow√≥d"/>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeDialog()">Anuluj</button>
      <button class="btn" onclick="applySkip()">üôà Pomi≈Ñ</button>
    </div>
  `);
  window.applySkip=function(){
    t.skippedReason=$('#skipReason').value.trim()||'usprawiedliwione';
    closeDialog(); save(); renderTasks();
  };
}

function addSubUI(container,t,p){
  const box=document.createElement('div');
  box.className='subtasks';

  (t.sub||[]).forEach(s=>{
    const line=document.createElement('div'); line.className='row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!s.done;
    cb.onchange=()=>{s.done=cb.checked; save(); renderTasks();};
    const lab=document.createElement('label'); lab.textContent=s.title;
    line.appendChild(cb); line.appendChild(lab);
    box.appendChild(line);
  });

  const add=document.createElement('div');
  add.className='row subAdd';

  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Dodaj pod-zadanie';
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='‚ûï';
  btn.onclick=()=>{
    const v=inp.value.trim();
    if(!v)return;
    (t.sub=t.sub||[]).push({id:crypto.randomUUID(),title:v,done:false});
    inp.value=''; save(); renderTasks();
  };

  add.appendChild(inp); add.appendChild(btn);
  container.appendChild(box); container.appendChild(add);
}

function renderTasks(){
  const p=currentPerson(); if(!p)return;
  personTitleEl.textContent=`‚Äî ${p.name}`;

  tasksListEl.innerHTML='';
  if(!p.tasks.length){
    tasksListEl.innerHTML='<div class="muted">Brak zada≈Ñ.</div>';
    return;
  }

  const arr=sortTasks(p.tasks);
  arr.forEach(t=>{
    const row=document.createElement('div');
    row.className='task'+(t.done?' done':'');
    row.draggable=true;

    row.addEventListener('dragstart',e=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id, personId:p.id}));
    });

    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!t.done;
    cb.style.transform='scale(1.2)';
    cb.onchange=()=>{
      if(p.childMode){cb.checked=!cb.checked;alert('Tryb dziecka');return}
      toggleTask(p,t,cb.checked); save(); renderAllCore();
    };

    const label=document.createElement('label');
    label.innerHTML = `
      <strong class="editable" contenteditable="true">${t.title}</strong><br>
      <small>${taskBadge(t)} ${dueToday(t)?'':"<span style='color:var(--warn)'> (nie dzi≈õ)</span>"}</small>
    `;
    const titleEl=label.querySelector('.editable');
    titleEl.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); titleEl.blur();}});
    titleEl.addEventListener('blur',()=>{
      const v=titleEl.textContent.trim();
      if(v && v!==t.title){ t.title=v; save(); renderTasks(); }
      else titleEl.textContent=t.title;
    });

    const actions=document.createElement('div');
    actions.className='actions';

    const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='‚úèÔ∏è';
    editBtn.onclick=()=>{ if(p.childMode){alert('Tryb dziecka');return} editTask(t); save(); renderTasks(); };

    const skipBtn=document.createElement('button'); skipBtn.className='btn'; skipBtn.textContent='üôà';
    skipBtn.onclick=()=>{ if(p.childMode){alert('Tryb dziecka');return} markSkip(t); };

    const icsBtn=document.createElement('button'); icsBtn.className='btn'; icsBtn.textContent='üìÜ';
    icsBtn.onclick=()=>icsForTask(p,t);

    const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='üóëÔ∏è';
    delBtn.onclick=()=>{
      if(p.childMode){alert('Tryb dziecka');return}
      if(confirm('UsunƒÖƒá zadanie?')){
        p.tasks=p.tasks.filter(x=>x.id!==t.id);
        save(); renderAllCore();
      }
    };

    actions.appendChild(editBtn);
    actions.appendChild(skipBtn);
    actions.appendChild(icsBtn);
    actions.appendChild(delBtn);

    row.appendChild(cb);
    row.appendChild(label);
    row.appendChild(actions);

    addSubUI(row,t,p);

    tasksListEl.appendChild(row);
  });
}

/* ==== PLAN PICKERS ==== */
function refreshPicker(){
  const v=$('#planType').value;
  const show=(id,on)=>{const el=document.getElementById(id); if(el) el.style.display=on?'flex':'none';};
  show('weeklyPicker', v==='weekly');
  show('oncePicker', v==='once');
  show('monthlyPicker', v==='monthly');
  show('yearlyPicker', v==='yearly');
}
$('#planType').addEventListener('change',refreshPicker);
refreshPicker();

/* ==== ADD TASK ==== */
function addTask(){
  const p=currentPerson(); if(!p)return;
  if(p.childMode){alert('Tryb dziecka'); return;}

  const title=$('#taskTitle').value.trim(); if(!title){alert('Podaj nazwƒô'); return;}
  const plan=$('#planType').value, time=$('#taskTime').value||'07:00';
  const zone=$('#taskZone').value||'';
  const priority=$('#taskPriority').value||'med';
  const points=parseInt($('#taskPoints').value||'1',10)||0;
  const penalty=parseInt($('#taskPenalty').value||'1',10)||0;

  const t={id:crypto.randomUUID(),title,schedType:plan,time,zone,priority,points,penalty,done:false,sub:[]};

  if(plan==='once'){
    t.date=$('#taskDate').value;
    if(!t.date)return alert('Wybierz datƒô');
  }
  if(plan==='weekly'){
    t.dows = $$('#weeklyPicker input:checked').map(el=>parseInt(el.value,10));
    if(!t.dows.length)return alert('Zaznacz dni tygodnia');
  }
  if(plan==='monthly'){
    t.dayOfMonth=clamp(parseInt($('#dayOfMonth').value||'1',10),1,31);
  }
  if(plan==='yearly'){
    t.yearlyDate=$('#yearlyDate').value;
    if(!t.yearlyDate)return alert('Wybierz datƒô');
  }

  p.tasks.push(t);

  $('#taskTitle').value='';
  $('#taskPoints').value='1';
  $('#taskPenalty').value='1';

  $$('#weeklyPicker input:checked').forEach(el=>el.checked=false);

  save(); renderAllCore();
}

/* ==== END DAY/WEEK ==== */
function endDay(){
  const date=nowYMD();

  db.people.forEach(p=>{
    let penaltySum=0, allDone=true;

    p.tasks.forEach(t=>{
      if(dueToday(t)){
        if(!t.done){
          const base=t.penalty??1;
          const cut=t.skippedReason?0.5:1;
          penaltySum+=Math.round(base*cut);
          allDone=false;
        }
        if(t.schedType!=='weekly') t.done=false;
        t.skippedReason='';
      }
    });

    p.scoreToday=Math.max(0,p.scoreToday-penaltySum);
    p.scoreWeek+=p.scoreToday;
    p.streak = allDone? (p.streak||0)+1 : 0;

    db.history.push({date,personId:p.id,earned:p.scoreToday,missed:penaltySum});
    p.scoreToday=0;
  });

  save(); renderAll();
}

function endWeek(){
  db.people.forEach(p=>p.scoreWeek=0);
  save(); renderAll();
}

/* ==== DELTA ==== */
function manualDelta(sign){
  const p=currentPerson(); if(!p)return;

  const val=Math.max(1,parseInt($('#deltaPoints').value||'1',10));
  const scope=$('#deltaScope').value;
  const reason=prompt(sign>0?'Pow√≥d nagrody:':'Pow√≥d kary:','');

  if(scope==='today') p.scoreToday=Math.max(0,p.scoreToday+sign*val);
  else p.scoreWeek=Math.max(0,p.scoreWeek+sign*val);

  db.history.push({date:nowYMD(),personId:p.id,manual:true,delta:sign*val,scope,reason});
  save(); renderScores(); renderTabs();
}

/* ==== SUMMARY / EXPORT ==== */
function tasksForSummary(p){
  const lines=[];
  lines.push(`Lista ‚Äî ${new Date().toLocaleDateString('pl-PL')} (${p.name})`);
  if(!p.tasks.length){lines.push('‚Äî brak'); return lines;}

  p.tasks.forEach(t=>{
    const box=t.done?'[x]':'[ ]';
    const rep=t.schedType||'daily';
    const zone=t.zone?` ‚Ä¢ ${t.zone}`:'';
    const sub=(t.sub||[]).length?` ‚Äî sub: ${(t.sub||[])
      .map(s=> (s.done?'[x] ':'[ ] ')+s.title).join(' | ')}`:'';
    lines.push(`  ${box} ${t.title} (${rep}${zone}, ‚≠ê${t.points})${sub}`);
  });

  return lines;
}

function summaryText(){
  const lines=[];
  db.people.forEach(p=> lines.push('', ...tasksForSummary(p)));
  return lines.join('\n').replace(/^\n/,'');
}

function sendMail(){
  const body=encodeURIComponent(summaryText());
  const subj=encodeURIComponent('ObowiƒÖzki ‚Äî podsumowanie');
  location.href=`mailto:?subject=${subj}&body=${body}`;
}

async function copyToClipboard(){
  try{await copy(summaryText()); alert('Skopiowano');}
  catch(e){ prompt('Kopiuj rƒôcznie:',summaryText()); }
}

/* ==== ICS ==== */
function icsDate(d){
  const pad=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`;
}

function nextOccurrence(t){
  const now=new Date();
  const {H,M}=hmToParts(t.time||'07:00');
  const base=new Date(now.getFullYear(),now.getMonth(),now.getDate(),H,M,0);

  const k=t.schedType||'daily';

  if(k==='once'){
    if(!t.date)return base;
    const d=new Date(t.date+'T'+(t.time||'07:00'));
    return d;
  }
  if(k==='daily') return base>now?base:new Date(base.getTime()+86400000);

  if(k==='weekly'){
    const dows=t.dows?.length?t.dows:[now.getDay()];
    for(let i=0;i<7;i++){
      const test=new Date(now.getFullYear(),now.getMonth(),now.getDate()+i,H,M,0);
      if(dows.includes(test.getDay()) && test>now)return test;
    }
    const d=new Date(base); d.setDate(d.getDate()+7); return d;
  }

  if(k==='monthly'){
    const dom=Math.min(Math.max(1,t.dayOfMonth||1),28);
    let d=new Date(now.getFullYear(),now.getMonth(),dom,H,M,0);
    if(d<=now) d=new Date(now.getFullYear(),now.getMonth()+1,dom,H,M,0);
    return d;
  }

  if(k==='yearly'){
    if(!t.yearlyDate)return base;
    const yd=new Date(t.yearlyDate+'T00:00:00');
    let d=new Date(now.getFullYear(),yd.getMonth(),yd.getDate(),H,M,0);
    if(d<=now) d=new Date(now.getFullYear()+1,yd.getMonth(),yd.getDate(),H,M,0);
    return d;
  }

  return base;
}

async function icsForTask(person,task){
  const when=nextOccurrence(task);

  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');

  const body=[
    'BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`,`DTSTAMP:${icsDate(new Date())}`,
    `DTSTART:${icsDate(when)}`,
    `DTEND:${icsDate(new Date(when.getTime()+30*60000))}`,
    `SUMMARY:${esc(task.title)}`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');

  const file=new File([body],`zadanie-${person.name}.ics`,{type:'text/calendar'});
  const url=URL.createObjectURL(file);

  const a=document.createElement('a');
  a.href=url; a.download=file.name; a.click();
  URL.revokeObjectURL(url);
}

function makeICSForPerson(p,when){
  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');

  const lines=tasksForSummary(p).join('\n');

  const body=[
    'BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`,
    `DTSTAMP:${icsDate(new Date())}`,
    `DTSTART:${icsDate(when)}`,
    `DTEND:${icsDate(new Date(when.getTime()+30*60000))}`,
    `SUMMARY:${esc('ObowiƒÖzki ‚Äî '+p.name)}`,
    `DESCRIPTION:${esc(lines)}`,
    'END:VEVENT','END:VCALENDAR'
  ].join('\r\n');

  return new File([body],`obowiazki-${p.name}.ics`,{type:'text/calendar'});
}

async function shareICSForCurrentPerson(){
  const p=currentPerson(); if(!p)return;
  const [H,M]=(p.icsTime||'07:00').split(':').map(Number);
  const now=new Date();
  const when=new Date(now.getFullYear(),now.getMonth(),now.getDate(),H||7,M||0,0);

  const file=makeICSForPerson(p,when);
  const url=URL.createObjectURL(file);

  const a=document.createElement('a');
  a.href=url; a.download=file.name; a.click();
  URL.revokeObjectURL(url);
}

/* ==== EXPORT JSON ==== */
function exportJSON(){
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='backup.json';
  a.click();
}

/* ==== IMPORT JSON ==== */
function importJSONFromFile(file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const j=JSON.parse(r.result);
      db=j;
      save(); renderAll();
      alert('Zaimportowano.');
    }catch(e){
      alert('Nieprawid≈Çowy JSON');
    }
  };
  r.readAsText(file);
}

/* ==== TTS ==== */
function speakNow(){
  const p=currentPerson(); if(!p)return;

  const titles=p.tasks.filter(dueToday).map(t=>t.title);
  const text=titles.length
    ? `Plan dnia dla ${p.name}: `+titles.join('. ')+'.'
    : `${p.name} ‚Äî dzi≈õ brak zada≈Ñ.`;

  const u=new SpeechSynthesisUtterance(text);
  u.lang='pl-PL';
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ==== WEEK VIEW ==== */
const weekNames=['Nd','Pn','Wt','≈ör','Cz','Pt','So'];

function renderWeek(){
  const host=$('#weekGrid');
  host.innerHTML='';

  /* FIX PRZEWIJANIA */
  host.style.maxHeight='420px';
  host.style.overflowY='auto';
  host.style.webkitOverflowScrolling='touch';

  for(let d=1;d<=7;d++){
    const dow=d%7;

    const cell=document.createElement('div');
    cell.className='day';
    cell.innerHTML=`<h4>${weekNames[dow]}</h4><div class="drop"></div>`;

    const drop=cell.querySelector('.drop');

    cell.addEventListener('dragover',e=>e.preventDefault());
    cell.addEventListener('drop',e=>{
      e.preventDefault();
      try{
        const data=JSON.parse(e.dataTransfer.getData('text/plain'));
        const p=db.people.find(x=>x.id===data.personId);
        const t=p?.tasks.find(x=>x.id===data.taskId);
        if(!p||!t)return;

        if(p.childMode){alert('Tryb dziecka');return;}

        t.schedType='weekly';
        t.dows=[...(t.dows||[]), dow];
        t.dows=[...new Set(t.dows)];

        save(); renderAllCore();
      }catch(_){}
    });

    host.appendChild(cell);
  }

  db.people.forEach(p=>{
    p.tasks.forEach(t=>{
      const days=(t.schedType==='weekly'&&(t.dows||[]).length)
        ? t.dows
        : (t.schedType==='daily'?[1,2,3,4,5,6,0]:[]);

      days.forEach(d=>{
        const idx=[1,2,3,4,5,6,0].indexOf(d);
        const cell=host.children[idx];
        if(!cell)return;
        const drop=cell.querySelector('.drop');

        const pill=document.createElement('div');
        pill.className='pill';
        pill.textContent=`${p.name}: ${t.title}`;
        pill.draggable=true;

        pill.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id,personId:p.id}));
        });

        drop.appendChild(pill);
      });
    });
  });
}

/* ==== LEADERBOARD ==== */
function renderLeaderboard(){
  const rows=[
    `<tr>
      <th style="padding:6px">Domownik</th>
      <th style="padding:6px">üî• Streak</th>
      <th style="padding:6px">Tydzie≈Ñ</th>
      <th style="padding:6px">Dzi≈õ</th>
      <th style="padding:6px">‚è∞ .ics</th>
    </tr>`
  ];

  [...db.people]
    .sort((a,b)=>b.scoreWeek-a.scoreWeek || (b.streak||0)-(a.streak||0))
    .forEach(p=>{
      rows.push(`
        <tr>
          <td style="padding:6px">${p.name}${p.childMode?' üë∂':''}</td>
          <td style="padding:6px">${p.streak||0}</td>
          <td style="padding:6px">${p.scoreWeek}</td>
          <td style="padding:6px">${p.scoreToday}</td>
          <td style="padding:6px">${p.icsTime||'07:00'}</td>
        </tr>
      `);
    });

  leaderboardEl.innerHTML=rows.join('');
}

/* ==== HEATMAP ==== */
function renderHeat(){
  const cvs=$('#heat'), ctx=cvs.getContext('2d');
  const W=cvs.width, H=cvs.height;

  ctx.clearRect(0,0,W,H);

  const cols=7, rows=6, pad=12;
  const cw=(W-pad*2)/cols, ch=(H-pad*2)/rows;

  const map={};
  const last=new Date();

  for(let i=0;i<42;i++){
    const d=new Date(last.getFullYear(),last.getMonth(),last.getDate()-i);
    map[d.toISOString().slice(0,10)]=0;
  }

  db.history.forEach(h=>{
    if(h.date in map){
      map[h.date]+=(h.earned||0);
    }
  });

  const keys=Object.keys(map).sort();
  const vals=Object.values(map);
  const max=Math.max(1,...vals);

  let idx=0;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const k=keys[idx++];
      if(!k)continue;
      const v=map[k]||0;
      const a=v/max;
      const x=pad+c*cw, y=pad+r*ch;

      ctx.fillStyle=`rgba(10,132,255,${0.15+0.75*a})`;
      ctx.fillRect(x+3,y+3,cw-6,ch-6);
    }
  }
}

/* ==== TOP ZONES ==== */
function renderTopZones(){
  const list=$('#topZones');
  list.innerHTML='';

  const cutoff=new Date();
  cutoff.setDate(cutoff.getDate()-30);

  const agg={};

  db.history.forEach(h=>{
    if(new Date(h.date)>=cutoff){
      const zp=h.zonePoints||{};
      for(const [z,v] of Object.entries(zp)){
        agg[z]=(agg[z]||0)+v;
      }
    }
  });

  const top=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,8);

  if(!top.length){
    list.innerHTML='<li class="muted">Brak danych.</li>';
    return;
  }

  top.forEach(([z,v])=>{
    const li=document.createElement('li');
    li.textContent=`${z}: ${v}‚≠ê`;
    list.appendChild(li);
  });
}

/* ==== PIN / TRYB DZIECKA ==== */
function setGoal(){
  const p=currentPerson(); if(!p)return;
  const g=prompt('Cel dzienny (informacyjnie):', p.goal||goalForToday(p));
  if(g!==null){
    const v=parseInt(g,10)||0;
    p.goal=v;
    save(); renderScores();
  }
}

function setIcs(){
  const p=currentPerson(); if(!p)return;
  const cur=p.icsTime||'07:00';
  const t=prompt('Godzina .ics (HH:MM):',cur);
  if(!t)return;
  if(!/^\d{2}:\d{2}$/.test(t))return alert('Format HH:MM');
  p.icsTime=t; save(); renderLeaderboard();
}

function pinDialog(){
  const p=currentPerson(); if(!p)return;

  showDialog(`
    <h3 style="margin-top:0">PIN i Tryb dziecka ‚Äî ${p.name}</h3>
    <div class="row" style="flex-direction:column">
      <label class="muted">Ustaw/zmie≈Ñ PIN (4‚Äì8 cyfr)</label>
      <input id="pinSet" type="password" placeholder="${p.pin?'(obecny istnieje)':'brak'}"/>

      <label class="muted" style="margin-top:8px">Tryb dziecka</label>
      <div class="row">
        <button class="btn" onclick="setChildMode(true)">üë∂ W≈ÇƒÖcz</button>
        <button class="btn" onclick="setChildMode(false)">üîì Wy≈ÇƒÖcz</button>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn" onclick="closeDialog()">Zamknij</button>
      <button class="btn" onclick="savePin()">‚úÖ Zapisz PIN</button>
    </div>
  `);

  window.savePin=function(){
    const v=$('#pinSet').value.trim();
    if(v&&!/^\d{4,8}$/.test(v))return alert('PIN 4‚Äì8 cyfr');
    p.pin=v; save(); alert('Zapisano PIN'); closeDialog();
  };

  window.setChildMode=function(on){
    if(p.pin){
      const entered=prompt('Podaj PIN:');
      if(entered!==p.pin)return alert('Z≈Çy PIN');
    }
    p.childMode=!!on;
    save(); renderTabs();
    alert(on?'Tryb dziecka W≈ÅƒÑCZONY':'Tryb dziecka WY≈ÅƒÑCZONY');
  };
}

/* ==== RENDERERS ==== */
function renderLeaderboardAndStats(){
  renderLeaderboard();
  renderHeat();
  renderTopZones();
}

function renderAllCore(){
  renderTabs();
  renderZones();
  renderShop();
  renderTasks();
  renderScores();
  renderWeek();
  renderLeaderboardAndStats();
}

function renderAll(){
  renderDate();
  renderAllCore();
}

/* ==== EVENTS ==== */
$('#addPersonBtn').onclick=addPerson;
$('#renamePersonBtn').onclick=renamePerson;
$('#removePersonBtn').onclick=removePerson;
$('#setGoalBtn').onclick=setGoal;
$('#setIcsBtn').onclick=setIcs;
$('#pinBtn').onclick=pinDialog;

$('#addTaskBtn').onclick=addTask;

$('#resetDailyBtn').onclick=()=>{
  db.people.forEach(p=>p.tasks.forEach(t=>{
    if((t.schedType||'daily')==='daily')t.done=false;
  }));
  save(); renderTasks();
};

$('#clearDoneBtn').onclick=()=>{
  const p=currentPerson();
  p.tasks=p.tasks.filter(t=>!((t.schedType==='once'||t.repeat==='once')&&t.done));
  save(); renderTasks();
};

$('#mailBtn').onclick=sendMail;
$('#copyBtn').onclick=copyToClipboard;
$('#icsBtn').onclick=shareICSForCurrentPerson;
$('#ttsBtn').onclick=speakNow;

$('#exportBtn').onclick=exportJSON;

$('#importBtn').onclick=()=>$('#importFile').click();
$('#importFile').onchange=e=>{
  const f=e.target.files[0];
  if(f)importJSONFromFile(f);
};

$('#exportCSVPersonBtn').onclick=()=>{
  const p=currentPerson(); if(!p)return;

  const header=['Osoba','Tytu≈Ç','Sched','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];
  const rows=[header.join(',')];

  p.tasks.forEach(t=>{
    rows.push([
      p.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),
      t.points||0,t.penalty??1,t.priority||'med',
      t.zone||'',t.done?'1':'0'
    ].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(','));
  });

  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`obowiazki-${p.name}.csv`;
  a.click();
};

$('#exportCSVAllBtn').onclick=()=>{
  const header=['Osoba','Tytu≈Ç','Sched','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];
  const rows=[header.join(',')];

  db.people.forEach(p=>{
    p.tasks.forEach(t=>{
      rows.push([
        p.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),
        t.points||0,t.penalty??1,t.priority||'med',
        t.zone||'',t.done?'1':'0'
      ].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(','));
    });
  });

  const blob=new Blob([rows.join('\n')],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='obowiazki-wszyscy.csv';
  a.click();
};

$('#endDayBtn').onclick=endDay;
$('#endWeekBtn').onclick=endWeek;

$('#sortBy').onchange=()=>renderTasks();

$('#addZoneBtn').onclick=addZone;
$('#delZoneBtn').onclick=delZone;
$('#randomZoneBtn').onclick=randomZone;

$('#deltaMinus').onclick=()=>manualDelta(-1);
$('#deltaPlus').onclick=()=>manualDelta(1);

document.getElementById('changeFamilyBtn').onclick=async()=>{
  const curr=localStorage.getItem('familyId')||'';
  const next=prompt('ID rodziny:',curr);
  if(!next)return;
  await subscribeToFamily(next.trim());
  pushToFirebase();
};

/* ==== THEME ==== */
(function themeInit(){
  const saved=localStorage.getItem('ui-theme') || 'dark';
  if(saved==='light') document.documentElement.classList.add('light');

  const btn=document.getElementById('themeToggle');
  if(btn){
    btn.onclick=()=>{
      document.documentElement.classList.toggle('light');
      localStorage.setItem(
        'ui-theme',
        document.documentElement.classList.contains('light')?'light':'dark'
      );
    };
  }
})();

/* ==== SWIPE ==== */
(function enableSwipe(){
  let startX=0, startY=0, active=null, moved=false;
  const THRESH=48, MAX=96;

  function bind(row, onRight, onLeft){
    row.addEventListener('touchstart',e=>{
      startX=e.touches[0].clientX;
      startY=e.touches[0].clientY;
      active=row; moved=false;
      row.style.transition='none';
    },{passive:true});

    row.addEventListener('touchmove',e=>{
      if(!active)return;
      const dx=e.touches[0].clientX-startX;
      const dy=e.touches[0].clientY-startY;
      if(Math.abs(dy)>Math.abs(dx))return;

      moved=true;
      const off=Math.max(-MAX,Math.min(MAX,dx));
      active.style.transform=`translateX(${off}px)`;
      active.style.opacity=String(1 - Math.min(0.35,Math.abs(off)/300));
    },{passive:true});

    row.addEventListener('touchend',()=>{
      if(!active)return;
      const m=new WebKitCSSMatrix(getComputedStyle(active).transform);
      const off=m.m41||0;

      active.style.transition='';
      active.style.transform='';
      active.style.opacity='';

      if(moved && off>THRESH) onRight && onRight();
      else if(moved && off<-THRESH) onLeft && onLeft();

      active=null; moved=false;
    });
  }

  const orig=renderTasks;
  renderTasks=function(){
    orig();
    const p=currentPerson(); if(!p)return;

    const rows=document.querySelectorAll('#tasksList .task');
    const tasks=p.tasks;

    rows.forEach((row,idx)=>{
      const cb=row.querySelector('input[type="checkbox"]');

      bind(
        row,
        ()=>{ if(cb){cb.checked=true; cb.dispatchEvent(new Event('change'));} },
        ()=>{ if(p.childMode){alert('Tryb dziecka');return}
              if(confirm('UsunƒÖƒá zadanie?')){
                const id=tasks[idx]?.id;
                p.tasks=p.tasks.filter(z=>z.id!==id);
                save(); renderAllCore();
              }
        }
      );
    });
  };
})();

/* ==== PRZENOSZENIE TTS DO TOOLBAR ==== */
document.addEventListener('DOMContentLoaded',()=>{
  const ttsBtn=document.getElementById('ttsBtn');
  const bar=document.getElementById('taskToolbar');
  if(ttsBtn&&bar){
    bar.appendChild(ttsBtn);
    ttsBtn.style.marginLeft='8px';
  }
});

/* ==== TABY (obowiƒÖzki / zakupy) ‚Äì na razie tylko obowiƒÖzki ==== */
(function tabsInit(){
  const tabChores=document.getElementById('tabChores');
  const tabShopping=document.getElementById('tabShopping');
  const viewChores=document.getElementById('view-chores');
  const viewShopping=document.getElementById('view-shopping');

  function activate(which){
    if(which==='shopping'){
      tabChores.classList.remove('active');
      tabShopping.classList.add('active');
      viewChores.style.display='none';
      viewShopping.style.display='';
      renderShopping();
    }else{
      tabShopping.classList.remove('active');
      tabChores.classList.add('active');
      viewShopping.style.display='none';
      viewChores.style.display='';
      renderAllCore();
    }
  }

  tabChores.addEventListener('click',()=>activate('chores'));
  tabShopping.addEventListener('click',()=>activate('shopping'));
})();

/* ==== SW ==== */
const skipSW=location.search.includes('nosw=1');
if('serviceWorker' in navigator && !skipSW){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ==== INIT ==== */
function hideSplash(){
  const el=document.getElementById('splash');
  if(el)el.remove();
}

document.addEventListener('DOMContentLoaded',()=>{
  renderAll();
  tryFirebaseInit();
  setTimeout(hideSplash,200);
});

window.addEventListener('load',hideSplash);

</script>

<script>
/* ===========================================================
   === CZƒò≈öƒÜ 2B ‚Äî ZAKUPY / WYDATKI / TRYB DZIECKA BLOKADY ===
   =========================================================== */

/* --------------------------------------
   TRYB DZIECKA ‚Äî BLOKADA AKCJI
   -------------------------------------- */
function requirePinForProtectedAction(callback){
  const p=currentPerson();  
  if(!p) return;

  if(!p.childMode){
    callback();
    return;
  }

  if(!p.pin){
    alert('Brak PIN ‚Äî nie mo≈ºna odblokowaƒá trybu dziecka.');
    return;
  }

  const entered = prompt("Podaj PIN:");
  if(entered === p.pin){
    callback();
  } else {
    alert("Z≈Çy PIN.");
  }
}

/* helper ‚Äì blokada UI gdy childMode=true */
function childModeProtect(){
  const p=currentPerson(); if(!p)return;

  const lock = p.childMode;

  // blokuj wszystkie przyciski ‚ÄûedytujƒÖce‚Äù
  const toLock = [
    "#addTaskBtn",
    "#renamePersonBtn",
    "#removePersonBtn",
    "#addZoneBtn",
    "#delZoneBtn",
    "#randomZoneBtn",
    "#deltaMinus",
    "#deltaPlus",
    "#setGoalBtn",
    "#setIcsBtn"
  ];

  toLock.forEach(sel=>{
    const el=document.querySelector(sel);
    if(el) el.disabled = lock;
  });
}

/* --------------------------------------
   ZAKUPY ‚Äî STRUKTURA DANYCH
   -------------------------------------- */

if(!db.shopping) db.shopping = [];
if(!db.shoppingSections) db.shoppingSections = ["Jedzenie","Chemia","Kosmetyki"];

/* --------------------------------------
   RENDER ZAKUP√ìW
   -------------------------------------- */
function renderShopping(){
  const list = $('#shoppingList');
  const bought = $('#shoppingBoughtList');
  const sectionEl = $('#shoppingCategory');
  const strip = $('#shopCategories');

  list.innerHTML='';
  bought.innerHTML='';
  sectionEl.innerHTML='';
  strip.innerHTML='';

  // sekcje w selectach
  db.shoppingSections.forEach(sec=>{
    const o=document.createElement('option');
    o.value=sec;
    o.textContent=sec;
    sectionEl.appendChild(o);
  });

  // pasek kategorii
  db.shoppingSections.forEach(sec=>{
    const tag=document.createElement('span');
    tag.className='zoneTag';
    tag.textContent=sec;
    tag.onclick=()=>filterShopping(sec);
    strip.appendChild(tag);
  });

  // elementy
  db.shopping.forEach(item=>{
    const row=document.createElement('div');
    row.className='task';
    row.innerHTML=`
      <label><strong>${item.name}</strong></label>
      <small class="muted">${item.category}</small>
    `;

    // checkbox
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.checked=item.bought;
    cb.style.marginRight='10px';
    cb.onchange=()=>{
      item.bought = cb.checked;
      save(); renderShopping();
    };

    // usu≈Ñ
    const del=document.createElement('button');
    del.textContent='üóëÔ∏è';
    del.className='btn';
    del.style.marginLeft='10px';
    del.onclick=()=>requirePinForProtectedAction(()=>{
      db.shopping = db.shopping.filter(x=>x.id!==item.id);
      save(); renderShopping();
    });

    row.prepend(cb);
    row.appendChild(del);

    if(!item.bought) list.appendChild(row);
    else bought.appendChild(row);
  });
}

function filterShopping(sec){
  const items = $$('#shoppingList .task, #shoppingBoughtList .task');
  items.forEach(el=>{
    const txt = el.querySelector('small')?.textContent || '';
    el.style.display = txt === sec ? '' : 'none';
  });
}

/* --------------------------------------
   ZAKUPY ‚Äî DODAJ / KATEGORIE
   -------------------------------------- */
$('#addShoppingBtn').onclick=()=>{
  const name = $('#shoppingName').value.trim();
  const cat = $('#shoppingCategory').value;

  if(!name){ alert("Podaj nazwƒô"); return; }

  db.shopping.push({
    id: crypto.randomUUID(),
    name,
    category: cat,
    bought: false
  });

  $('#shoppingName').value='';
  save(); renderShopping();
};

$('#addShopCatBtn').onclick=()=>requirePinForProtectedAction(()=>{
  const v = $('#newShopCat').value.trim();
  if(!v) return;
  if(!db.shoppingSections.includes(v)) db.shoppingSections.push(v);
  $('#newShopCat').value='';
  save(); renderShopping();
});

$('#delShopCatBtn').onclick=()=>requirePinForProtectedAction(()=>{
  const v = $('#newShopCat').value.trim();
  if(!v) return;
  if(!db.shoppingSections.includes(v)){
    alert("Nie ma takiej kategorii.");
    return;
  }
  if(!confirm(`UsunƒÖƒá kategoriƒô ‚Äû${v}‚Äù?`))return;
  db.shoppingSections = db.shoppingSections.filter(x=>x!==v);
  save(); renderShopping();
});

/* --------------------------------------
   WYDATKI ‚Äî STRUKTURA DANYCH
   -------------------------------------- */
if(!db.expenses) db.expenses = [];
if(!db.expenseCategories) db.expenseCategories = ["Jedzenie","Chemia","Kosmetyki","Inne"];

/* --------------------------------------
   RENDER WYDATK√ìW
   -------------------------------------- */
function renderExpenses(){
  const list=$('#expenseList');
  const total=$('#expenseTotal');
  const catTotal=$('#expenseCategorySum');
  const catSel=$('#expenseCategory');
  const catStrip=$('#expenseCategories');

  list.innerHTML='';
  total.textContent='0 z≈Ç';
  catTotal.innerHTML='';
  catSel.innerHTML='';
  catStrip.innerHTML='';

  // kategorie w select
  db.expenseCategories.forEach(c=>{
    const o=document.createElement('option');
    o.value=c;
    o.textContent=c;
    catSel.appendChild(o);
  });

  // pasek kategorii
  db.expenseCategories.forEach(c=>{
    const tag=document.createElement('span');
    tag.className='zoneTag';
    tag.textContent=c;
    tag.onclick=()=>filterExpenses(c);
    catStrip.appendChild(tag);
  });

  // liczenie miesiƒÖca
  const now = new Date();
  const ym = now.getFullYear()+"-"+String(now.getMonth()+1).padStart(2,'0');

  const listMonth = db.expenses.filter(e=>e.date.startsWith(ym));

  let sum=0;
  const catSum={};

  listMonth.forEach(e=>{
    sum += e.amount;
    catSum[e.category] = (catSum[e.category]||0) + e.amount;

    const row=document.createElement('div');
    row.className='task';
    row.innerHTML=`
      <strong>${e.amount} z≈Ç</strong>
      <br><small class="muted">${e.category} ‚Äî ${e.who}</small>
    `;

    const del=document.createElement('button');
    del.className='btn';
    del.textContent='üóëÔ∏è';
    del.style.marginLeft='10px';

    del.onclick=()=>requirePinForProtectedAction(()=>{
      db.expenses = db.expenses.filter(x=>x.id!==e.id);
      save(); renderExpenses();
    });

    row.appendChild(del);
    list.appendChild(row);
  });

  total.textContent = sum + " z≈Ç";

  Object.entries(catSum).forEach(([cat,val])=>{
    const div=document.createElement('div');
    div.textContent=`${cat}: ${val} z≈Ç`;
    catTotal.appendChild(div);
  });
}

function filterExpenses(c){
  const rows=$$('#expenseList .task');
  rows.forEach(r=>{
    const muted=r.querySelector('small')?.textContent||'';
    r.style.display = muted.includes(c)?'':'none';
  });
}

/* --------------------------------------
   DODAWANIE WYDATKU
   -------------------------------------- */
$('#addExpenseBtn').onclick=()=>{
  const amount=parseFloat($('#expenseAmount').value||'0');
  const cat=$('#expenseCategory').value;
  const who=$('#expenseWho').value;

  if(!amount || amount<=0){ alert('Kwota > 0'); return; }

  db.expenses.push({
    id:crypto.randomUUID(),
    amount,
    category:cat,
    who,
    date: nowYMD()
  });

  $('#expenseAmount').value='';
  save(); renderExpenses();
};

/* --------------------------------------
   KATEGORIE WYDATK√ìW
   -------------------------------------- */
$('#addExpCatBtn').onclick=()=>requirePinForProtectedAction(()=>{
  const v=$('#newExpCat').value.trim();
  if(!v)return;
  if(!db.expenseCategories.includes(v)) db.expenseCategories.push(v);
  $('#newExpCat').value='';
  save(); renderExpenses();
});

$('#delExpCatBtn').onclick=()=>requirePinForProtectedAction(()=>{
  const v=$('#newExpCat').value.trim();
  if(!v)return;
  if(!db.expenseCategories.includes(v)){alert('Brak kategorii'); return;}
  if(!confirm(`UsunƒÖƒá kategoriƒô ‚Äû${v}‚Äù?`))return;
  db.expenseCategories = db.expenseCategories.filter(x=>x!==v);
  save(); renderExpenses();
});

/* --------------------------------------
   TAB WYDATK√ìW
   -------------------------------------- */
(function initExpensesTab(){
  const tab=document.getElementById('tabExpenses');
  const view=document.getElementById('view-expenses');
  const chores=document.getElementById('view-chores');
  const shopping=document.getElementById('view-shopping');

  if(!tab) return;

  tab.addEventListener('click',()=>{
    document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
    tab.classList.add('active');

    chores.style.display='none';
    shopping.style.display='none';
    view.style.display='';

    renderExpenses();
  });
})();
</script>
<script>
/* ===========================================================
   === CZƒò≈öƒÜ 2C ‚Äî INICJALIZACJE, TABY, START APLIKACJI ===
   =========================================================== */

/* --------------------------------------
   PRZE≈ÅƒÑCZANIE ZAK≈ÅADEK
   -------------------------------------- */

function initTabs(){
  const choresTab    = $('#tabChores');
  const shoppingTab  = $('#tabShopping');
  const expensesTab  = $('#tabExpenses');

  const viewChores   = $('#view-chores');
  const viewShopping = $('#view-shopping');
  const viewExpenses = $('#view-expenses');

  function activate(tab){
    choresTab.classList.remove('active');
    shoppingTab.classList.remove('active');
    expensesTab.classList.remove('active');

    viewChores.style.display='none';
    viewShopping.style.display='none';
    viewExpenses.style.display='none';

    if(tab==='chores'){
      choresTab.classList.add('active');
      viewChores.style.display='';
      renderTasks();
      childModeProtect();
    }

    if(tab==='shopping'){
      shoppingTab.classList.add('active');
      viewShopping.style.display='';
      renderShopping();
      childModeProtect();
    }

    if(tab==='expenses'){
      expensesTab.classList.add('active');
      viewExpenses.style.display='';
      renderExpenses();
      childModeProtect();
    }
  }

  choresTab.onclick = ()=>activate('chores');
  shoppingTab.onclick = ()=>activate('shopping');
  expensesTab.onclick = ()=>activate('expenses');

  // domy≈õlna zak≈Çadka
  activate('chores');
}

/* --------------------------------------
   START APLIKACJI
   -------------------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  initTabs();

  renderShopping();
  renderExpenses();

  renderTasks();
  renderPeople();
  renderZones();
  renderGoals();
  renderWeek();

  childModeProtect();

  // ustaw datƒô w nag≈Ç√≥wku
  $('#today').textContent = new Date().toLocaleDateString('pl-PL', {
    weekday:'long', year:'numeric', month:'long', day:'numeric'
  });
});

/* --------------------------------------
   KONIEC 2C
   -------------------------------------- */
</script>
