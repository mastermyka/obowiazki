<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Domowe obowiÄ…zki (full)</title>


 
<!-- PWA -->
<meta name="theme-color" content="#0a84ff"/>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-192.png"/>

<!-- Tailwind + Inter (tylko wyglÄ…d) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<script>window.process = window.process || { env: {} };</script>

<!-- Firebase compat (prawidÅ‚owa kolejnoÅ›Ä‡) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-check-compat.js"></script>
<script src="firebase-config.js"></script>


<style>
/* ====== BAZA (Twoje oryginalne style, nietkniÄ™te) ====== */
:root{--bg:#0f1113;--card:rgba(28,28,30,.72);--border:rgba(255,255,255,.08);--muted:#8e8e93;--text:#f5f5f7;--accent:#0a84ff;--ok:#30d158;--warn:#ffd60a;--danger:#ff453a;--shadow:0 8px 30px rgba(0,0,0,.35)}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji";color:var(--text);background:radial-gradient(1200px 800px at 20% -10%,#1b1d20 0%,#0f1113 60%)}
.wrap{max-width:1200px;margin:28px auto;padding:0 16px}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.title{font-weight:800;font-size:1.25rem;display:flex;gap:10px;align-items:center;letter-spacing:.2px}
.dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 14px var(--ok)}
.subtitle{opacity:.85;color:var(--muted)}
.card{background:var(--card);border:1px solid var(--border);backdrop-filter:saturate(140%) blur(10px);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
button,.btn{border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:transform .06s ease, box-shadow .18s ease, border-color .18s}
button:hover,.btn:hover{box-shadow:0 14px 30px -12px rgba(10,132,255,.45);border-color:rgba(99,102,241,.35)}
button:active{transform:translateY(1px)}
input[type=text],input[type=number],input[type=time],input[type=date],input[type=password],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);transition:border-color .2s, box-shadow .2s}
input[type=text]:focus, input[type=number]:focus, input[type=time]:focus, input[type=date]:focus, input[type=password]:focus, select:focus{border-color:#8da2fb;box-shadow:0 0 0 4px rgba(99,102,241,.18)}
.grid{display:grid;grid-template-columns:1.25fr .75fr;gap:12px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.task{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
.task:hover{border-color:rgba(99,102,241,.35);box-shadow:0 10px 28px -14px rgba(10,132,255,.35)}
.task.done{opacity:.55}
.task label{flex:1}
.task small{opacity:.9;color:var(--muted)}
.task .actions{display:flex;gap:8px}
.muted{color:var(--muted)}
.progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
.progress>div{height:100%;background:linear-gradient(90deg,var(--accent),#34d399);width:0%}
.score{font-weight:700}
.subtasks{margin:6px 0 0 26px;display:flex;flex-direction:column;gap:6px}
.subAdd{margin-left:26px}
.week{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.day{min-height:120px;border:1px dashed var(--border);border-radius:12px;padding:8px}
.day h4{margin:0 0 6px 0;font-size:.95rem;color:var(--muted)}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06);font-size:.85rem;margin:2px 0;cursor:grab}
.statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:980px){.statsGrid{grid-template-columns:1fr}}
canvas{width:100%;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px}
.shopItem{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:rgba(255,255,255,.03)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
.dialog{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;width:min(520px,92vw)}
.zoneTag{border:1px solid var(--border);background:rgba(255,255,255,.06);border-radius:999px;padding:4px 10px}

/* drobne udoskonalenia spacingu, nagÅ‚Ã³wkÃ³w i tabeli */
h3{font-weight:700}
.card h3{display:flex;align-items:center;gap:8px}
table#leaderboard th, table#leaderboard td{border-bottom:1px solid var(--border)}
/* --- iPhone horizontal scroll fix --- */
html, body { width:100%; max-width:100%; overflow-x:hidden; }

/* nic nie wymusza wiÄ™kszej szerokoÅ›ci niÅ¼ rodzic */
.wrap, .card, .row, .grid, .week, .statsGrid { min-width:0; }
.btn { white-space:nowrap; }

/* tabela przewija siÄ™ w swoim pudeÅ‚ku, nie caÅ‚a strona */
table#leaderboard { display:block; width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }

/* piguÅ‚ki w widoku tygodnia nie wyjeÅ¼dÅ¼ajÄ… */
.pill { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* â€Widok tygodniaâ€ â€“ na maÅ‚ych ekranach w 2 kolumny */
@media (max-width: 640px) {
  .week { grid-template-columns: 1fr 1fr; }
  .day  { min-height: 96px; }
  /* wÄ…skie ekrany: drobne przyciÄ™cie staÅ‚ych szerokoÅ›ci */
  #taskTime { width: 110px !important; }
}
/* --- LIGHT THEME --- */
root.light{
  :root.light{
  --bg:#f3f4f6;
  --card:#ffffffcc;
  --border:#e5e7eb;
  --muted:#64748b;
  --text:#111827;
  --accent:#0ea5e9; /* bÅ‚Ä™kit */
  --ok:#16a34a;
  --warn:#f59e0b;
  --danger:#dc2626;
  --shadow:0 10px 24px rgba(17,24,39,.10);
}
:root.light body{
  color:var(--text);
  background:radial-gradient(1400px 900px at 20% -10%,#eef2ff 0%,#f8fafc 60%);
}
.task .editable { cursor:text; border-radius:8px; padding:2px 4px; }
.task .editable:focus { outline:2px solid rgba(99,102,241,.35); background:rgba(255,255,255,.06); }
/* Mobile: w "Strefy domu" selektor na peÅ‚nÄ… szerokoÅ›Ä‡ i jako pierwszy wiersz */
@media (max-width: 640px){
  #zonesSelect{
    flex: 1 1 100% !important;
    min-width: 100%;
    order: -1;               /* przenieÅ› na samÄ… gÃ³rÄ™ w wierszu */
    margin-bottom: 8px;
  }
  #newZone{                  /* pole "Nowa strefa" teÅ¼ wygodniej szerzej */
    flex: 1 1 100%;
    min-width: 100%;
  }
}
/* Mobile: w formularzu dodawania zadania strefa na osobnej linii */
@media (max-width: 640px){
  #taskZone{
    display:block;
    flex: 1 1 100% !important;
    min-width:100%;
    margin-bottom:8px;
  }
}
/* PiguÅ‚ki w tygodniu â€” jednowierszowo, z elipsÄ… i bez przepÅ‚ywu */
.week .pill{
  display:block;
  box-sizing:border-box;
  max-width:100%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Kontener w dniu nie wypuszcza zawartoÅ›ci na boki */
.day .drop{
  overflow:hidden;
}

  /* Splash overlay */
  #splash {
    position: fixed; inset: 0; z-index: 9999;
    display:flex; align-items:center; justify-content:center;
    background: var(--bg, #0f1113);  /* pasuje do motywu */
  }
  #splash .logo {
    width: 120px; height: 120px; border-radius: 24px;
    display:flex; align-items:center; justify-content:center;
    font-size: 56px;
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 8px 30px rgba(0,0,0,.35);
  }

</style>
</head>
<body>
 <div id="splash"><div class="logo">ğŸ§¹</div></div>

<div class="wrap">
  <header>
    <div class="title"><span class="dot"></span> Domowy organizer â€” PRO 3</div>
    <div>
      <div class="subtitle" id="today"></div>
      <div class="subtitle">Rodzina: <strong id="familyLabel">â€”</strong></div>
    </div>
    <button id="themeToggle" class="btn" title="Jasny / ciemny">â˜€ï¸ / ğŸŒ™</button>

  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="muted">ZakÅ‚adki domownikÃ³w</div>
        <div id="peopleTabs" class="row" style="gap:8px;flex-wrap:wrap"></div>
        <div class="row" style="margin-top:8px">
          <button id="addPersonBtn" class="btn">â• Dodaj osobÄ™</button>
          <button id="renamePersonBtn" class="btn">âœï¸ ZmieÅ„</button>
          <button id="setGoalBtn" class="btn">ğŸ¯ Cel</button>
          <button id="setIcsBtn" class="btn">â° Godzina .ics</button>
          <button id="pinBtn" class="btn">ğŸ”’ PIN / Tryb dziecka</button>
          <button id="removePersonBtn" class="btn" style="border-color:rgba(255,69,58,.35);color:#ffd1cc">ğŸ—‘ï¸ UsuÅ„</button>
        </div>
      </div>
      <div class="row">
        <button id="endDayBtn" class="btn">ğŸŒ™ ZakoÅ„cz dzieÅ„</button>
        <button id="endWeekBtn" class="btn">ğŸ ZakoÅ„cz tydzieÅ„</button>
        <button id="changeFamilyBtn" class="btn" title="Ustaw / zmieÅ„ rodzinÄ™">ğŸ‘ª ZmieÅ„ rodzinÄ™</button>
      </div>
    </div>
  </div>

  <div style="height:10px"></div>

  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Zadania <span id="personTitle" class="muted"></span></h3>
        <div class="row">
          <label class="muted">Sortuj</label>
          <select id="sortBy"><option value="status">Status</option><option value="priority">Priorytet</option><option value="title">TytuÅ‚ Aâ†’Z</option><option value="zone">Strefa</option></select>
          <button id="resetDailyBtn" class="btn">ğŸ” Reset</button>
          <button id="clearDoneBtn" class="btn">ğŸ§¹ UsuÅ„ wykonane</button>
        </div>
      </div>
      <div id="tasksList" style="margin-top:10px;display:flex;flex-direction:column;gap:10px"></div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">Dodaj zadanie</h3>
      <div class="row" style="flex-direction:column;gap:10px;width:100%">
        <input id="taskTitle" type="text" placeholder="np. odkurzyÄ‡ salon"/>
        <div class="row" style="width:100%">
          <select id="planType" style="flex:1">
            <option value="daily" selected>Codziennie</option>
            <option value="once">W konkretnym dniu</option>
            <option value="weekly">Co tydzieÅ„</option>
            <option value="monthly">Co miesiÄ…c</option>
            <option value="yearly">Co rok</option>
          </select>
          <input id="taskTime" type="time" value="07:00" style="width:140px"/>
        </div>
        <div class="row" id="oncePicker" style="display:none;width:100%"><label class="muted">Data:</label><input id="taskDate" type="date" style="flex:1"/></div>
        <div class="row" id="monthlyPicker" style="display:none;width:100%"><label class="muted">DzieÅ„ miesiÄ…ca:</label><input id="dayOfMonth" type="number" min="1" max="31" value="1" style="width:120px"/></div>
        <div class="row" id="yearlyPicker" style="display:none;width:100%"><label class="muted">Data w roku:</label><input id="yearlyDate" type="date" style="flex:1"/></div>
        <div class="row" id="weeklyPicker" style="display:none;width:100%"><label class="muted">Dni:</label>
          <label><input type="checkbox" value="1">Pn</label><label><input type="checkbox" value="2">Wt</label><label><input type="checkbox" value="3">Åšr</label><label><input type="checkbox" value="4">Cz</label><label><input type="checkbox" value="5">Pt</label><label><input type="checkbox" value="6">So</label><label><input type="checkbox" value="0">Nd</label>
        </div>
        <div class="row" style="width:100%">
          <select id="taskZone" style="flex:1"></select>
          <select id="taskPriority" style="flex:1">
            <option value="high">ğŸ”¥ Wysoki</option>
            <option value="med" selected>â€¢ Åšredni</option>
            <option value="low">â€¦ Niski</option>
          </select>
          <input id="taskPoints" type="number" min="1" step="1" value="1" style="width:120px"/>
        </div>
        <div class="row" style="width:100%">
          <label class="muted">Kara gdy nie zrobione (â­):</label>
          <input id="taskPenalty" type="number" min="0" step="1" value="1" style="width:120px" />
        </div>
        <div class="row" style="width:100%"><label class="muted">Przypomnij wczeÅ›niej:</label>
          <input id="remNum" type="number" min="0" step="1" value="10" style="width:100px"/>
          <select id="remUnit" style="width:150px"><option value="minutes" selected>minuty</option><option value="hours">godziny</option><option value="days">dni</option><option value="weeks">tygodnie</option><option value="months">miesiÄ…ce</option><option value="years">lata</option></select>
        </div>
        <button id="addTaskBtn" class="btn">âœ… Dodaj</button>
      </div>

      <hr style="border-color:var(--border);margin:14px 0"/>

      <h3 style="margin-top:0">Punktacja i cele</h3>
      <div class="row" style="justify-content:space-between;width:100%">
        <div style="flex:1">
          <div class="row" style="justify-content:space-between">
            <div>Dzisiejsze: <span class="score" id="todayScore">0</span> / <span id="goalScore">0</span> â­</div>
            <div class="muted">TydzieÅ„: <span class="score" id="weekScore">0</span></div>
          </div>
          <div class="progress" style="margin-top:6px"><div id="goalBar"></div></div>
        </div>
        <div class="row"><label class="muted">Kara globalna (nieuÅ¼ywana)</label>
          <select id="penaltyPolicy" disabled><option value="1" selected>-100%</option></select>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <h4 style="margin:0 0 6px 0">Szybkie korekty (nagrody/kary)</h4>
        <div class="row" style="width:100%">
          <input id="deltaPoints" type="number" value="1" min="1" step="1" style="width:120px"/>
          <select id="deltaScope" style="width:160px">
            <option value="week">TydzieÅ„</option>
            <option value="today">DziÅ›</option>
          </select>
          <button id="deltaMinus" class="btn">â– Odejmij</button>
          <button id="deltaPlus" class="btn">â• Dodaj</button>
        </div>
      </div>

      <hr style="border-color:var(--border);margin:14px 0"/>

      <h3 style="margin-top:0">Sklepik nagrÃ³d ğŸ</h3>
      <div id="shopList" style="display:flex;flex-direction:column;gap:8px"></div>
      <div class="row"><input id="rewardName" type="text" placeholder="np. seans filmu" style="flex:1"/><input id="rewardCost" type="number" min="1" step="1" value="10" style="width:120px"/><button id="addRewardBtn" class="btn">â•</button></div>

      <hr style="border-color:var(--border);margin:14px 0"/>

      <h3 style="margin-top:0">UdostÄ™pnij / Eksport</h3>
      <div class="row">
        <button id="mailBtn" class="btn">ğŸ“§ Podsumowanie</button>
        <button id="copyBtn" class="btn">ğŸ“‹ Kopiuj</button>
        <button id="icsBtn" class="btn">ğŸ“† .ics (osoba)</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="exportCSVPersonBtn" class="btn">â¬‡ï¸ CSV (osoba)</button>
        <button id="exportCSVAllBtn" class="btn">â¬‡ï¸ CSV (wszyscy)</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="exportBtn" class="btn">â˜ï¸ Zapisz JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="importBtn" class="btn">â˜ï¸ Wczytaj JSON</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="remindersBtn" class="btn">ğŸ“ Do PrzypomnieÅ„ (Shortcuts)</button>
        <button id="ttsBtn" class="btn">ğŸ”Š Czytaj teraz</button>
      </div>

      <hr style="border-color:var(--border);margin:14px 0"/>

      <h3 style="margin-top:0">Strefy domu</h3>
      <div class="row">
        <select id="zonesSelect" style="flex:1"></select>
        <input id="newZone" type="text" placeholder="Nowa strefa" style="flex:1"/>
        <button id="addZoneBtn" class="btn">â•</button>
        <button id="delZoneBtn" class="btn" title="UsuÅ„ wybranÄ…">ğŸ—‘ï¸</button>
        <button id="randomZoneBtn" class="btn">ğŸ² Losuj</button>
      </div>
      <div id="zonesBadges" class="row" style="margin-top:8px;flex-wrap:wrap"></div>
    </aside>
  </div>

  <div style="height:10px"></div>

  <section class="card">
    <h3 style="margin:0 0 10px 0">Widok tygodnia (przeciÄ…gnij zadanie na dzieÅ„ tygodnia)</h3>
    <div id="weekGrid" class="week"></div>
  </section>

  <div style="height:10px"></div>

  <section class="card">
    <h3 style="margin:0 0 10px 0">Statystyki</h3>
    <div class="statsGrid">
      <div>
        <h4 style="margin:0 0 6px 0" class="muted">Heatmapa 6 tygodni (â­ na dzieÅ„)</h4>
        <canvas id="heat" width="600" height="240"></canvas>
      </div>
      <div>
        <h4 style="margin:0 0 6px 0" class="muted">Top strefy (ostatnie 30 dni)</h4>
        <ul id="topZones" style="margin:0;padding-left:18px"></ul>
      </div>
    </div>
  </section>

  <div style="height:10px"></div>

  <aside class="card">
    <h3 style="margin:0 0 6px 0">Tablica wynikÃ³w</h3>
    <table id="leaderboard" style="width:100%;border-collapse:collapse"></table>
  </aside>
</div>

<div id="overlay" class="overlay"><div id="dialog" class="dialog"></div></div>

<script>
/* ---------- AWARYJNY RESET: ?reset=1 lub #reset ---------- */
(function(){
  if (location.search.includes('reset=1') || location.hash === '#reset') {
    try {
      localStorage.removeItem('familyId');
      localStorage.removeItem('home-chores-pro3-full');
      if ('caches' in window) caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
      if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
    } finally {
      alert('Zresetowano dane i cache. ÅadujÄ™ ponownieâ€¦');
      location.replace(location.pathname);
    }
  }
})();

/* ===== UTIL ===== */
const $=s=>document.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const todayEl=$('#today'); function fmtDate(d){return d.toLocaleDateString('pl-PL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function nowYMD(){const d=new Date();return d.toISOString().slice(0,10)}
function hmToParts(hm='07:00'){const [H,M]=hm.split(':').map(n=>parseInt(n,10));return{H:isNaN(H)?7:H,M:isNaN(M)?0:M}}
function clamp(n,a,b){return Math.max(a,Math.min(b,n))}
function copy(text){return navigator.clipboard.writeText(text)}
function showDialog(html){$('#dialog').innerHTML=html;$('#overlay').style.display='flex'}
function closeDialog(){ $('#overlay').style.display='none' }

/* ===== FIREBASE (opcjonalny) ===== */
let fbApp=null, fs=null, fbDoc=null, __unsub=null;
const FIREBASE_COLLECTION = 'organizer';
function setFamilyLabel(id){ const l=document.getElementById('familyLabel'); if(l) l.textContent=id || 'â€”'; }

async function subscribeToFamily(id){
  if(!fs || !id) return;
  id = String(id).trim();
  localStorage.setItem('familyId', id);
  setFamilyLabel(id);

  if (__unsub) { try{ __unsub(); }catch(_){ } __unsub=null; }
  fbDoc = fs.collection(FIREBASE_COLLECTION).doc(id);

  __unsub = fbDoc.onSnapshot((snap)=>{
    const data = snap.data();
    if(!data || !data.payload) return;
    try{
      const payload = (typeof data.payload === 'string') ? JSON.parse(data.payload) : data.payload;
      if(!payload) return;

      const local = (()=>{ try { return JSON.parse(localStorage.getItem(stateKey)||'{}'); } catch { return {}; }})();
      const cloudMillis = data.updatedAt?.toMillis?.() ?? payload.updatedAt ?? 0;
      const localMillis = local.updatedAt ?? 0;

      if (!localMillis || cloudMillis > localMillis) {
        db = payload;
        localStorage.setItem(stateKey, JSON.stringify(db));
        renderAll();
      }
    }catch(e){ console.warn('Snapshot parse error', e); }
  }, (err)=>console.error('onSnapshot error', err));
}

async function tryFirebaseInit(){
  try{
    if(!window.firebaseConfig || !window.firebaseConfig.apiKey) return;
    if(!firebase.apps?.length){ fbApp = firebase.initializeApp(window.firebaseConfig); }
    firebase.appCheck().activate("6LffMAQsAAAAAHaO0TzmnQHwSA3SPNOxJOOIFCk1", true);

    fs = firebase.firestore();

    let family = localStorage.getItem('familyId');
    if(!family){
      const prev = localStorage.getItem('familyId') || '';
      family = prompt('ID rodziny (np. rodzina-kowalscy) â€” wspÃ³lna dla wszystkich urzÄ…dzeÅ„:', prev || 'rodzina-demo');
      if(!family) return;
      family = String(family).trim();
      localStorage.setItem('familyId', family);
    }
    setFamilyLabel(family);

    await subscribeToFamily(family);
    pushToFirebase(); // utwÃ³rz dokument jeÅ›li go nie ma
  }catch(e){ console.warn('Firebase init error', e); }
}

async function pushToFirebase(){
  if(!fbDoc) return;
  try{
    const payloadStr = JSON.stringify(db);
    await fbDoc.set(
      { payload: payloadStr, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
      { merge:true }
    );
  }catch(e){
    console.error('[Firestore] zapis ERROR', e);
    alert('BÅ‚Ä…d zapisu do Firestore: ' + (e?.message || e));
  }
}

/* ===== STATE ===== */
const stateKey='home-chores-pro3-full';
const defaultZones=['Kuchnia','Salon','Åazienka','Sypialnia','Korytarz'];
const defaultRewards=[
  {id:crypto.randomUUID(),name:'Seans filmu',cost:20},
  {id:crypto.randomUUID(),name:'Godzina gry',cost:25}
];
const defaultData={zones:defaultZones,rewards:defaultRewards,people:[
  {id:crypto.randomUUID(),name:'Ja',goal:5,streak:0,icsTime:'07:00',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[
    {id:crypto.randomUUID(),title:'WyrzuciÄ‡ Å›mieci',schedType:'daily',time:'07:00',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]},
    {id:crypto.randomUUID(),title:'NakarmiÄ‡ kota',schedType:'daily',time:'07:10',points:1,penalty:1,priority:'med',zone:'Kuchnia',done:false,sub:[]}
  ]},
  {id:crypto.randomUUID(),name:'Ania',goal:5,streak:0,icsTime:'07:10',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[
    {id:crypto.randomUUID(),title:'Zmywarka â€” rozÅ‚aduj',schedType:'daily',time:'07:30',points:2,penalty:1,priority:'high',zone:'Kuchnia',done:false,sub:[]},
    {id:crypto.randomUUID(),title:'PodlaÄ‡ kwiaty',schedType:'weekly',dows:[3],time:'18:00',points:2,penalty:1,priority:'low',zone:'Salon',done:false,sub:[]}
  ]}
],currentPersonId:null,penaltyFactor:1,history:[],updatedAt: Date.now()};
function load(){try{return JSON.parse(localStorage.getItem(stateKey))||defaultData}catch(e){return defaultData}}
function save(){ db.updatedAt=Date.now(); localStorage.setItem(stateKey,JSON.stringify(db)); pushToFirebase(); }
let db=load(); if(!db.currentPersonId && db.people.length) db.currentPersonId=db.people[0].id;

/* ===== HEADER & TABS ===== */
function renderDate(){todayEl.textContent=fmtDate(new Date())}
function currentPerson(){return db.people.find(p=>p.id===db.currentPersonId)||db.people[0]}
const tabsEl=$('#peopleTabs');
function renderTabs(){tabsEl.innerHTML='';db.people.forEach(p=>{const b=document.createElement('button');b.className='btn'+(p.id===db.currentPersonId?'':'');b.textContent=`${p.name} Â· â­ ${p.scoreWeek} Â· ğŸ”¥ ${p.streak||0}${p.childMode?' Â· ğŸ‘¶':''}`;b.onclick=()=>{db.currentPersonId=p.id;save();renderAll()};tabsEl.appendChild(b)})}
function addPerson(){const name=prompt('ImiÄ™ domownika:');if(!name)return;const p={id:crypto.randomUUID(),name:name.trim(),goal:5,streak:0,icsTime:'07:00',scoreToday:0,scoreWeek:0,latePenaltyPerHour:1,pin:'',childMode:false,tasks:[]};db.people.push(p);db.currentPersonId=p.id;save();renderAll()}
function renamePerson(){const p=currentPerson();if(!p)return;const n=prompt('Nowa nazwa:',p.name);if(!n)return;p.name=n.trim();save();renderTabs()}
function removePerson(){const p=currentPerson();if(!p)return;if(!confirm(`UsunÄ…Ä‡ osobÄ™ â€${p.name}â€?`))return;db.people=db.people.filter(x=>x.id!==p.id);db.currentPersonId=db.people[0]?.id||null;save();renderAll()}

/* ===== ZONES ===== */
function renderZones(){ $('#taskZone').innerHTML=db.zones.map(z=>`<option value="${z}">${z}</option>`).join(''); $('#zonesSelect').innerHTML=db.zones.map(z=>`<option>${z}</option>`).join(''); const badges=$('#zonesBadges'); badges.innerHTML=''; db.zones.forEach(z=>{const t=document.createElement('span');t.className='zoneTag';t.textContent=z;badges.appendChild(t)})}
function addZone(){const z=$('#newZone').value.trim(); if(!z) return; if(!db.zones.includes(z)) db.zones.push(z); $('#newZone').value=''; save(); renderZones()}
function delZone(){const val=$('#zonesSelect').value; if(!val) return; if(!confirm(`UsunÄ…Ä‡ strefÄ™ â€${val}â€?`)) return; db.zones=db.zones.filter(z=>z!==val); save(); renderZones()}
function randomZone(){ if(!db.zones.length) return alert('Brak stref'); const z=db.zones[Math.floor(Math.random()*db.zones.length)]; alert('ğŸ² Dzisiejsza strefa: '+z) }

/* ===== SHOP ===== */
function renderShop(){const host=$('#shopList');host.innerHTML='';const p=currentPerson();if(!p)return;db.rewards.forEach(r=>{const row=document.createElement('div');row.className='shopItem';row.innerHTML=`<div>${r.name} â€” <b>${r.cost}â­</b></div>`;const btn=document.createElement('button');btn.className='btn';btn.textContent='Zrealizuj';btn.onclick=()=>{if(p.childMode){alert('Tryb dziecka â€” realizacja nagrÃ³d zablokowana.');return}if(p.scoreWeek<r.cost){alert('Za maÅ‚o â­');return}showDialog(`<h3 style="margin-top:0">PotwierdÅº nagrodÄ™</h3><p>${p.name} wymienia <b>${r.cost}â­</b> na â€${r.name}â€. KontynuowaÄ‡?</p><div class="row" style="justify-content:flex-end"><button class="btn" onclick="closeDialog()">Anuluj</button><button class="btn" onclick="redeem('${r.id}')">âœ… OK</button></div>`)};row.appendChild(btn);host.appendChild(row)})}
function redeem(id){const p=currentPerson();const r=db.rewards.find(x=>x.id===id);if(!p||!r)return;p.scoreWeek-=r.cost;if(p.scoreWeek<0)p.scoreWeek=0;db.history.push({date:nowYMD(),personId:p.id,earned:0,missed:0,reward:r.name});save();closeDialog();renderScores();renderTabs()}

/* ===== SCORES ===== */
const personTitleEl=$('#personTitle'),todayScoreEl=$('#todayScore'),weekScoreEl=$('#weekScore'),goalScoreEl=$('#goalScore'),goalBarEl=$('#goalBar'),leaderboardEl=$('#leaderboard');
function goalForToday(p){ return p.tasks.filter(dueToday).length; }
function renderScores(){
  const p=currentPerson(); if(!p) return;
  todayScoreEl.textContent=p.scoreToday||0;
  weekScoreEl.textContent=p.scoreWeek||0;
  const g = Math.max(0, goalForToday(p));
  goalScoreEl.textContent=g;
  const perc = g? clamp(Math.round(100*(p.scoreToday||0)/g),0,100) : 0;
  goalBarEl.style.width = perc+'%';
  $('#penaltyPolicy').value='1';
}
function latePenaltyForTask(p,t){
  if(!t.time) return 0;
  const now=new Date();
  const {H,M}=hmToParts(t.time);
  const sched=new Date(now.getFullYear(),now.getMonth(),now.getDate(),H,M,0);
  if(now<=sched) return 0;
  const hoursLate=Math.floor((now-sched)/(60*60*1000));
  return Math.max(0,(p.latePenaltyPerHour||1)*hoursLate);
}

/* ===== TASKS ===== */
const tasksListEl=$('#tasksList'),sortSel=$('#sortBy');
function dueToday(t){
  const kind=t.schedType||t.repeat||'daily';
  const now=new Date(); const dow=now.getDay();
  if(kind==='daily')return true;
  if(kind==='once'){ if(!t.date) return false; const d=new Date(t.date+'T00:00:00'); return d.toDateString()===new Date(nowYMD()).toDateString(); }
  if(kind==='weekly')return (t.dows||[]).includes(dow);
  if(kind==='monthly')return now.getDate()===(t.dayOfMonth||1);
  if(kind==='yearly'){ if(!t.yearlyDate)return false; const yd=new Date(t.yearlyDate+'T00:00:00'); return yd.getDate()===now.getDate()&&yd.getMonth()===now.getMonth(); }
  return true;
}
function priorityWeight(p){return p==='high'?2:(p==='med'?1:0)}
function sortTasks(arr){const mode=sortSel.value;const a=arr.slice();if(mode==='status')a.sort((x,y)=>(x.done===y.done?0:(x.done?1:-1)));if(mode==='priority')a.sort((x,y)=>priorityWeight(y.priority)-priorityWeight(x.priority));if(mode==='title')a.sort((x,y)=>x.title.localeCompare(y.title,'pl'));if(mode==='zone')a.sort((x,y)=>(x.zone||'').localeCompare(y.zone||'','pl'));return a}
function ensureSub(t){if(!Array.isArray(t.sub))t.sub=[]}
function taskBadge(t){
  const pr=t.priority==='high'?'ğŸ”¥':t.priority==='med'?'â€¢':'â€¦';
  const rep=(t.schedType||'daily');
  let spec='';
  if(rep==='weekly'&&(t.dows||[]).length) spec=` dni: ${(t.dows||[]).map(n=>['Nd','Pn','Wt','Åšr','Cz','Pt','So'][n]).join(' ')}`;
  if(rep==='monthly'&&t.dayOfMonth) spec=`, ${t.dayOfMonth}. dnia`;
  if(rep==='yearly'&&t.yearlyDate){ const d=new Date(t.yearlyDate+'T00:00:00'); spec=`, ${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`; }
  const time=t.time?`, ${t.time}`:'';
  const zone=t.zone?` â€¢ ${t.zone}`:'';
  const skipped=t.skippedReason?` â€¢ ğŸ™ˆ ${t.skippedReason}`:'';
  const pen = ` â€¢ â›” ${t.penalty??1}`;
  return `${pr} ${rep}${spec}${time}${zone} â€¢ â­ ${t.points}${pen}${skipped}`;
}
function toggleTask(p,t,checked){
  ensureSub(t);
  if(checked&&t.sub.length&&t.sub.some(s=>!s.done)){ alert('Najpierw odhacz pod-zadania.'); return; }
  if(!dueToday(t)){ t.done=checked; save(); return; }
  if(checked && !t.done){
    const late = latePenaltyForTask(p,t);
    const earn = Math.max(0,(t.points||1) - late);
    p.scoreToday += earn;
    t.done = true;
  } else if(!checked && t.done){
    p.scoreToday = Math.max(0, p.scoreToday - (t.points||1));
    t.done = false;
  }
}
function editTask(t){
  const nt=prompt('Nazwa:',t.title); if(nt) t.title=nt.trim();
  const np=prompt('Punkty (â­):',String(t.points||1)); if(np!==null){ const v=parseInt(np,10); if(!isNaN(v)&&v>=0) t.points=v; }
  const npen=prompt('Kara gdy nie zrobione (â­):', String(t.penalty??1)); if(npen!==null){ const v=parseInt(npen,10); if(!isNaN(v)&&v>=0) t.penalty=v; }
  const pr=prompt('Priorytet (high/med/low):',t.priority||'med'); if(pr) t.priority=['high','med','low'].includes(pr)?pr:'med';
  const zn=prompt('Strefa:',t.zone||''); t.zone=zn?zn.trim():'';
  const tm=prompt('Godzina (HH:MM):',t.time||''); if(tm!==null && /^\d{2}:\d{2}$/.test(tm)) t.time=tm;
}
function markSkip(t){
  showDialog(`<h3 style="margin-top:0">PominÄ…Ä‡ zadanie?</h3>
    <p>Podaj krÃ³tki powÃ³d (np. choroba, wyjazd). Kara bÄ™dzie mniejsza.</p>
    <input id="skipReason" type="text" placeholder="powÃ³d"/>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button class="btn" onclick="closeDialog()">Anuluj</button>
      <button class="btn" onclick="applySkip()">ğŸ™ˆ PomiÅ„</button>
    </div>`);
  window.applySkip=function(){
    const r=($('#skipReason').value||'').trim()||'usprawiedliwione';
    t.skippedReason=r; closeDialog(); save(); renderTasks();
  }
}
function addSubUI(container,t,p){
  const box=document.createElement('div'); box.className='subtasks';
  (t.sub||[]).forEach(s=>{
    const line=document.createElement('div'); line.className='row';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!s.done;
    cb.onchange=()=>{ s.done=cb.checked; save(); renderTasks(); };
    const lab=document.createElement('label'); lab.textContent=s.title;
    line.appendChild(cb); line.appendChild(lab); box.appendChild(line);
  });
  const add=document.createElement('div'); add.className='row subAdd';
  const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Dodaj pod-zadanie';
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='â•';
  btn.onclick=()=>{ const v=inp.value.trim(); if(!v) return; (t.sub=t.sub||[]).push({id:crypto.randomUUID(),title:v,done:false}); inp.value=''; save(); renderTasks(); };
  add.appendChild(inp); add.appendChild(btn);
  container.appendChild(box); container.appendChild(add);
}
function renderTasks(){
  const p=currentPerson(); if(!p) return;
  personTitleEl.textContent = `â€” ${p.name}`;
  tasksListEl.innerHTML = '';
  if(!p.tasks.length){ tasksListEl.innerHTML='<div class="muted">Brak zadaÅ„. Dodaj coÅ› po prawej.</div>'; return; }
  const arr=sortTasks(p.tasks);
  arr.forEach(t=>{
    const row=document.createElement('div'); row.className='task'+(t.done?' done':''); row.draggable=true;
    row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id, personId:p.id})); });
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!t.done; cb.style.transform='scale(1.2)';
    cb.onchange=()=>{ if(p.childMode){ cb.checked=!cb.checked; alert('Tryb dziecka â€” blokada zmiany.'); return; }
                      toggleTask(p,t,cb.checked); save(); renderAllCore(); };
    const label=document.createElement('label');
   label.innerHTML = `
  <strong class="editable" contenteditable="true" spellcheck="false">${t.title}</strong>
  <br><small>${taskBadge(t)} ${dueToday(t)?'':"<span style='color:var(--warn)'> (nie dziÅ›)</span>"}</small>
`;
const titleEl = label.querySelector('.editable');
titleEl.addEventListener('keydown', (e)=>{
  if(e.key==='Enter'){ e.preventDefault(); titleEl.blur(); }
});
titleEl.addEventListener('blur', ()=>{
  const v = titleEl.textContent.trim();
  if(v && v !== t.title){
    t.title = v;
    save(); // zachowuje i zsynchronizuje
    renderTasks(); // odÅ›wieÅ¼ znacznik (badge itp.)
  }else{
    titleEl.textContent = t.title; // przywrÃ³Ä‡ oryginaÅ‚, jeÅ›li puste
  }
});

    const actions=document.createElement('div'); actions.className='actions';
    const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='âœï¸'; editBtn.onclick=()=>{ if(p.childMode){alert('Tryb dziecka.'); return;} editTask(t); save(); renderTasks(); };
    const skipBtn=document.createElement('button'); skipBtn.className='btn'; skipBtn.textContent='ğŸ™ˆ'; skipBtn.title='PomiÅ„ z powodem'; skipBtn.onclick=()=>{ if(p.childMode){alert('Tryb dziecka.'); return;} markSkip(t); };
    const icsBtn=document.createElement('button'); icsBtn.className='btn'; icsBtn.textContent='ğŸ“†'; icsBtn.title='.ics tego zadania'; icsBtn.onclick=()=>icsForTask(p,t);
    const delBtn=document.createElement('button'); delBtn.className='btn'; delBtn.textContent='ğŸ—‘ï¸'; delBtn.onclick=()=>{ if(p.childMode){alert('Tryb dziecka.'); return;}
      if(confirm('UsunÄ…Ä‡ zadanie?')){ p.tasks=p.tasks.filter(x=>x.id!==t.id); save(); renderAllCore(); } };
    actions.appendChild(editBtn); actions.appendChild(skipBtn); actions.appendChild(icsBtn); actions.appendChild(delBtn);
    row.appendChild(cb); row.appendChild(label); row.appendChild(actions);
    addSubUI(row, t, p);
    tasksListEl.appendChild(row);
  });
}

/* ===== PLANNER VIS ===== */
function refreshPlannerVis(){
  const v=$('#planType').value;
  const show=(id,on)=>{ const el=$(id.startsWith('#')?id:'#'+id); if(el) el.style.display=on?'flex':'none'; };
  show('weeklyPicker', v==='weekly'); show('oncePicker', v==='once'); show('monthlyPicker', v==='monthly'); show('yearlyPicker', v==='yearly');
}
$('#planType').addEventListener('change', refreshPlannerVis); refreshPlannerVis();
function addTask(){
  const p=currentPerson(); if(!p) return;
  if(p.childMode){ alert('Tryb dziecka â€” dodawanie zadaÅ„ zablokowane.'); return; }
  const title=$('#taskTitle').value.trim(); if(!title){ alert('Podaj nazwÄ™ zadania.'); return; }
  const plan=$('#planType').value, time=$('#taskTime').value||'07:00', priority=$('#taskPriority').value||'med';
  const points=Math.max(0, parseInt($('#taskPoints').value||'1',10));
  const penalty=Math.max(0, parseInt($('#taskPenalty').value||'1',10));
  const zone=$('#taskZone').value||'';
  const remN=Math.max(0, parseInt($('#remNum').value||'10',10)); const remUnit=$('#remUnit').value||'minutes';
  const t={ id:crypto.randomUUID(), title, schedType:plan, time, points, penalty, priority, zone, done:false, sub:[], remN, remUnit };
  if(plan==='once'){ t.date=$('#taskDate').value||''; if(!t.date) return alert('Wybierz datÄ™.'); }
  if(plan==='weekly'){ t.dows = $$('#weeklyPicker input:checked').map(el=>parseInt(el.value,10)); if(!t.dows.length) return alert('Zaznacz dni tygodnia.'); }
  if(plan==='monthly'){ t.dayOfMonth = clamp(parseInt($('#dayOfMonth').value||'1',10)||1,1,31); }
  if(plan==='yearly'){ t.yearlyDate=$('#yearlyDate').value||''; if(!t.yearlyDate) return alert('Wybierz datÄ™ w roku.'); }
  p.tasks.push(t);
  $('#taskTitle').value=''; $('#taskPoints').value='1'; $('#taskPenalty').value='1'; $$('#weeklyPicker input:checked').forEach(el=>el.checked=false);
  save(); renderAllCore();
}

/* ===== DAY/WEEK END ===== */
function endDay(){
  const date = nowYMD();
  db.people.forEach(p=>{
    let penaltySum=0, allDone=true, zones={};
    p.tasks.forEach(t=>{
      if(dueToday(t)){
        if(!t.done){
          const base = Math.round(t.penalty ?? 1);
          const skipCut = t.skippedReason ? 0.5 : 1;
          penaltySum += Math.round(base*skipCut);
          allDone = false;
        } else {
          zones[t.zone||'Inne'] = (zones[t.zone||'Inne']||0) + (t.points||0);
        }
        if(t.schedType!=='weekly'){ t.done=false; }
        t.skippedReason = '';
      }
    });
    p.scoreToday = Math.max(0, p.scoreToday - penaltySum);
    p.scoreWeek += p.scoreToday;
    p.streak = allDone ? (p.streak||0)+1 : 0;
    db.history.push({date, personId:p.id, earned:p.scoreToday, missed:penaltySum, zonePoints:zones});
    p.scoreToday = 0;
  });
  save(); renderAll();
}
function endWeek(){ db.people.forEach(p=> p.scoreWeek=0 ); save(); renderAll(); }

/* ===== SZYBKIE KOREKTY ===== */
function manualDelta(sign){
  const p=currentPerson(); if(!p) return;
  const val = Math.max(1, parseInt($('#deltaPoints').value||'1',10));
  const scope = $('#deltaScope').value;
  const reason = prompt(sign>0?'PowÃ³d nagrody (+)':'PowÃ³d kary (âˆ’):','');
  if(scope==='today'){ p.scoreToday = Math.max(0, (p.scoreToday||0) + sign*val); }
  else { p.scoreWeek = Math.max(0, (p.scoreWeek||0) + sign*val); }
  db.history.push({date:nowYMD(), personId:p.id, manual:true, delta:sign*val, scope, reason:reason||''});
  save(); renderScores(); renderTabs();
}

/* ===== SUMMARY / EXPORT / TTS / ICS ===== */
function tasksForSummary(p){
  const lines=[]; lines.push(`Lista â€” ${new Date().toLocaleDateString('pl-PL')} (${p.name})`);
  if(!p.tasks.length){ lines.push('â€” brak'); return lines; }
  p.tasks.forEach(t=>{
    const box=t.done?'[x]':'[ ]';
    const rep=t.schedType||'daily';
    const zone=t.zone?` â€¢ ${t.zone}`:'';
    const onlyIf=dueToday(t)?'':' (nie dziÅ›)';
    const sub=(t.sub||[]).length?` â€” sub: ${(t.sub||[]).map(s=> (s.done?'[x] ':'[ ] ')+s.title).join(' | ')}`:'';
    const days=(t.schedType==='weekly'&&(t.dows||[]).length)?' '+(t.dows||[]).map(n=>['Nd','Pn','Wt','Åšr','Cz','Pt','So'][n]).join(' '):'';
    lines.push(`  ${box} ${t.title} (${rep}${days}${zone}, â­ ${t.points} â€¢ â›” ${t.penalty??1})${onlyIf}${sub}`);
  });
  return lines;
}
function summaryText(){const lines=[]; db.people.forEach(p=> lines.push(...['', ...tasksForSummary(p)])); return lines.join('\n').replace(/^\n/,'');}
function sendMail(){const body=encodeURIComponent(summaryText());const subj=encodeURIComponent('ObowiÄ…zki â€” podsumowanie'); location.href=`mailto:?subject=${subj}&body=${body}`;}
async function copyToClipboard(){ try{ await copy(summaryText()); alert('Skopiowano.'); }catch(e){ prompt('Kopiuj rÄ™cznie:', summaryText()); } }
function icsDate(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}T${pad(d.getHours())}${pad(d.getMinutes())}00`; }
function triggerDuration(n,u){ n=Math.max(0,parseInt(n||0,10)); if(u==='minutes')return`-PT${n}M`; if(u==='hours')return`-PT${n}H`; if(u==='days')return`-P${n}D`; if(u==='weeks')return`-P${n}W`; if(u==='months')return`-P${n*30}D`; if(u==='years')return`-P${n*365}D`; return '-PT10M'; }
function nextOccurrence(t){
  const now=new Date(); const {H,M}=hmToParts(t.time||'07:00'); const base=new Date(now.getFullYear(), now.getMonth(), now.getDate(), H, M, 0);
  const k=t.schedType||'daily';
  if(k==='once'){ if(!t.date) return base; const d=new Date(t.date+'T00:00:00'); d.setHours(H,M,0,0); return d; }
  if(k==='daily'){ return base>now?base:new Date(base.getTime()+86400000); }
  if(k==='weekly'){
    const dows=(t.dows||[]).length?(t.dows||[]):[now.getDay()];
    for(let i=0;i<7;i++){ const test=new Date(now.getFullYear(),now.getMonth(),now.getDate()+i,H,M,0); if(dows.includes(test.getDay()) && test>now) return test; }
    const d=new Date(base); d.setDate(d.getDate()+7); return d;
  }
  if(k==='monthly'){ const dom=Math.min(Math.max(1,t.dayOfMonth||1),28); let d=new Date(now.getFullYear(),now.getMonth(),dom,H,M,0); if(d<=now) d=new Date(now.getFullYear(),now.getMonth()+1,dom,H,M,0); return d; }
  if(k==='yearly'){ if(!t.yearlyDate) return base>now?base:new Date(now.getFullYear()+1, now.getMonth(), now.getDate(), H,M,0);
    const yd=new Date(t.yearlyDate+'T00:00:00'); let d=new Date(now.getFullYear(),yd.getMonth(),yd.getDate(),H,M,0); if(d<=now) d=new Date(now.getFullYear()+1,yd.getMonth(),yd.getDate(),H,M,0); return d; }
  return base;
}
async function icsForTask(person,task){
  const when=nextOccurrence(task);
  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
  const body=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//HomeChores//Task//PL','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`,`DTSTAMP:${icsDate(new Date())}Z`,`DTSTART:${icsDate(when)}`,`DTEND:${icsDate(new Date(when.getTime()+30*60*1000))}`,
    `SUMMARY:${esc('ObowiÄ…zki â€” '+person.name)}`,`DESCRIPTION:${esc('Zadanie: '+task.title+'\\nâ­ '+task.points)}`,
    'BEGIN:VALARM',`TRIGGER:${triggerDuration(task.remN||10,task.remUnit||'minutes')}`,'ACTION:DISPLAY','DESCRIPTION:Przypomnienie â€” zadanie','END:VALARM',
    'END:VEVENT','END:VCALENDAR'].join('\r\n');
  const file=new File([body],`zadanie-${person.name}-${when.toISOString().slice(0,10)}.ics`,{type:'text/calendar'});
  if(navigator.canShare&&navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file], title:`Zadanie â€” ${person.name}`}); }catch(e){} }
  else { const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(url); }
}
function makeICSForPerson(p,when){
  const esc=s=>s.replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');
  const lines=tasksForSummary(p).join('\n');
  const body=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//HomeChores//PRO3//PL','CALSCALE:GREGORIAN','METHOD:PUBLISH','BEGIN:VEVENT',
    `UID:${crypto.randomUUID()}@home-chores`, `DTSTAMP:${icsDate(new Date())}Z`, `DTSTART:${icsDate(when)}`, `DTEND:${icsDate(new Date(when.getTime()+30*60*1000))}`,
    `SUMMARY:${esc('ObowiÄ…zki â€” '+p.name)}`, `DESCRIPTION:${esc(lines)}`,
    'BEGIN:VALARM','TRIGGER:-PT10M','ACTION:DISPLAY','DESCRIPTION:Przypomnienie â€” obowiÄ…zki','END:VALARM',
    'END:VEVENT','END:VCALENDAR'].join('\r\n');
  return new File([body], `obowiazki-${p.name}-${when.toISOString().slice(0,10)}.ics`, {type:'text/calendar'});
}
async function shareICSForCurrentPerson(){
  const p=currentPerson(); if(!p) return;
  const [H,M]=(p.icsTime||'07:00').split(':').map(x=>parseInt(x,10));
  const now=new Date(); const when=new Date(now.getFullYear(), now.getMonth(), now.getDate(), H||7, M||0, 0);
  const file = makeICSForPerson(p, when);
  if(navigator.canShare&&navigator.canShare({files:[file]})){ try{ await navigator.share({files:[file], title:`ObowiÄ…zki â€” ${p.name}`}); }catch(e){} }
  else { const url=URL.createObjectURL(file); const a=document.createElement('a'); a.href=url; a.download=file.name; a.click(); URL.revokeObjectURL(a.href); }
}
function exportJSON(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='obowiazki-backup.json'; a.click(); URL.revokeObjectURL(a.href); }
function importJSONFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{ const j=JSON.parse(r.result); db=j; save(); renderAll(); alert('Zaimportowano.'); }catch(e){ alert('NieprawidÅ‚owy JSON.'); } }; r.readAsText(file); }

/* === TTS === */
function speakNow(){
  const p=currentPerson(); if(!p) return;
  const titles = p.tasks.filter(dueToday).map(t=>t.title);
  const text = titles.length ? `Plan dnia dla ${p.name}: ` + titles.join('. ') + '.' : `${p.name} â€” dziÅ› brak zadaÅ„.`;
  const u=new SpeechSynthesisUtterance(text); u.lang='pl-PL'; u.rate=1; u.pitch=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}

/* ===== WEEK VIEW ===== */
const weekNames=['Nd','Pn','Wt','Åšr','Cz','Pt','So'];
function renderWeek(){
  const host=$('#weekGrid'); host.innerHTML='';
  for(let d=1; d<=7; d++){
    const dow=d%7;
    const cell=document.createElement('div'); cell.className='day';
    cell.innerHTML=`<h4>${weekNames[dow]}</h4><div class="drop"></div>`;
    const drop=cell.querySelector('.drop');
    cell.addEventListener('dragover',e=>e.preventDefault());
    cell.addEventListener('drop',e=>{
      e.preventDefault();
      try{
        const data=JSON.parse(e.dataTransfer.getData('text/plain'));
        const p=db.people.find(x=>x.id===data.personId);
        const t=p?.tasks.find(x=>x.id===data.taskId);
        if(p&&t){
          if(p.childMode){ alert('Tryb dziecka.'); return; }
          t.schedType='weekly';
          t.dows = Array.from(new Set([...(t.dows||[]), dow]));
          save(); renderAllCore();
        }
      }catch(_){}
    });
    host.appendChild(cell);
  }
  db.people.forEach(p=>{
    p.tasks.forEach(t=>{
      const days = (t.schedType==='weekly'&&(t.dows||[]).length)? t.dows : (t.schedType==='daily'?[1,2,3,4,5,6,0]:[]);
      days.forEach(d=>{
        const target=host.children[[1,2,3,4,5,6,0].indexOf(d)]?.querySelector('.drop');
        if(!target) return;
        const pill=document.createElement('div'); pill.className='pill'; pill.textContent=`${p.name}: ${t.title}`;
        pill.draggable=true;
        pill.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({taskId:t.id, personId:p.id})); });
        target.appendChild(pill);
      });
    });
  });
}

/* ===== LEADERBOARD & STATS ===== */
function renderLeaderboard(){
  const rows=[`<tr style="border-bottom:1px solid var(--border)"><th style="text-align:left;padding:6px">Domownik</th><th style="text-align:left;padding:6px">ğŸ”¥ Streak</th><th style="text-align:left;padding:6px">TydzieÅ„ (â­)</th><th style="text-align:left;padding:6px">DziÅ›</th><th style="text-align:left;padding:6px">â° .ics</th></tr>`];
  [...db.people].sort((a,b)=> b.scoreWeek-a.scoreWeek || (b.streak||0)-(a.streak||0)).forEach(p=>{
    rows.push(`<tr><td style="padding:6px">${p.name}${p.childMode?' ğŸ‘¶':''}</td><td style="padding:6px">${p.streak||0}</td><td style="padding:6px">${p.scoreWeek}</td><td style="padding:6px">${p.scoreToday}</td><td style="padding:6px">${p.icsTime||'07:00'}</td></tr>`);
  });
  leaderboardEl.innerHTML=rows.join('');
}
function renderHeat(){
  const cvs=$('#heat'), ctx=cvs.getContext('2d'), W=cvs.width, H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const cols=7, rows=6, pad=12, cw=(W-pad*2)/cols, ch=(H-pad*2)/rows;
  const map={}; const last=new Date();
  for(let i=0;i<42;i++){ const d=new Date(last.getFullYear(), last.getMonth(), last.getDate()-i); map[d.toISOString().slice(0,10)]=0; }
  db.history.forEach(h=>{ if(h.date in map){ map[h.date]+=(h.earned||h.delta>0?h.delta:0); }});
  const keys=Object.keys(map).sort(); const vals=Object.values(map); const max=Math.max(1,...vals);
  let idx=0; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const k=keys[idx++]; const v=map[k]||0; const x=pad+c*cw, y=pad+r*ch, a=v/max; ctx.fillStyle=`rgba(10,132,255,${0.15+0.75*a})`; ctx.fillRect(x+3,y+3,cw-6,ch-6); } }
}
function renderTopZones(){
  const list=$('#topZones'); list.innerHTML='';
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-30);
  const agg={};
  db.history.forEach(h=>{
    if(new Date(h.date)>=cutoff){
      const zp=h.zonePoints||{};
      Object.entries(zp).forEach(([z,v])=> agg[z]=(agg[z]||0)+v );
    }
  });
  const top=Object.entries(agg).sort((a,b)=>b[1]-a[1]).slice(0,8);
  if(!top.length){ list.innerHTML='<li class="muted">Brak danych jeszcze.</li>'; return; }
  top.forEach(([z,v])=>{ const li=document.createElement('li'); li.textContent=`${z}: ${v}â­`; list.appendChild(li); });
}

/* ===== PEOPLE SETTINGS ===== */
function setGoal(){
  const p=currentPerson(); if(!p) return;
  const g=prompt('Cel dzienny (INFO: teraz liczony automatycznie = liczba zadaÅ„ na dziÅ›). Ustaw wartoÅ›Ä‡ â€informacyjnÄ…â€:', String(p.goal||goalForToday(p)));
  if(g!==null){ const v=Math.max(0,parseInt(g,10)||0); p.goal=v; save(); renderScores(); }
}
function setIcs(){const p=currentPerson();if(!p)return;const cur=p.icsTime||'07:00';const t=prompt('Godzina .ics (HH:MM, 24h):',cur);if(!t)return;if(!/^\d{2}:\d{2}$/.test(t))return alert('Format HH:MM');p.icsTime=t;save();renderLeaderboard()}
function pinDialog(){const p=currentPerson();if(!p)return;showDialog(`<h3 style="margin-top:0">PIN i Tryb dziecka â€” ${p.name}</h3><div class="row" style="flex-direction:column;align-items:stretch"><label class="muted">Ustaw/zmieÅ„ PIN (4â€“8 cyfr)</label><input id="pinSet" type="password" placeholder="${p.pin?'(obecny istnieje)':'brak'}"/><label class="muted" style="margin-top:8px">Tryb dziecka (blokada zmian)</label><div class="row"><button class="btn" onclick="setChildMode(true)">ğŸ‘¶ WÅ‚Ä…cz</button><button class="btn" onclick="setChildMode(false)">ğŸ”“ WyÅ‚Ä…cz</button></div></div><div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn" onclick="closeDialog()">Zamknij</button><button class="btn" onclick="savePin()">âœ… Zapisz PIN</button></div>`);window.savePin=function(){const v=$('#pinSet').value.trim();if(v&&!/^\d{4,8}$/.test(v))return alert('PIN 4â€“8 cyfr.');p.pin=v;save();alert('Zapisano PIN.');closeDialog()};window.setChildMode=function(on){if(p.pin){const entered=prompt('Podaj PIN:');if(entered!==p.pin)return alert('ZÅ‚y PIN.')}p.childMode=!!on;save();renderTabs();alert(on?'Tryb dziecka WÅÄ„CZONY.':'Tryb dziecka WYÅÄ„CZONY.')}}

/* ===== RENDER ROOT ===== */
function renderLeaderboardAndStats(){renderLeaderboard();renderHeat();renderTopZones()}
function renderAllCore(){renderTabs();renderZones();renderShop();renderTasks();renderScores();renderWeek();renderLeaderboardAndStats()}
function renderAll(){renderDate();renderAllCore()}

/* ===== BINDINGS ===== */
$('#addPersonBtn').onclick=addPerson;$('#renamePersonBtn').onclick=renamePerson;$('#removePersonBtn').onclick=removePerson;$('#setGoalBtn').onclick=setGoal;$('#setIcsBtn').onclick=setIcs;$('#pinBtn').onclick=pinDialog;
$('#addTaskBtn').onclick=addTask;$('#resetDailyBtn').onclick=()=>{db.people.forEach(p=>p.tasks.forEach(t=>{if((t.schedType||'daily')==='daily')t.done=false}));save();renderTasks()};$('#clearDoneBtn').onclick=()=>{const p=currentPerson();p.tasks=p.tasks.filter(t=>!((t.schedType==='once'||t.repeat==='once')&&t.done));save();renderTasks()};
$('#mailBtn').onclick=sendMail;$('#copyBtn').onclick=copyToClipboard;$('#icsBtn').onclick=shareICSForCurrentPerson;$('#ttsBtn').onclick=speakNow;$('#remindersBtn').onclick=()=>{const payload={date:nowYMD(),people:db.people.map(p=>({name:p.name,items:p.tasks.filter(dueToday).map(t=>({title:t.title,time:t.time||'07:00',zone:t.zone||'',points:t.points||1}))}))};const text='CHORES_PAYLOAD\n'+JSON.stringify(payload);copy(text).then(()=>{location.href='shortcuts://run-shortcut?name=Chores%20Import'}).catch(()=>alert('Skopiuj rÄ™cznie:\n\n'+text))};
$('#exportBtn').onclick=exportJSON;$('#importBtn').onclick=()=>$('#importFile').click();$('#importFile').onchange=e=>{const f=e.target.files[0];if(f)importJSONFromFile(f)};
$('#exportCSVPersonBtn').onclick=()=>{const p=currentPerson();if(!p)return;const header=['Osoba','TytuÅ‚','Harmonogram','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];const rows=[header.join(',')];p.tasks.forEach(t=>rows.push([p.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),t.points||0,t.penalty??1,t.priority||'med',t.zone||'',t.done?'1':'0'].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(',')));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`obowiazki-${p.name}.csv`;a.click();URL.revokeObjectURL(a.href)};
$('#exportCSVAllBtn').onclick=()=>{const header=['Osoba','TytuÅ‚','Harmonogram','DOWs','Punkty','Kara','Priorytet','Strefa','Zrobione'];const rows=[header.join(',')];db.people.forEach(p=>p.tasks.forEach(t=>rows.push([p.name,t.title,t.schedType||'daily',(t.dows||[]).join('|'),t.points||0,t.penalty??1,t.priority||'med',t.zone||'',t.done?'1':'0'].map(v=>'"'+String(v).replaceAll('"','""')+'"').join(','))));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='obowiazki-wszyscy.csv';a.click();URL.revokeObjectURL(a.href)};
$('#endDayBtn').onclick=endDay;$('#endWeekBtn').onclick=endWeek;$('#sortBy').onchange=()=>renderTasks();
$('#addZoneBtn').onclick=addZone;$('#delZoneBtn').onclick=delZone;$('#randomZoneBtn').onclick=randomZone;
$('#deltaMinus').onclick=()=>manualDelta(-1);
$('#deltaPlus').onclick=()=>manualDelta(1);
document.getElementById('changeFamilyBtn').onclick = async () => {
  const curr = localStorage.getItem('familyId') || '';
  const next = prompt('ID rodziny (wspÃ³lna nazwa grupy):', curr);
  if (!next) return;
  await subscribeToFamily(next.trim());
  pushToFirebase();
};
/* THEME TOGGLE */
(function themeInit(){
  const saved = localStorage.getItem('ui-theme') || 'dark';
  if(saved === 'light') document.documentElement.classList.add('light');
  const btn = document.getElementById('themeToggle');
  if(btn){
    btn.onclick = () => {
      document.documentElement.classList.toggle('light');
      localStorage.setItem('ui-theme',
        document.documentElement.classList.contains('light') ? 'light' : 'dark'
      );
    };
  }
})();
/* SWIPE GESTURES FOR TASKS (mobile) */
(function enableSwipe(){
  let startX=0, startY=0, active=null, moved=false;
  const THRESH = 48;      // ile pikseli, by uznaÄ‡ gest
  const MAX = 96;         // maks. przesuniÄ™cie

  function attach(row, onRight, onLeft){
    row.addEventListener('touchstart', (e)=>{
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      active = row; moved=false;
      row.style.transition = 'none';
    }, {passive:true});

    row.addEventListener('touchmove', (e)=>{
      if(!active) return;
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      if(Math.abs(dy) > Math.abs(dx)) return; // przewijanie pionowe
      moved=true;
      const off = Math.max(-MAX, Math.min(MAX, dx));
      active.style.transform = `translateX(${off}px)`;
      active.style.opacity = String(1 - Math.min(0.35, Math.abs(off)/300));
    }, {passive:true});

    row.addEventListener('touchend', ()=>{
      if(!active) return;
      const matrix = new WebKitCSSMatrix(getComputedStyle(active).transform);
      const off = matrix.m41 || 0;
      active.style.transition = '';
      active.style.transform = '';
      active.style.opacity = '';
      if(moved && off > THRESH){ onRight && onRight(); }     // w prawo = complete
      else if(moved && off < -THRESH){ onLeft && onLeft(); } // w lewo = delete
      active=null; moved=false;
    });
  }

  // Podpinamy po kaÅ¼dym renderze listy
  const _origRenderTasks = renderTasks;
  renderTasks = function(){
    _origRenderTasks();
    // znajdÅº wÄ™zÅ‚y i podepnij gesty
    const p = currentPerson(); if(!p) return;
    const rows = document.querySelectorAll('#tasksList .task');
    const tasks = p.tasks; // kolejnoÅ›Ä‡ zgodna z renderem po sort
    rows.forEach((row, idx)=>{
      const tNode = rows[idx];
      const titleEl = tNode.querySelector('strong');
      // â€completeâ€ = toggle checkbox
      const cb = tNode.querySelector('input[type="checkbox"]');
      attach(row,
        ()=>{ if(cb){ cb.checked = true; cb.dispatchEvent(new Event('change')); } },
        ()=>{ // delete
          if (p.childMode) { alert('Tryb dziecka.'); return; }
          if(confirm('UsunÄ…Ä‡ zadanie?')){
            const id = tasks[idx]?.id;
            if(id){ p.tasks = p.tasks.filter(z=>z.id!==id); save(); renderAllCore(); }
          }
        }
      );
    });
  };
})();

// --- PrzenieÅ› "Czytaj teraz" z eksportÃ³w do panelu z zadaniami ---
document.addEventListener('DOMContentLoaded', () => {
  const ttsBtn  = document.getElementById('ttsBtn');
  // to jest wiersz z: Sortuj / Reset / UsuÅ„ wykonane
  const taskToolbar = document.querySelector('section.card > div.row > div.row'); 
  if (ttsBtn && taskToolbar) {
    taskToolbar.appendChild(ttsBtn);
    // delikatny odstÄ™p, Å¼eby Å‚adnie siadÅ‚ obok przyciskÃ³w
    ttsBtn.style.marginLeft = '8px';
  }
});


/* ===== PWA SW ===== */
const skipSW = location.search.includes('nosw=1');
if('serviceWorker' in navigator && !skipSW){
  window.addEventListener('load', ()=> {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* ===== INIT ===== */
function hideSplash(){
  const el = document.getElementById('splash');
  if (el) el.remove();               // usuwamy caÅ‚kiem; bez migotania
}

document.addEventListener('DOMContentLoaded', () => {
  renderAll();
  tryFirebaseInit();
  // schowaj splash chwile po wyrenderowaniu UI
  setTimeout(hideSplash, 200);
});

// dodatkowy bezpiecznik gdyby coÅ› siÄ™ dÅ‚uuÅ¼ej Å‚adowaÅ‚o
window.addEventListener('load', hideSplash);

</script>
<!-- ===== UI HOTFIX (tylko wyglÄ…d; nie zmienia logiki Firebase/FamilyID) ===== -->
<style id="ui-hotfix">
  /* 1) Wiersz zadania na telefonie: zawijanie, akcje pod spodem, kosz nie wyjeÅ¼dÅ¼a */
  @media (max-width: 480px){
    #tasksList .task{
      display:flex; flex-wrap:wrap; align-items:flex-start; gap:.5rem;
    }
    #tasksList .task label{ flex:1 1 100%; min-width:100%; }
    #tasksList .task .actions{
      flex:1 1 100%; min-width:100%;
      display:flex; justify-content:flex-end; gap:.5rem;
    }
    #tasksList .task .actions .btn{
      width:42px; height:42px; padding:0; line-height:42px;
      transform:none !important;
    }
  }

  /* 2) â€Strefa domuâ€ â€“ na telefonie peÅ‚na szerokoÅ›Ä‡ i osobna linia */
  @media (max-width: 640px){
    .zone-field, .strefa-input{
      display:block; width:100% !important; min-width:100%;
      margin-top:.25rem;
    }
    .zone-field input, .strefa-input input{ width:100%; }
  }

  /* 3) Widok tygodnia â€“ poziomy scroll (jak tablica wynikÃ³w) */
  #weekGrid.week-scroll{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:minmax(160px, 1fr);
    gap:.5rem;
    overflow-x:auto;
    padding-bottom:.5rem;
    overscroll-behavior-x:contain;
    -webkit-overflow-scrolling:touch;
  }
  #weekGrid.week-scroll::-webkit-scrollbar{ height:6px }
  #weekGrid.week-scroll::-webkit-scrollbar-thumb{ background:#444; border-radius:3px }
</style>

<script>
/* TydzieÅ„ przewijany poziomo â€” tylko klasÄ™ dokÅ‚adamy */
document.addEventListener('DOMContentLoaded', () => {
  const grid = document.getElementById('weekGrid');
  if (grid) grid.classList.add('week-scroll');
});
</script>

<script>
/* Sklepik: dodaj â€UsuÅ„ nagrodÄ™â€ â€” uÅ¼ywa wyÅ‚Ä…cznie Twojego save()/db, nie dotyka Firebase bezpoÅ›rednio */
(function attachRewardDelete(){
  // nadpisujemy istniejÄ…cÄ… renderShop, ale wyÅ‚Ä…cznie UI; zapis leci przez save()
  const originalSave = (typeof save === 'function') ? save : function(){};
  window.renderShop = function(){
    const host = document.getElementById('shopList');
    if(!host) return;
    host.innerHTML = '';
    const p = (typeof currentPerson === 'function') ? currentPerson() : null;
    if(!p) return;

    (db?.rewards || []).forEach(r=>{
      const row = document.createElement('div');
      row.className = 'shopItem';
      row.innerHTML = `<div>${r.name} â€” <b>${r.cost}â­</b></div>`;

      const box = document.createElement('div');
      box.style.display = 'flex';
      box.style.gap = '6px';

      // Zrealizuj (jak wczeÅ›niej)
      const useBtn = document.createElement('button');
      useBtn.className = 'btn';
      useBtn.textContent = 'Zrealizuj';
      useBtn.onclick = ()=>{
        if(p.childMode){ alert('Tryb dziecka â€” realizacja nagrÃ³d zablokowana.'); return; }
        if(p.scoreWeek < r.cost){ alert('Za maÅ‚o â­'); return; }
        if(typeof showDialog === 'function'){
          showDialog(
            `<h3 style="margin-top:0">PotwierdÅº nagrodÄ™</h3>
             <p>${p.name} wymienia <b>${r.cost}â­</b> na â€${r.name}â€. KontynuowaÄ‡?</p>
             <div class="row" style="justify-content:flex-end">
               <button class="btn" onclick="closeDialog()">Anuluj</button>
               <button class="btn" onclick="redeem('${r.id}')">âœ… OK</button>
             </div>`
          );
        }
      };

      // UsuÅ„
      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.title = 'UsuÅ„ nagrodÄ™';
      delBtn.textContent = 'ğŸ—‘ï¸';
      delBtn.onclick = ()=>{
        if(!confirm(`UsunÄ…Ä‡ nagrodÄ™ â€${r.name}â€?`)) return;
        db.rewards = (db.rewards || []).filter(x => x.id !== r.id);
        originalSave();
        window.renderShop(); // odÅ›wieÅ¼ listÄ™
      };

      box.appendChild(useBtn);
      box.appendChild(delBtn);
      row.appendChild(box);
      host.appendChild(row);
    });
  };
})();
</script>

<script>
/* PrzenieÅ› sekcjÄ™ â€UdostÄ™pnij / Eksportâ€ na sam dÃ³Å‚ strony (bez zmian HTML) */
document.addEventListener('DOMContentLoaded', () => {
  try{
    const wrap = document.querySelector('.wrap');
    if(!wrap) return;

    // ZnajdÅº kartÄ™, ktÃ³ra ma nagÅ‚Ã³wek zaczynajÄ…cy siÄ™ od â€UdostÄ™pnijâ€
    const cards = Array.from(document.querySelectorAll('.card'));
    const exportsCard = cards.find(c => (c.querySelector('h3')?.textContent || '').trim().startsWith('UdostÄ™pnij'));
    if(exportsCard){
      wrap.appendChild(exportsCard);           // na koniec
      exportsCard.classList.add('exports--moved');
    }
  }catch(_){}
});
</script>
<!-- ===== /UI HOTFIX ===== -->
<script>
/* PrzenieÅ› kartÄ™ "UdostÄ™pnij / Eksport" na sam dÃ³Å‚ po kaÅ¼dym renderze */
(function(){
  function moveExports(){
    const wrap = document.querySelector('.wrap') || document.body;
    const h3s = Array.from(document.querySelectorAll('h3'));
    const expH = h3s.find(h => /UdostÄ™pnij\s*\/\s*Eksport/i.test(h.textContent));
    if(!expH) return;
    const card = expH.closest('.card') || expH.parentElement;
    if(card && wrap && card.parentElement !== wrap){
      wrap.appendChild(card);
      card.classList.add('exports--moved');
    }
  }

  // raz po zaÅ‚adowaniu
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', moveExports);
  } else {
    moveExports();
  }

  // i po kaÅ¼dym re-renderze aplikacji
  const orig = window.renderAllCore;
  if (typeof orig === 'function'){
    window.renderAllCore = function(){
      const r = orig.apply(this, arguments);
      moveExports();
      return r;
    };
  }
})();
</script>

</body>
</html>
